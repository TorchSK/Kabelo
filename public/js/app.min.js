var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

!function (a) {
  "use strict";
  a.fn.tableToJSON = function (b) {
    var c = { ignoreColumns: [], onlyColumns: null, ignoreHiddenRows: !0, ignoreEmptyRows: !1, headings: null, allowHTML: !1, includeRowId: !1, textDataOverride: "data-override", extractor: null, textExtractor: null };b = a.extend(c, b);var d = function d(a) {
      return void 0 !== a && null !== a;
    },
        e = function e(a) {
      return void 0 !== a && a.length > 0;
    },
        f = function f(c) {
      return d(b.onlyColumns) ? -1 === a.inArray(c, b.onlyColumns) : -1 !== a.inArray(c, b.ignoreColumns);
    },
        g = function g(b, c) {
      var f = {},
          g = 0;return a.each(c, function (a, c) {
        g < b.length && d(c) && (e(b[g]) && (f[b[g]] = c), g++);
      }), f;
    },
        h = function h(c, d, e) {
      var f,
          g = a(d),
          h = b.extractor || b.textExtractor,
          i = g.attr(b.textDataOverride);return null === h || e ? a.trim(i || (b.allowHTML ? g.html() : d.textContent || g.text()) || "") : a.isFunction(h) ? (f = i || h(c, g), "string" == typeof f ? a.trim(f) : f) : "object" == (typeof h === "undefined" ? "undefined" : _typeof(h)) && a.isFunction(h[c]) ? (f = i || h[c](c, g), "string" == typeof f ? a.trim(f) : f) : a.trim(i || (b.allowHTML ? g.html() : d.textContent || g.text()) || "");
    },
        i = function i(c, d) {
      var e = [],
          f = b.includeRowId,
          g = "boolean" == typeof f ? f : "string" == typeof f,
          i = "string" == typeof f == !0 ? f : "rowId";return g && void 0 === a(c).attr("id") && e.push(i), a(c).children("td,th").each(function (a, b) {
        e.push(h(a, b, d));
      }), e;
    },
        j = function j(a) {
      var c = a.find("tr:first").first();return d(b.headings) ? b.headings : i(c, !0);
    };return function (c, e) {
      var i,
          j,
          k,
          l,
          m,
          n,
          o,
          p = [],
          q = 0,
          r = [];return c.children("tbody,*").children("tr").each(function (c, e) {
        if (c > 0 || d(b.headings)) {
          var f = b.includeRowId,
              g = "boolean" == typeof f ? f : "string" == typeof f;n = a(e);var r = n.find("td").length === n.find("td:empty").length;!n.is(":visible") && b.ignoreHiddenRows || r && b.ignoreEmptyRows || n.data("ignore") && "false" !== n.data("ignore") || (q = 0, p[c] || (p[c] = []), g && (q += 1, void 0 !== n.attr("id") ? p[c].push(n.attr("id")) : p[c].push("")), n.children().each(function () {
            for (o = a(this); p[c][q];) {
              q++;
            }if (o.filter("[rowspan]").length) for (k = parseInt(o.attr("rowspan"), 10) - 1, m = h(q, o), i = 1; i <= k; i++) {
              p[c + i] || (p[c + i] = []), p[c + i][q] = m;
            }if (o.filter("[colspan]").length) for (k = parseInt(o.attr("colspan"), 10) - 1, m = h(q, o), i = 1; i <= k; i++) {
              if (o.filter("[rowspan]").length) for (l = parseInt(o.attr("rowspan"), 10), j = 0; j < l; j++) {
                p[c + j][q + i] = m;
              } else p[c][q + i] = m;
            }m = p[c][q] || h(q, o), d(m) && (p[c][q] = m), q++;
          }));
        }
      }), a.each(p, function (c, h) {
        if (d(h)) {
          var i = d(b.onlyColumns) || b.ignoreColumns.length ? a.grep(h, function (a, b) {
            return !f(b);
          }) : h,
              j = d(b.headings) ? e : a.grep(e, function (a, b) {
            return !f(b);
          });m = g(j, i), r[r.length] = m;
        }
      }), r;
    }(this, j(this));
  };
}(jQuery);

// (c) 2010 jdbartlett, MIT license
(function (a) {
  a.fn.loupe = function (b) {
    var c = a.extend({ loupe: "loupe", width: 200, height: 150 }, b || {});return this.length ? this.each(function () {
      var j = a(this),
          g,
          k,
          f = j.is("img") ? j : j.find("img:first"),
          e,
          h = function h() {
        k.hide();
      },
          i;if (j.data("loupe") != null) {
        return j.data("loupe", b);
      }e = function e(p) {
        var o = f.offset(),
            q = f.outerWidth(),
            m = f.outerHeight(),
            l = c.width / 2,
            n = c.height / 2;if (!j.data("loupe") || p.pageX > q + o.left + 10 || p.pageX < o.left - 10 || p.pageY > m + o.top + 10 || p.pageY < o.top - 10) {
          return h();
        }i = i ? clearTimeout(i) : 0;k.show().css({ left: p.pageX - l, top: p.pageY - n });g.css({ left: -((p.pageX - o.left) / q * g.width() - l) | 0, top: -((p.pageY - o.top) / m * g.height() - n) | 0 });
      };k = a("<div />").addClass(c.loupe).css({ width: c.width, height: c.height, position: "absolute", overflow: "hidden" }).append(g = a("<img />").attr("src", j.attr(j.is("img") ? "src" : "href")).css("position", "absolute")).mousemove(e).hide().appendTo("body");j.data("loupe", true).mouseenter(e).mouseout(function () {
        i = setTimeout(h, 10);
      });
    }) : this;
  };
})(jQuery);

!function (a, b) {
  a.fn.prettyEmbed = function (c) {
    function g(d) {
      var e = d.find("img").outerWidth(!0),
          f = d.find("img").outerHeight(!0),
          g = "",
          h = "";d.attr("data-pe-videoid") !== b ? h = d.attr("data-pe-videoid") : c.videoID !== b ? h = c.videoID : (h = b, console.error("PrettyEmbed.js Error:  Misformed or missing video ID.")), ("false" === d.attr("data-pe-show-info") || c.showInfo === !1) && (g += "&showinfo=0"), ("false" === d.attr("data-pe-show-controls") || c.showControls === !1) && (g += "&controls=0"), ("true" === d.attr("data-pe-loop") || c.loop === !0) && (g += "&loop=1"), ("true" === d.attr("data-pe-closed-captions") || c.closedCaptions === !0) && (g += "&cc_load_policy=1"), (d.attr("data-pe-localization") !== b || c.localization !== b) && (d.attr("data-pe-localization") !== b ? g += "&hl=" + d.attr("data-pe-localization") : c.localization !== b && (g += "&hl=" + c.localization)), ("light" == d.attr("data-pe-color-scheme") || "light" == c.colorScheme) && (g += "&theme=light"), g += "false" === d.attr("data-pe-show-related") || c.showRelated === !1 ? "&rel=0" : "&rel=1", fullScreenFlag = "false" === d.attr("data-pe-allow-fullscreen") || c.allowFullScreen === !1 ? "" : "allowfullscreen ", d.html('<iframe width="' + e + '" height="' + f + '" ' + fullScreenFlag + 'style="border:none;" src="//www.youtube.com/embed/' + h + "?autoplay=1" + g + '"></iframe>').addClass("play"), c.useFitVids && a.isFunction(a.fn.fitVids) && d.parent().fitVids();
    }function h(a) {
      var b = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/,
          c = a.match(b);return c && 11 == c[7].length ? c[7] : (console.error("PrettyEmbed.js Error:  Bad URL."), void 0);
    }c = a.extend({}, a.fn.prettyEmbed.options, c);var d = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ? !0 : !1;0 === a("#pretty-embed-style").length && a("<style />", { id: "pretty-embed-style", html: '.pretty-embed{position:relative;cursor:pointer;display:block}.pretty-embed img{width:100%;height:auto}.pretty-embed iframe{border:0 solid transparent}.pretty-embed:after{display:block;content:"";position:absolute;top:50%;margin-top:-19px;left:50%;margin-left:-27px;width:54px;height:38px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGwAAABMCAYAAACIylL7AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjExR/NCNwAABmxJREFUeF7t3W9MVlUcB3BNs3Kt1h/XC9eL6kWCAg6E8h/YMLKFm4v+GNZCfYHQnDoNVzjLYbZG8SLCVqSrHGgWtnDWbK1CK/sHi5oF8n+9IMcqiIqA6PT9Xs6Nx+tPAkSec+9zfu7zgnvuOffhfr3Avc997pk0XjUrahZNgytgJsyCRFgC6XAfZEEObIZ8KIBCeB5eglehHN6Cd+Bd+AA+huPwBXwF30At/KDVQ9P/OAXu+t8Cx/gaOOYnUAXc1ntQCRWwH16Dl6EYnoWdsA22QC6shvthOdwGSRAN18OVcAlM1rtpYgsbZiCLYRO8CIeBO7AZfoG/4B9QloP7gvvkV2iBGuB/Qv4HyINUmK537/gVBo2BV6ATpBdmjd0fwJ8qt4Le42MsDHA17IW/QdqYNX54NB6CmXr3j67QMQHaQBrcunA6IFXHMLJChxT4TQ9gTbxeyNBxDF9Y8Wawv6vCj3+sLNCxyIUVLoLPdAcr/BrgUh3P2YVGnitJHa3w2aTjObPQMBl4Iil1ssLnR7hYxzRUWMirElIHK/xW6JiGCguLPCtZ5jigYxosLKDGkBUss3TBNB2XE9hNIY2WmZJ1XE5gD3saLfPk67icwEo8jZZ53tZxOYF95Gm0zHNKx+UExjf4pJUsc/wOUxnWVP2FtJJllhkM7BrPQstcsQyM9x9IjZZ5bmdgvElGajTK7DmzVXxCvNgWQR5kYPd6FhppXuI8dfr0abVjxw4VFxcnrhMBNjIw3nYmNRqFgQ0MDChWU1OT2rxls5oTM0dcN8B2MjDeHyg1GiU0MFZfX5+qrq5WuY/kqujZ0WKfANrNwHhzpNRoFG9gbnV1damqqiq1Zu0aFRUdJfYNkP0MjDc1So1GOVdgLB5t7e3t6uj7R1Xmqkyxf0AcYWAHPAuNNFxgbvFoa2trU5WHK1XGPRniOD53nIHxdmup0SgjCYzlHm0tLS3q4JsHVfrydHE8n6phYB96FhpppIG55R5tDG7fvn0qLS1NHNdn6hmYL25rG21gLPdoa21tdU4FSktLVcqSFHF8n2hjYL64U2osgbnlHm0MrqGhQRUXF6uFixaK2zFcOwPj56SkRqOcT2Cs0KON6urqVGFhoUq6JUncnqE6IiYwtzo7O/872ujkyZOqYGeBX65TRl5gLO/RRrW1tSp/W76Km2v0dcrIDMyt0N9tLl7u4nXKmNgY8XWEWWQHxpKONjpx4oTKyc0RX0sY2cDcCj3ampubB8/d7jDu3M0GFlq9vb2qoqLC5KsjNjC3+CNw5QMrxW0bxAZWU1OjslZnids0UOQGxvOv7HXZKirKV++hRV5gjY2NasPGDX59lzpyAuNfgHlb85y7r6TxfcIJLNAXf3mOtf2J7aaeCI+Wc/E3kG+vdHR0qF1P7zL9UtNotTKwQL2ByYu7RUVFQb3p1HkDMxC3CHR3d6uS3SUqMSlR7B8Qzi0CfCag1GiUcwXW09Oj9uzdo+YvmC/2C5hjDMyXt7nxMlJZWZlKTkkW1w8o5zY3PhFUajSKG1h/f79zvS91aaq4XsCVM7DHPQuNlDAvwbnfcNmdy8T2CFHCwHzxYQjLUcDAfPFxI8vhfNzIFx/osxyrGBj/SY2WeZyPzPJBzPbR5f4Qw8CmgH3sgz9c6z5YxT7JzXyDD1bRgfniAnCEq3fCYuELzisirWSZ45COywnsIU+jZZ7HdFxOYDd4Gi3zLNJxOYERp2uSVrTCjxM/nPlkbSzwxVX7CFWuYxoqLIz3rGSZI13HNFRYSJytTupghU8rDJ5/eQsNd4esaJlhvY7n7EIjp/PgXJBSR2vicb7OoefVS4UV+Az7n3UHK3z+hEQdy/CFFTkfIychlQayLrweuEvHMbJCBz5a9ns9gDVx2mGxjmF0hY6XwZPAuT+kwa3xMwCcbfa6wb1/HoVBroL1cAz6QNqgNTa8isGZfOeC3uPjWBj0cuDk29nwDLwBnHybE5N1g51CeAj3Bd/H+gn4F9+nwBnYOTM8D4CFMPxfgReysHHOoTkdZsCNEAvzYSlw6nd3evt1sAG2wnZ4Ctwp7jkD+x54HfgsR36DnGr+CHDqeU47wiP9c/gS+Pm20GnuvVPau9z274B9qoEXCrgTOZ47rT0/a8D5lLltTmtfCi/Ac8DXydf7KHCHr4VMWAFpsAD4PfN75z7gvpiid8841KRJ/wIcsey9MCgPGwAAAABJRU5ErkJggg==);-webkit-background-size:cover;background-size:cover}.pretty-embed.play:after{display:none}.pretty-embed:hover:after{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGwAAABMCAYAAACIylL7AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjExR/NCNwAABwhJREFUeF7t3GlsVFUYBuCDIi4xGreA1O6dmXbaYQ2oCAriGjUuRDSiETVRISGCu2BcAH8gagKKpnWJ5UcBFVQIGhMDFGwVGcqU0m2WtkPpIqNSbEHaQj/fM5yh9HLAAlP6TTlv8iSdc+899/a8PenMnxHRSp3LIQ2ASyAO0mEUjIe7YTJMhWnwAsyBebAQFkM2fAl58A18Dz/Az7ABNsFm2AIeKIZypRIC/8MLkfO3g5zDDXLOXyAf5L1+hNWwEpZBLuTAh/AezIfX4UWYDk/AQ3APTIDR4IR4uBTOh35qmc5sdmU5BsC4XS7HLPgE1sAWqIK/4QB0ABlhci3kmuyBaiiCHyAHXsZaToSL1PJGL5jUBZ9BE5ARVfsgD64DteKnmNos++W1WY4v4CCQ0aM6YBXEqeU/uaCskRAETGacQSGYqGroXnZm2m+Cf4CMXtEKk1QdJw5OdECTutDoPQdgjKpFn2Cm/RwoBDJY8MEFqp5jE3TaJ1suMHrfLFVP19Q47f3ADWSwUgvnqZo6g8FRR51k8HKfqqkz1U77B0AGS8tVTYdTnWGT/EAGS3thgKpLiKoMWyqQwdqNqq5wYY9bDhr8zFF1CRHIsC0BMlj7VtWFwtJt64EM1ryqLiH86bYAkMFaC/SXZfVXL3QnGbxcJXyOtCuAjJgwRBbmtAwafN0qvI608UDc+ZwO8g8fqj12FnlUFvagZZAl/8hh1PZHI9W99Sb5XJnac84CM0WlPW0aEHe+EcOIDh0imWa/n2qen0VeZ7r23D5svixsjmWQpaMLk2lva6PQVjdVTXuWKtPt2mv6oI9FhT3tPSDuvJbCItm3dy/V5+dT4ImpVOGwaa/tQ5aJCltaDhB33uH6wmTkbvuroYHqfvqJ/A8/pL2+j1grym2py4G4q8Q7xOMVFkkLdtsfwSDtWv09+e6/VztPjNskC1tjGWSpO4XJRHZbY3U11X61grx33qGdL0YVibK01HVA3FV0s7BIIrtNFrdzaS5VTpygnTfGVMrCCi2DLFUMO7nCZI7stpoaagwEKJidTRVjb9DOHyOCojQt1Q3E3akUFsmR3SaL8/moZtEiKr92tPY+zDXIwjyWQZbKT6MwmS67DRoqKqh6wQIqGzFcez+mQmJHaqoHiLuyoadXWCQtTU2du00WV1pKVW+/TaUul/a+zMjCUlBYCl7wVjZ0SFQKk7HuNqne46HAq69SqTNDe38mQqIEhQFxF83CIunyvy1SnNtN/pkzaUe6Q/scvQyFpaCwFLxgrrQHCpPR7TaprrCQvE8/rX2WXhQS21EYEHelQ3qmsEi67LaqKgrm5lLZhAnaZ+lFsVPYjh4uTKa9tZV2ff01ld1+u/YZGAiJYhQGxF1PF9ZcUEC+SZO092YEhSWjsGS8YG6Hq2cK2+feSoEpU7T3ZCgkPCgMiLuSKBe2v6SEqp58ijz4y9XdjylZWDIKS8YL3krwwTYahf3r9VLN9OnkwQdR3X2YC4ltSckeIO62Z51eYQfw7i8463kUlaadP0aEC3NbBlk61cLa6utp5+zZ5LHZtfPGmAZRlJRcCMRd8UkW1rZ7N9XOnUvbHOna+WJUjSxsnWWQpe4W1r5nD9UteJc8zkztPDGuUmxNTF4DxJ0n88SFHWxupvpFi8njGqq9vo8okoUtswyydLzCDu3fT43ZOVQ8fKT2uj5mo3AnJuUAcbfNUlhHayvtzl1KxaOv1Z7fR60V7oSkhUDcbcvMChfW0d5OoRVf0fYxY7Xn9XF5YktC0mwg7orwJuLPb7+jkvE3a4+fJZbIwqZZBg2+5onf45MeBDJiwkxZ2HjLoMHXFLE5PikDyIgJt8rCLoeOowYNvlzit2sSz4UWIIO9K8NfrIIf/JYDBj9yU/UPF/brNYnrgAzWKsNlyfwal/ghkMHaKlWXEIVxiY8BGay9puoKF5ZsOWjwM1bVFS5MFMQleoEMlpqg6zdrFwxOXAhksJSnaurML4MTRgAZLN2tauoMBqXNR51k8FADhz9/WbNpcMIDm65OIIORwQkzVD3HBif0g/wuFxi9qRw6v69el41XJ6TCX0BGr9oPo1QtJw5OvA7+VhcaZ96/cJeqo3vJH5TghDIg44xqgHGqhpMLLrwwf1D8W7AXMJnRgw5BHtZ8oFr+U8+GQfGXwQzYCG1ARtQ0wRcwDNSKRzGY9GIYB89sGBi/AFbAFqiFZjgIZITJtWiBRiiHAlgJi0FugBvgxO8CezLrB8afAxfBVZACQ+B6uAXugckwFZ6F5+AVeAPegYWwGD6Bz2EpLIeVsBrWws+wHjbCb/A7eKAYypXAcUSOl4C8ZitshgKQ88m5f4Q1sArkvXPhU/gI3gf5nPJ5X4IZ8BQ8AvfBbTAG5O8sf3e5BnItzlXLE4UI8R86m8y4ltOs9gAAAABJRU5ErkJggg==)}' }).appendTo("head"), c.useFitVids && (a.isFunction(a.fn.fitVids) || console.error("PrettyEmbed.js Error:  options.useFitVids is set to true; FitVids not found!"));var f;f = 0 === a(this).length ? a(".pretty-embed") : a(this), f.each(function () {
      a(this).addClass("pretty-embed");var e,
          j,
          k,
          l,
          m,
          n,
          o,
          p,
          q,
          f = "",
          g = "",
          i = "";if (f = a(this).attr("data-pe-videoid") !== b ? a(this).attr("data-pe-videoid") : a(this).attr("href") !== b ? h(a(this).attr("href")) : c.videoID, g = a(this).attr("data-pe-preview-size") !== b ? a(this).attr("data-pe-preview-size") : c.previewSize !== b ? c.previewSize : b, i = a(this).attr("data-pe-custom-preview-image") !== b ? a(this).attr("data-pe-custom-preview-image") : c.customPreviewImage !== b ? c.customPreviewImage : b, j = a(this).attr("data-pe-show-info") !== b ? a(this).attr("data-pe-show-info") : c.showInfo !== b ? c.showInfo : b, k = a(this).attr("data-pe-show-controls") !== b ? a(this).attr("data-pe-show-controls") : c.showControls !== b ? c.showControls : b, l = a(this).attr("data-pe-loop") !== b ? a(this).attr("data-pe-loop") : c.loop !== b ? c.loop : b, m = a(this).attr("data-pe-closed-captions") !== b ? a(this).attr("data-pe-closed-captions") : c.closedCaptions !== b ? c.closedCaptions : b, n = a(this).attr("data-pe-localization") !== b ? a(this).attr("data-pe-localization") : c.localization !== b ? c.localization : b, o = a(this).attr("data-pe-color-scheme") !== b ? a(this).attr("data-pe-color-scheme") : c.colorScheme !== b ? c.colorScheme : b, p = a(this).attr("data-pe-show-related") !== b ? a(this).attr("data-pe-show-related") : c.showRelated !== b ? c.showRelated : b, q = a(this).attr("data-pe-allow-fullscreen") !== b ? a(this).attr("data-pe-allow-fullscreen") : c.allowFullScreen !== b ? c.allowFullScreen : b, a(this).is("a") && (e = a("<div />").addClass("pretty-embed"), e.attr("data-pe-videoid", f).attr("data-pe-preview-size", g).attr("data-pe-custom-preview-image", i).attr("data-pe-show-info", j).attr("data-pe-show-controls", k).attr("data-pe-loop", l).attr("data-pe-closed-captions", m).attr("data-pe-localization", n).attr("data-pe-color-scheme", o).attr("data-pe-show-related", p).attr("data-pe-allow-fullscreen", q), a(this).after(e)), i !== b && "" !== i) a(this).html('<img src="' + i + '" width="100%" alt="YouTube Video Preview" />');else {
        var s = "";switch (g) {case "thumb-default":
            s = "default";break;case "thumb-1":
            s = "1";break;case "thumb-2":
            s = "2";break;case "thumb-3":
            s = "3";break;case "default":
            s = "mqdefault";break;case "medium":
            s = "0";break;case "high":
            s = "hqdefault";break;default:
            s = "mqdefault";}a(this).html('<img src="//img.youtube.com/vi/' + f + "/" + s + '.jpg" width="100%" alt="YouTube Video Preview" />');
      }a(this).is("a") && (e.html(a(this).html()), a(this).remove()), d && a(window).on("load", function () {
        a(".pretty-embed").trigger("click");
      });
    }), a("body").on("click", ".pretty-embed", function (b) {
      b.preventDefault(), g(a(this));
    }), a.fn.prettyEmbed.options = { videoID: "", previewSize: "", customPreviewImage: "", showInfo: !0, showControls: !0, loop: !1, closedCaptions: !1, colorScheme: "dark", showRelated: !1, useFitVids: !1 };
  };
}(jQuery);

/*! Lity - v2.3.1 - 2018-04-20
* http://sorgalla.com/lity/
* Copyright (c) 2015-2018 Jan Sorgalla; Licensed MIT */

!function (a, b) {
  "function" == typeof define && define.amd ? define(["jquery"], function (c) {
    return b(a, c);
  }) : "object" == (typeof module === "undefined" ? "undefined" : _typeof(module)) && "object" == _typeof(module.exports) ? module.exports = b(a, require("jquery")) : a.lity = b(a, a.jQuery || a.Zepto);
}("undefined" != typeof window ? window : this, function (a, b) {
  "use strict";
  function c(a) {
    var b = B();return N && a.length ? (a.one(N, b.resolve), setTimeout(b.resolve, 500)) : b.resolve(), b.promise();
  }function d(a, c, d) {
    if (1 === arguments.length) return b.extend({}, a);if ("string" == typeof c) {
      if (void 0 === d) return void 0 === a[c] ? null : a[c];a[c] = d;
    } else b.extend(a, c);return this;
  }function e(a) {
    for (var b, c = decodeURI(a.split("#")[0]).split("&"), d = {}, e = 0, f = c.length; e < f; e++) {
      c[e] && (b = c[e].split("="), d[b[0]] = b[1]);
    }return d;
  }function f(a, c) {
    return a + (a.indexOf("?") > -1 ? "&" : "?") + b.param(c);
  }function g(a, b) {
    var c = a.indexOf("#");return -1 === c ? b : (c > 0 && (a = a.substr(c)), b + a);
  }function h(a) {
    return b('<span class="lity-error"/>').append(a);
  }function i(a, c) {
    var d = c.opener() && c.opener().data("lity-desc") || "Image with no description",
        e = b('<img src="' + a + '" alt="' + d + '"/>'),
        f = B(),
        g = function g() {
      f.reject(h("Failed loading image"));
    };return e.on("load", function () {
      if (0 === this.naturalWidth) return g();f.resolve(e);
    }).on("error", g), f.promise();
  }function j(a, c) {
    var d, e, f;try {
      d = b(a);
    } catch (a) {
      return !1;
    }return !!d.length && (e = b('<i style="display:none !important"/>'), f = d.hasClass("lity-hide"), c.element().one("lity:remove", function () {
      e.before(d).remove(), f && !d.closest(".lity-content").length && d.addClass("lity-hide");
    }), d.removeClass("lity-hide").after(e));
  }function k(a) {
    var c = J.exec(a);return !!c && o(g(a, f("https://www.youtube" + (c[2] || "") + ".com/embed/" + c[4], b.extend({ autoplay: 1 }, e(c[5] || "")))));
  }function l(a) {
    var c = K.exec(a);return !!c && o(g(a, f("https://player.vimeo.com/video/" + c[3], b.extend({ autoplay: 1 }, e(c[4] || "")))));
  }function m(a) {
    var c = M.exec(a);return !!c && (0 !== a.indexOf("http") && (a = "https:" + a), o(g(a, f("https://www.facebook.com/plugins/video.php?href=" + a, b.extend({ autoplay: 1 }, e(c[4] || ""))))));
  }function n(a) {
    var b = L.exec(a);return !!b && o(g(a, f("https://www.google." + b[3] + "/maps?" + b[6], { output: b[6].indexOf("layer=c") > 0 ? "svembed" : "embed" })));
  }function o(a) {
    return '<div class="lity-iframe-container"><iframe frameborder="0" allowfullscreen src="' + a + '"/></div>';
  }function p() {
    return z.documentElement.clientHeight ? z.documentElement.clientHeight : Math.round(A.height());
  }function q(a) {
    var b = v();b && (27 === a.keyCode && b.options("esc") && b.close(), 9 === a.keyCode && r(a, b));
  }function r(a, b) {
    var c = b.element().find(G),
        d = c.index(z.activeElement);a.shiftKey && d <= 0 ? (c.get(c.length - 1).focus(), a.preventDefault()) : a.shiftKey || d !== c.length - 1 || (c.get(0).focus(), a.preventDefault());
  }function s() {
    b.each(D, function (a, b) {
      b.resize();
    });
  }function t(a) {
    1 === D.unshift(a) && (C.addClass("lity-active"), A.on({ resize: s, keydown: q })), b("body > *").not(a.element()).addClass("lity-hidden").each(function () {
      var a = b(this);void 0 === a.data(F) && a.data(F, a.attr(E) || null);
    }).attr(E, "true");
  }function u(a) {
    var c;a.element().attr(E, "true"), 1 === D.length && (C.removeClass("lity-active"), A.off({ resize: s, keydown: q })), D = b.grep(D, function (b) {
      return a !== b;
    }), c = D.length ? D[0].element() : b(".lity-hidden"), c.removeClass("lity-hidden").each(function () {
      var a = b(this),
          c = a.data(F);c ? a.attr(E, c) : a.removeAttr(E), a.removeData(F);
    });
  }function v() {
    return 0 === D.length ? null : D[0];
  }function w(a, c, d, e) {
    var f,
        g = "inline",
        h = b.extend({}, d);return e && h[e] ? (f = h[e](a, c), g = e) : (b.each(["inline", "iframe"], function (a, b) {
      delete h[b], h[b] = d[b];
    }), b.each(h, function (b, d) {
      return !d || !(!d.test || d.test(a, c)) || (f = d(a, c), !1 !== f ? (g = b, !1) : void 0);
    })), { handler: g, content: f || "" };
  }function x(a, e, f, g) {
    function h(a) {
      k = b(a).css("max-height", p() + "px"), j.find(".lity-loader").each(function () {
        var a = b(this);c(a).always(function () {
          a.remove();
        });
      }), j.removeClass("lity-loading").find(".lity-content").empty().append(k), m = !0, k.trigger("lity:ready", [l]);
    }var i,
        j,
        k,
        l = this,
        m = !1,
        n = !1;e = b.extend({}, H, e), j = b(e.template), l.element = function () {
      return j;
    }, l.opener = function () {
      return f;
    }, l.options = b.proxy(d, l, e), l.handlers = b.proxy(d, l, e.handlers), l.resize = function () {
      m && !n && k.css("max-height", p() + "px").trigger("lity:resize", [l]);
    }, l.close = function () {
      if (m && !n) {
        n = !0, u(l);var a = B();if (g && (z.activeElement === j[0] || b.contains(j[0], z.activeElement))) try {
          g.focus();
        } catch (a) {}return k.trigger("lity:close", [l]), j.removeClass("lity-opened").addClass("lity-closed"), c(k.add(j)).always(function () {
          k.trigger("lity:remove", [l]), j.remove(), j = void 0, a.resolve();
        }), a.promise();
      }
    }, i = w(a, l, e.handlers, e.handler), j.attr(E, "false").addClass("lity-loading lity-opened lity-" + i.handler).appendTo("body").focus().on("click", "[data-lity-close]", function (a) {
      b(a.target).is("[data-lity-close]") && l.close();
    }).trigger("lity:open", [l]), t(l), b.when(i.content).always(h);
  }function y(a, c, d) {
    a.preventDefault ? (a.preventDefault(), d = b(this), a = d.data("lity-target") || d.attr("href") || d.attr("src")) : d = b(d);var e = new x(a, b.extend({}, d.data("lity-options") || d.data("lity"), c), d, z.activeElement);if (!a.preventDefault) return e;
  }var z = a.document,
      A = b(a),
      B = b.Deferred,
      C = b("html"),
      D = [],
      E = "aria-hidden",
      F = "lity-" + E,
      G = 'a[href],area[href],input:not([disabled]),select:not([disabled]),textarea:not([disabled]),button:not([disabled]),iframe,object,embed,[contenteditable],[tabindex]:not([tabindex^="-"])',
      H = { esc: !0, handler: null, handlers: { image: i, inline: j, youtube: k, vimeo: l, googlemaps: n, facebookvideo: m, iframe: o }, template: '<div class="lity" role="dialog" aria-label="Dialog Window (Press escape to close)" tabindex="-1"><div class="lity-wrap" data-lity-close role="document"><div class="lity-loader" aria-hidden="true">Loading...</div><div class="lity-container"><div class="lity-content"></div><button class="lity-close" type="button" aria-label="Close (Press escape to close)" data-lity-close>&times;</button></div></div></div>' },
      I = /(^data:image\/)|(\.(png|jpe?g|gif|svg|webp|bmp|ico|tiff?)(\?\S*)?$)/i,
      J = /(youtube(-nocookie)?\.com|youtu\.be)\/(watch\?v=|v\/|u\/|embed\/?)?([\w-]{11})(.*)?/i,
      K = /(vimeo(pro)?.com)\/(?:[^\d]+)?(\d+)\??(.*)?$/,
      L = /((maps|www)\.)?google\.([^\/\?]+)\/?((maps\/?)?\?)(.*)/i,
      M = /(facebook\.com)\/([a-z0-9_-]*)\/videos\/([0-9]*)(.*)?$/i,
      N = function () {
    var a = z.createElement("div"),
        b = { WebkitTransition: "webkitTransitionEnd", MozTransition: "transitionend", OTransition: "oTransitionEnd otransitionend", transition: "transitionend" };for (var c in b) {
      if (void 0 !== a.style[c]) return b[c];
    }return !1;
  }();return i.test = function (a) {
    return I.test(a);
  }, y.version = "2.3.1", y.options = b.proxy(d, y, H), y.handlers = b.proxy(d, y, H.handlers), y.current = v, b(z).on("click.lity", "[data-lity]", y), y;
});

/*jshint browser:true */
/*!
* FitVids 1.1
*
* Copyright 2013, Chris Coyier - http://css-tricks.com + Dave Rupert - http://daverupert.com
* Credit to Thierry Koblentz - http://www.alistapart.com/articles/creating-intrinsic-ratios-for-video/
* Released under the WTFPL license - http://sam.zoy.org/wtfpl/
*
*/

/*! jQuery & Zepto Lazy v1.7.10 - http://jquery.eisbehr.de/lazy - MIT&GPL-2.0 license - Copyright 2012-2018 Daniel 'Eisbehr' Kern */
!function (t, e) {
  "use strict";
  function r(r, a, i, u, l) {
    function f() {
      L = t.devicePixelRatio > 1, i = c(i), a.delay >= 0 && setTimeout(function () {
        s(!0);
      }, a.delay), (a.delay < 0 || a.combined) && (u.e = v(a.throttle, function (t) {
        "resize" === t.type && (w = B = -1), s(t.all);
      }), u.a = function (t) {
        t = c(t), i.push.apply(i, t);
      }, u.g = function () {
        return i = n(i).filter(function () {
          return !n(this).data(a.loadedName);
        });
      }, u.f = function (t) {
        for (var e = 0; e < t.length; e++) {
          var r = i.filter(function () {
            return this === t[e];
          });r.length && s(!1, r);
        }
      }, s(), n(a.appendScroll).on("scroll." + l + " resize." + l, u.e));
    }function c(t) {
      var i = a.defaultImage,
          o = a.placeholder,
          u = a.imageBase,
          l = a.srcsetAttribute,
          f = a.loaderAttribute,
          c = a._f || {};t = n(t).filter(function () {
        var t = n(this),
            r = m(this);return !t.data(a.handledName) && (t.attr(a.attribute) || t.attr(l) || t.attr(f) || c[r] !== e);
      }).data("plugin_" + a.name, r);for (var s = 0, d = t.length; s < d; s++) {
        var A = n(t[s]),
            g = m(t[s]),
            h = A.attr(a.imageBaseAttribute) || u;g === N && h && A.attr(l) && A.attr(l, b(A.attr(l), h)), c[g] === e || A.attr(f) || A.attr(f, c[g]), g === N && i && !A.attr(E) ? A.attr(E, i) : g === N || !o || A.css(O) && "none" !== A.css(O) || A.css(O, "url('" + o + "')");
      }return t;
    }function s(t, e) {
      if (!i.length) return void (a.autoDestroy && r.destroy());for (var o = e || i, u = !1, l = a.imageBase || "", f = a.srcsetAttribute, c = a.handledName, s = 0; s < o.length; s++) {
        if (t || e || A(o[s])) {
          var g = n(o[s]),
              h = m(o[s]),
              b = g.attr(a.attribute),
              v = g.attr(a.imageBaseAttribute) || l,
              p = g.attr(a.loaderAttribute);g.data(c) || a.visibleOnly && !g.is(":visible") || !((b || g.attr(f)) && (h === N && (v + b !== g.attr(E) || g.attr(f) !== g.attr(F)) || h !== N && v + b !== g.css(O)) || p) || (u = !0, g.data(c, !0), d(g, h, v, p));
        }
      }u && (i = n(i).filter(function () {
        return !n(this).data(c);
      }));
    }function d(t, e, r, i) {
      ++z;var _o = function o() {
        y("onError", t), p(), _o = n.noop;
      };y("beforeLoad", t);var u = a.attribute,
          l = a.srcsetAttribute,
          f = a.sizesAttribute,
          c = a.retinaAttribute,
          s = a.removeAttribute,
          d = a.loadedName,
          A = t.attr(c);if (i) {
        var _g = function g() {
          s && t.removeAttr(a.loaderAttribute), t.data(d, !0), y(T, t), setTimeout(p, 1), _g = n.noop;
        };t.off(I).one(I, _o).one(D, _g), y(i, t, function (e) {
          e ? (t.off(D), _g()) : (t.off(I), _o());
        }) || t.trigger(I);
      } else {
        var h = n(new Image());h.one(I, _o).one(D, function () {
          t.hide(), e === N ? t.attr(C, h.attr(C)).attr(F, h.attr(F)).attr(E, h.attr(E)) : t.css(O, "url('" + h.attr(E) + "')"), t[a.effect](a.effectTime), s && (t.removeAttr(u + " " + l + " " + c + " " + a.imageBaseAttribute), f !== C && t.removeAttr(f)), t.data(d, !0), y(T, t), h.remove(), p();
        });var m = (L && A ? A : t.attr(u)) || "";h.attr(C, t.attr(f)).attr(F, t.attr(l)).attr(E, m ? r + m : null), h.complete && h.trigger(D);
      }
    }function A(t) {
      var e = t.getBoundingClientRect(),
          r = a.scrollDirection,
          n = a.threshold,
          i = h() + n > e.top && -n < e.bottom,
          o = g() + n > e.left && -n < e.right;return "vertical" === r ? i : "horizontal" === r ? o : i && o;
    }function g() {
      return w >= 0 ? w : w = n(t).width();
    }function h() {
      return B >= 0 ? B : B = n(t).height();
    }function m(t) {
      return t.tagName.toLowerCase();
    }function b(t, e) {
      if (e) {
        var r = t.split(",");t = "";for (var a = 0, n = r.length; a < n; a++) {
          t += e + r[a].trim() + (a !== n - 1 ? "," : "");
        }
      }return t;
    }function v(t, e) {
      var n,
          i = 0;return function (o, u) {
        function l() {
          i = +new Date(), e.call(r, o);
        }var f = +new Date() - i;n && clearTimeout(n), f > t || !a.enableThrottle || u ? l() : n = setTimeout(l, t - f);
      };
    }function p() {
      --z, i.length || z || y("onFinishedAll");
    }function y(t, e, n) {
      return !!(t = a[t]) && (t.apply(r, [].slice.call(arguments, 1)), !0);
    }var z = 0,
        w = -1,
        B = -1,
        L = !1,
        T = "afterLoad",
        D = "load",
        I = "error",
        N = "img",
        E = "src",
        F = "srcset",
        C = "sizes",
        O = "background-image";"event" === a.bind || o ? f() : n(t).on(D + "." + l, f);
  }function a(a, o) {
    var u = this,
        l = n.extend({}, u.config, o),
        f = {},
        c = l.name + "-" + ++i;return u.config = function (t, r) {
      return r === e ? l[t] : (l[t] = r, u);
    }, u.addItems = function (t) {
      return f.a && f.a("string" === n.type(t) ? n(t) : t), u;
    }, u.getItems = function () {
      return f.g ? f.g() : {};
    }, u.update = function (t) {
      return f.e && f.e({}, !t), u;
    }, u.force = function (t) {
      return f.f && f.f("string" === n.type(t) ? n(t) : t), u;
    }, u.loadAll = function () {
      return f.e && f.e({ all: !0 }, !0), u;
    }, u.destroy = function () {
      return n(l.appendScroll).off("." + c, f.e), n(t).off("." + c), f = {}, e;
    }, r(u, l, a, f, c), l.chainable ? a : u;
  }var n = t.jQuery || t.Zepto,
      i = 0,
      o = !1;n.fn.Lazy = n.fn.lazy = function (t) {
    return new a(this, t);
  }, n.Lazy = n.lazy = function (t, r, i) {
    if (n.isFunction(r) && (i = r, r = []), n.isFunction(i)) {
      t = n.isArray(t) ? t : [t], r = n.isArray(r) ? r : [r];for (var o = a.prototype.config, u = o._f || (o._f = {}), l = 0, f = t.length; l < f; l++) {
        (o[t[l]] === e || n.isFunction(o[t[l]])) && (o[t[l]] = i);
      }for (var c = 0, s = r.length; c < s; c++) {
        u[r[c]] = t[0];
      }
    }
  }, a.prototype.config = { name: "lazy", chainable: !0, autoDestroy: !0, bind: "load", threshold: 500, visibleOnly: !1, appendScroll: t, scrollDirection: "both", imageBase: null, defaultImage: "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==", placeholder: null, delay: -1, combined: !1, attribute: "data-src", srcsetAttribute: "data-srcset", sizesAttribute: "data-sizes", retinaAttribute: "data-retina", loaderAttribute: "data-loader", imageBaseAttribute: "data-imagebase", removeAttribute: !0, handledName: "handled", loadedName: "loaded", effect: "show", effectTime: 0, enableThrottle: !0, throttle: 250, beforeLoad: e, afterLoad: e, onError: e, onFinishedAll: e }, n(t).on("load", function () {
    o = !0;
  });
}(window);

(function ($) {

  'use strict';

  $.fn.fitVids = function (options) {
    var settings = {
      customSelector: null,
      ignore: null
    };

    if (!document.getElementById('fit-vids-style')) {
      // appendStyles: https://github.com/toddmotto/fluidvids/blob/master/dist/fluidvids.js
      var head = document.head || document.getElementsByTagName('head')[0];
      var css = '.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}';
      var div = document.createElement("div");
      div.innerHTML = '<p>x</p><style id="fit-vids-style">' + css + '</style>';
      head.appendChild(div.childNodes[1]);
    }

    if (options) {
      $.extend(settings, options);
    }

    return this.each(function () {
      var selectors = ['iframe[src*="player.vimeo.com"]', 'iframe[src*="youtube.com"]', 'iframe[src*="youtube-nocookie.com"]', 'iframe[src*="kickstarter.com"][src*="video.html"]', 'object', 'embed'];

      if (settings.customSelector) {
        selectors.push(settings.customSelector);
      }

      var ignoreList = '.fitvidsignore';

      if (settings.ignore) {
        ignoreList = ignoreList + ', ' + settings.ignore;
      }

      var $allVideos = $(this).find(selectors.join(','));
      $allVideos = $allVideos.not('object object'); // SwfObj conflict patch
      $allVideos = $allVideos.not(ignoreList); // Disable FitVids on this video.

      $allVideos.each(function () {
        var $this = $(this);
        if ($this.parents(ignoreList).length > 0) {
          return; // Disable FitVids on this video.
        }
        if (this.tagName.toLowerCase() === 'embed' && $this.parent('object').length || $this.parent('.fluid-width-video-wrapper').length) {
          return;
        }
        if (!$this.css('height') && !$this.css('width') && (isNaN($this.attr('height')) || isNaN($this.attr('width')))) {
          $this.attr('height', 9);
          $this.attr('width', 16);
        }
        var height = this.tagName.toLowerCase() === 'object' || $this.attr('height') && !isNaN(parseInt($this.attr('height'), 10)) ? parseInt($this.attr('height'), 10) : $this.height(),
            width = !isNaN(parseInt($this.attr('width'), 10)) ? parseInt($this.attr('width'), 10) : $this.width(),
            aspectRatio = height / width;
        if (!$this.attr('name')) {
          var videoName = 'fitvid' + $.fn.fitVids._count;
          $this.attr('name', videoName);
          $.fn.fitVids._count++;
        }
        $this.wrap('<div class="fluid-width-video-wrapper"></div>').parent('.fluid-width-video-wrapper').css('padding-top', aspectRatio * 100 + '%');
        $this.removeAttr('height').removeAttr('width');
      });
    });
  };

  // Internal counter for unique video names.
  $.fn.fitVids._count = 0;

  // Works with either jQuery or Zepto
})(window.jQuery || window.Zepto);

$(document).ready(function () {

  $(document).on('click', '.to_cart', function () {
    $product = $(this).closest('.product').data('productid');
    $product_code = $(this).closest('.product').data('productcode');
    $product_name = $(this).closest('.product').find('.title').text();
    var cart = $('#header .cart.item');
    var img = $(this).closest('.product').find('.image_div');
    $qty = $(this).closest('.product').data('minqty');

    if ($(this).hasClass('sizes')) {
      $('#sizes_modal').modal('setting', {
        duration: 200,
        onShow: function onShow() {
          $('#sizes_modal').find('.image img').attr('src', img.find('img').attr('src'));
          $('#sizes_modal > .header').html($product_name);

          $.get('/api/product/' + $product + '/sizes', {}, function (data) {
            $('#sizes_modal').find("#sizes").html('');
            $(data).each(function (i, e) {
              if (e.stock == 'PRODEJ UKONČEN') {
                $class = 'inactive';
              } else {
                $class = "active";
              }

              if (e.size_code == $product_code) {
                $selected = ' selected';
              } else {
                $selected = "";
              }

              $('#sizes_modal').find("#sizes").append('<div class="size ' + $class + $selected + '" data-code="' + e.size_code + '">' + e.text + '</div>');

              $('#sizes_modal .size.active').click(function () {
                $('#sizes_modal .size').removeClass('selected');
                $(this).addClass('selected');
              });
            });
          });
        },

        onApprove: function onApprove() {
          $size = $('#sizes_modal').find('.selected.size').data('code');
          addToCart($product, $qty, $size);
          flyToElement(img, cart);
        }
      }).modal('show');
    } else {
      flyToElement(img, cart);
      addToCart($product, $qty);
    }
  });

  // append csrf token to all ajax calls
  $.ajaxSetup({
    headers: {
      'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
    }
  });

  var path = window.location.href.split('/');
  console.log(path);

  if (path[3] != '' && path[3] != 'admin' && $(window).width() > 680) {
    scrollTo('#grid.main');
  }

  // scrolTo smooth 
  function scrollTo(element) {
    if ($(element).length) {
      $('html,body').scrollTop($(element).offset().top);
    }
  }

  window.onpopstate = function (event) {
    if (event && event.state) {
      location.reload();
    }
  };

  $('.ui.checkbox').checkbox();

  $('#header .account.item').popup({
    popup: $('#auth_popup'),
    on: 'click'
  });

  $('#header .catalogues.item').popup({
    popup: $('#catalogues_popup'),
    on: 'hover',
    hoverable: true

  });

  $('#header .cart.item').popup({
    popup: $('#cart_popup'),
    on: 'hover',
    hoverable: true

  });

  $('#header .cart.item').click(function () {
    window.location.href = $(this).attr('href');
  });

  $('.register_form').click(function () {
    $popup = $('#auth_popup');
    $email = $('#register_div').find('input[name="email"]').val();
    $password = $('#register_div').find('input[name="password"]').val();
  });

  $('.login_form').submit(function () {
    $validation = 1;

    $popup = $('#auth_popup');
    $email = $('#login_div').find('input[name="email"]').val();
    $password = $('#login_div').find('input[name="password"]').val();

    if ($validation == 1) {
      return true;
    } else {
      return false;
    }
  });

  $('.add_category_btn').click(function () {
    $('#add_category_modal').modal('setting', {
      autofocus: false,
      onShow: function onShow() {
        $('.dropdown').dropdown();
      },
      onApprove: function onApprove() {
        $name = $('#add_category_input').val();
        $parent_id = $('input[name="parent_id"]').val();

        $.ajax({
          type: "POST",
          url: "/category",
          data: { name: $name, parent_id: $parent_id },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('#create_product_add_param_row').click(function () {
    $html = $('#create_product_params .row:first-child').html();
    $('#create_product_params').append('<div class="row">' + $html + '</div>');
    $('.ui.dropdown').dropdown();
  });

  $('#edit_product_add_param_row').click(function () {
    $html = $('#param_template .row').html();
    $('#edit_product_params').append('<div class="row">' + $html + '</div>');
    $('.ui.dropdown').dropdown();
  });

  $('#create_product_categories_input').dropdown({
    maxSelections: 1,
    onAdd: function onAdd(addedValue, addedText, $addedChoice) {
      console.log(addedValue);
    }
  });

  $('#create_product_form').submit(function (e) {
    $validation = 1;

    $name = $('#product_main_wrapper input[name="name"]').val();
    $code = $('#product_main_wrapper input[name="code"]').val();
    $maker = $('#product_main_wrapper input[name="maker"]').val();
    $threshold = $('#product_main_wrapper input[name^="thresholds"]').val();
    $moc = $('#product_main_wrapper input[name^="mocs"]').val();
    $mocs = $('#product_main_wrapper input[name^="moc_sales"]').val();
    $voc = $('#product_main_wrapper input[name^="vocs"]').val();
    $vocs = $('#product_main_wrapper input[name^="voc_sales"]').val();

    if ($name == '') {
      $validation = 0;$('#product_main_wrapper input[name="name"]').parent().addClass('error');
    }
    if ($code == '') {
      $validation = 0;$('#product_main_wrapper input[name="code"]').parent().addClass('error');
    }
    if ($maker == '') {
      $validation = 0;$('#product_main_wrapper input[name="maker"]').parent().addClass('error');
    }
    if ($threshold == '') {
      $validation = 0;$('#product_main_wrapper input[name^="thresholds"]').parent().addClass('error');
    }
    if ($moc == '') {
      $validation = 0;$('#product_main_wrapper input[name^="moc"]').parent().addClass('error');
    }
    if ($mocs == '') {
      $validation = 0;$('#product_main_wrapper input[name^="mocs"]').parent().addClass('error');
    }
    if ($voc == '') {
      $validation = 0;$('#product_main_wrapper input[name^="voc"]').parent().addClass('error');
    }
    if ($vocs == '') {
      $validation = 0;$('#product_main_wrapper input[name^="vocs"]').parent().addClass('error');
    }

    if ($validation == 1) {
      return true;
    }

    return false;
  });

  $('.other_img .img').click(function (e) {
    e.preventDefault();
    $('#product_main_wrapper .img.main img').attr('src', '/img/loader.gif');

    $index = $(this).find('img').data('index');

    $('#product_main_wrapper').data('index', $index);

    var img = new Image();
    var src = $(this).find('img').data('full');
    img.src = src;

    img.onload = function () {
      $('#product_main_wrapper .img.main img').attr('src', src);
      $('#product_main_wrapper .img.main').attr('href', src);
    };
  });

  $('.message .close').on('click', function () {
    $(this).closest('.message').transition('fade');
  });

  function flyToElement(flyer, flyingTo) {
    var $func = $(this);
    var divider = 5;
    var flyerClone = $(flyer).clone();
    $(flyerClone).css({ position: 'absolute', top: $(flyer).offset().top + 80 + "px", left: $(flyer).offset().left + 100 + "px", opacity: 1, 'z-index': 1000 });
    $('body').append($(flyerClone));
    $(flyerClone).width('350');
    var gotoX = $(flyingTo).offset().left + $(flyingTo).width() / 2 - $(flyer).width() / divider / 2;
    var gotoY = $(flyingTo).offset().top + $(flyingTo).height() / 2 - $(flyer).height() / divider / 2;

    $(flyerClone).animate({
      opacity: 0.4,
      left: gotoX,
      top: gotoY,
      width: $(flyer).width() / divider,
      height: $(flyer).height() / divider
    }, 700, function () {
      $(flyingTo).fadeOut('fast', function () {
        $(flyingTo).fadeIn('fast', function () {
          $(flyerClone).fadeOut('fast', function () {
            $(flyerClone).remove();
          });
        });
      });
    });
  }

  function addToCart(productid, qty) {
    var size = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;

    var cart = $('#header .cart.item');
    var price = parseFloat(cart.find('price number').text());
    var cartid = $('.content.cart').data('cartid');
    var cartpopup = $('#cart_popup');

    data = {};
    data['qty'] = qty;

    if (size != null) data['size'] = size;

    $.ajax({
      method: "POST",
      url: '/cart/' + cartid + "/" + productid,
      data: data,
      global: false,
      success: function success(data) {
        console.log(data);
        cart.find('.label').text(data.count);
        cart.find('price number').text(parseFloat(price + parseFloat(data.price)).toFixed(2));
        cartpopup.find('.button').before(data.row);
        cartpopup.find('.noitems').hide();
      }
    });
  }

  $('#product_detail_tocart_btn').click(function () {
    $product = $('#product_main_wrapper').data('id');
    $qty = $(this).data('qty');
    $size = $('#product_main_wrapper .sizes .size.selected').data('code');

    var cart = $('#header .cart.item');
    var img = $('#product_main_wrapper').find('.img');
    flyToElement(img, cart);

    addToCart($product, $qty, $size);
  });

  $(document).on('click', '.delete_cart', function () {
    console.log(1);
    $('#delete_cart_modal').modal('setting', {
      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/cart/all",
          data: {},
          success: function success() {
            location.replace('/cart/products');
          }
        });
      }
    }).modal('show');
  });

  $(document).on('click', '.catalogue_delete_btn', function () {
    $catalogueid = $(this).closest('.catalogue').data('id');
    $('#delete_catalogue_modal').modal('setting', {
      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/file/" + $catalogueid,
          data: {},
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.catalogue_primary_btn').click(function () {

    $catalogueid = $(this).closest('.catalogue').data('id');

    $.ajax({
      type: "PUT",
      url: "/file/" + $catalogueid,
      data: { 'primary': 1 },
      success: function success() {
        location.reload();
      }
    });
  });

  $('.catalogue_save_btn').click(function () {

    $catalogueid = $(this).closest('.catalogue').data('id');
    $path = $(this).closest('.catalogue').find('input').val();
    $(this).addClass('loading');

    $.ajax({
      type: "PUT",
      url: "/file/" + $catalogueid,
      data: { 'path': $path },
      success: function success() {
        location.reload();
      }
    });
  });

  $('.cart_delete_product').click(function () {
    $productid = $(this).closest('.product').data('productid');
    $cartid = $('.cart.content').data('cartid');

    $.ajax({
      type: "DELETE",
      url: "/cart/" + $cartid + "/" + $productid,
      data: {},
      success: function success() {
        location.reload();
      }
    });
  });

  $('.cart_plus_product').click(function () {
    $productid = $(this).closest('.product').data('productid');
    $.ajax({
      type: "POST",
      url: "/cart/" + $productid,
      data: {},
      success: function success() {
        location.reload();
      }
    });
  });

  $('.cart_minus_product').click(function () {
    $productid = $(this).closest('.product').data('productid');
    $.ajax({
      type: "PUT",
      url: "/cart/" + $productid,
      data: {},
      success: function success() {
        location.reload();
      }
    });
  });

  ///// Sorting and filtering ////////

  function getActiveFilters() {

    $filters = {};
    $filters['parameters'] = {};

    $('#active_filters span').each(function (index, element) {
      var group = $(element).data('group');
      var filter = $(element).data('filter');

      if ($(element).data('group')) {

        $filters[group][filter] = [];
      } else {
        $filters[$(element).data('filter')] = {};
      }
    });

    console.log($filters);

    $('#active_filters span').each(function (index, element) {
      var group = $(element).data('group');
      var filter = $(element).data('filter');
      if (group != null) {
        $filters[group][filter].push($(element).data('value'));
      } else {
        $filters[filter] = $(element).data('value');
      }
    });

    return $filters;
  }

  function getActiveCategory() {
    return $('#category_path_wrapper').data('categoryid');
  }

  function getDesiredSortBy() {
    return $('.sort.active').data('sortby');
  }

  function getDesiredSortOrder() {
    return $('.sort.active').data('sortorder');
  }

  filtersInit();

  function initCoverHeightSlider() {

    var checkExists = $('#cover_height_slider').length;

    if (checkExists) {

      if ($('#cover_height_slider')[0].noUiSlider) {
        $('#cover_height_slider')[0].noUiSlider.destroy();
      }

      var coverHeightSLider = document.getElementById('cover_height_slider');

      noUiSlider.create(coverHeightSLider, {
        start: $('input[name="cover_height"]').val(),
        connect: [true, false],
        range: {
          'min': 0,
          'max': 1000
        },
        format: wNumb({
          decimals: 0
        }),

        step: 1
      });

      coverHeightSLider.noUiSlider.on('slide', function () {
        $('input[name="cover_height"').val(coverHeightSLider.noUiSlider.get());
        chanegCoverHeight(coverHeightSLider.noUiSlider.get());
      });
    }
  }

  function initCoverWidthSlider() {

    var checkExists = $('#cover_width_slider').length;

    if (checkExists) {

      if ($('#cover_width_slider')[0].noUiSlider) {
        $('#cover_width_slider')[0].noUiSlider.destroy();
      }

      var coverHeightSLider = document.getElementById('cover_width_slider');

      noUiSlider.create(coverHeightSLider, {
        start: $('input[name="cover_width"]').val(),
        connect: [true, false],
        range: {
          'min': 50,
          'max': 90
        },
        format: wNumb({
          decimals: 0
        }),

        step: 1
      });

      coverHeightSLider.noUiSlider.on('slide', function () {
        $('input[name="cover_width"').val(coverHeightSLider.noUiSlider.get());
        changeCoverWidth(coverHeightSLider.noUiSlider.get());
      });
    }
  }

  function changeCoverWidth(width) {
    $('.banner_preview .cover').width(width + '%');
    $('#cover_dimensions_settings').find('width').text($('.banner_preview .cover').width());

    $coverRatio = ($('.banner_preview .cover').width() / $('.banner_preview .cover').height()).toFixed(2);
    $('#cover_dimensions_settings').find('ratio').text($coverRatio);

    $bannerRatio = ($('.banner_preview .banner').width() / $('.banner_preview .banner').height()).toFixed(2);
    $('#banner_dimensions_settings').find('ratio').text($bannerRatio);

    $('#banner_dimensions_settings').find('width').text($('.banner_preview .banner').width());

    $('input[name="cover_ratio"]').val($coverRatio);
    $('input[name="banner_ratio"]').val($bannerRatio);
  }

  function chanegCoverHeight(height) {
    $('.banner_preview .cover').height(height - 2);
    $('.banner_preview .banners').height(height);

    $('#cover_dimensions_settings').find('height').text($('.banner_preview .cover').height());

    $coverRatio = ($('.banner_preview .cover').width() / $('.banner_preview .cover').height()).toFixed(2);
    $('#cover_dimensions_settings').find('ratio').text($coverRatio);

    $bannerRatio = ($('.banner_preview .banner').width() / $('.banner_preview .banner').height()).toFixed(2);
    $('#banner_dimensions_settings').find('ratio').text($bannerRatio);

    $('#banner_dimensions_settings').find('height').text($('.banner_preview .banner').height());

    $('input[name="cover_ratio"]').val($coverRatio);
    $('input[name="banner_ratio"]').val($bannerRatio);
  }

  $('#banners_visible_checkbox').checkbox({
    onChecked: function onChecked() {
      $('.banner_preview').find('.banners').show();
      $('.banner_preview .cover').width($('input[name="cover_width"').val() + '%');
      $('#cover_width_setting').show();
    },
    onUnchecked: function onUnchecked() {
      $('.banner_preview').find('.banners').hide();
      $('.banner_preview .cover').width('100%');
      $('#cover_width_setting').hide();
    }
  });

  initCoverHeightSlider();
  initCoverWidthSlider();

  var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
      sParameterName = sURLVariables[i].split('=');

      if (sParameterName[0] === sParam) {
        return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
      }
    }
  };

  function doSort() {

    //console.log(getPriceFilter('price'));

    $grid = $('#grid_wrapper').find('grid');
    $filtersDiv = $('#filterbar').find('.params');

    $sortBy = getDesiredSortBy();
    $sortOrder = getDesiredSortOrder();

    $filters = getActiveFilters();
    $categoryid = getActiveCategory();

    $page = getUrlParameter('page');

    $.get('/product/list', { category: $categoryid, sortBy: $sortBy, sortOrder: $sortOrder, filters: $filters, page: $page }, function (data) {
      $grid.html(data.products);

      $filtersDiv.html(data.filters);

      filtersInit();

      $('#grid_wrapper').find('.dimmer').removeClass('active');
      $('#grid_wrapper').show();
      $('.sorts').show();
      $('#price_slider').show();
      $('.sort').removeClass('loading');

      $grid.on('click', '.view_more_button', function () {
        $('.view_more_button').addClass('loading');
        $.get($('#next_page').attr('href'), { category: $categoryid, sortBy: $sortBy, sortOrder: $sortOrder, filters: $filters }, function (data) {
          $('#grid_div').remove();
          $grid.find('.item').last().after($(data.products));
          $('#grid_wrapper').find('.dimmer').removeClass('active');
          $('.view_more_button').removeClass('loading');
        });
      });
    });
  };

  if ($('body').attr('id') == 'category_products_body' || $('body').attr('id') == 'search_body') {
    doSort();
  }

  function addFilter(key, value, desc) {
    var group = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : null;

    $('#active_filters').append('<span data-value="' + value + '" data-filter="' + key + '" data-group="' + group + '" class="' + key + ' ui large teal label">' + desc + '<i class="delete icon"></i></span>');
  }

  function getPriceFilter(key) {
    $div = $('#active_filters').find('span[data-filter="' + key + '"]');

    if ($div.length) {
      $array = $div.data('value').split(',');
      return $array;
    } else {
      return [0, $('#grid_stats').data('maxprice')];
    }
  }

  function removeFilter(key) {
    var value = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';

    if (value == '') {
      $('#active_filters').find('span[data-filter="' + key + '"]').remove();
    } else {
      $('#active_filters').find('span[data-value="' + value + '"][data-filter="' + key + '"]').remove();
    }
  }

  $('.sort').click(function () {
    $(this).addClass('loading');
    if ($(this).hasClass('active')) {
      if ($(this).data('sortorder') == 'asc') {
        if ($(this).data('sortby') != 'created_at') {
          $(this).data('sortorder', 'desc');
        }
        $(this).find('i').removeClass('ascending').addClass('descending');
      } else {
        if ($(this).data('sortby') != 'created_at') {
          $(this).data('sortorder', 'asc');
        }
        $(this).find('i').removeClass('descending').addClass('ascending');
      }
    } else {
      $('.sort').removeClass('active');
      $(this).addClass('active');
    }
    doSort();
  });

  function filtersInit() {
    $('#filterbar  .ui.checkbox').checkbox({
      onChecked: function onChecked() {
        $value = $(this).closest('.checkbox').data('value');
        $text = $(this).closest('.checkbox').find('label').text();
        $filter = $(this).closest('.checkbox').data('filter');
        $display = $(this).closest('.checkbox').data('display');

        addFilter($filter, $value, $display + ': ' + $text, 'parameters');
        doSort();
      },
      onUnchecked: function onUnchecked() {
        $value = $(this).closest('.checkbox').data('value');
        $text = $(this).closest('.checkbox').find('label').text();
        $filter = $(this).closest('.checkbox').data('filter');
        $display = $(this).closest('.checkbox').data('display');

        removeFilter($filter, $value);
        doSort();
      }
    });
  }

  $('.categories .item .icon.plus').click(function (e) {
    $(this).toggleClass('minus plus');
  });

  $('.categories .item .icon.minus').click(function (e) {
    $(this).toggleClass('minus plus');
  });

  $(".cart_delivery.eshop").click(function () {
    $this = $(this);
    $deliveryNote = $this.data('note');

    if (!$this.hasClass('completed')) {
      $delivery = $(this).data('delivery_method');

      $('.cart_payment').each(function (index, element) {
        $(element).removeClass('disabled completed active');
        if ($.inArray($delivery, $(element).data('delivery_methods')) == -1) {
          $(element).addClass('disabled');
        }
      });

      $shipping_price = parseFloat($(this).data('price'));

      $data = { delivery_method: $delivery };

      if ($('.cart_payment.completed.active').length && $(".cart_delivery.completed.active").length) {
        $shipping_price = parseFloat($(this).data('price'));
        $data['payment_method'] = '';
        $data['shipping_price'] = $shipping_price;

        $('#cart_shipping_price').find('price').text(parseFloat($data['shipping_price']));

        $('#cart_total_price').find('price').text(parseFloat($('#cart_total_price').data('price')) + $shipping_price);
        $('.cart_next').addClass('disabled');
      }

      if ($('.cart_payment.completed.active').length && !$(".cart_delivery.completed.active").length) {
        $data['shipping_price'] = $shipping_price + parseFloat($('.cart_delivery.completed.active').data('price'));

        $('#cart_shipping_price').find('price').text(parseFloat($data['shipping_price']));

        $('#cart_total_price').find('price').text(parseFloat($('#cart_total_price').data('price')) + $shipping_price);
        $('.cart_next').removeClass('disabled');
      }

      if (!$('.cart_payment.completed.active').length && $(".cart_delivery.completed.active").length) {
        $shipping_price = parseFloat($(this).data('price'));
        $data['payment_method'] = '';
        $(".cart_payment").removeClass('completed active');
        $data['shipping_price'] = $shipping_price;

        $('#cart_shipping_price').find('price').text(parseFloat($data['shipping_price']));

        $('#cart_total_price').find('price').text(parseFloat($('#cart_total_price').data('price')) + $shipping_price);
        $('.cart_next').addClass('disabled');
      }

      if (!$('.cart_payment.completed.active').length && !$(".cart_delivery.completed.active").length) {
        $shipping_price = parseFloat($(this).data('price'));
        $data['payment_method'] = '';
        $(".cart_payment").removeClass('completed active');

        $data['shipping_price'] = $shipping_price;

        $('#cart_shipping_price').find('price').text(parseFloat($data['shipping_price']));

        $('#cart_total_price').find('price').text(parseFloat($('#cart_total_price').data('price')) + $shipping_price);
      }

      $(".cart_delivery").removeClass('completed active');

      $.ajax({
        method: "POST",
        url: '/cart',
        data: $data,
        success: function success(data) {
          if (!$this.hasClass('completed')) {
            $this.addClass('completed active');
            $('#cart_info_wrapper').find('.delivery_note').html($deliveryNote);
            if ($deliveryNote) {
              $('#cart_info_wrapper').show();
            }
          }
        }
      });
    }
  });

  $(".cart_payment.eshop").click(function () {
    $this = $(this);
    $paymentNote = $this.data('note');

    if (!$this.hasClass('completed')) {
      $payment = $(this).data('payment_method');

      $shipping_price = parseFloat($(this).data('price'));

      $data = { payment_method: $payment };

      if ($('.cart_payment.completed.active').length && $(".cart_delivery.completed.active").length) {
        $shipping_price = $shipping_price + parseFloat($('.cart_delivery.completed.active').data('price'));
        $data['shipping_price'] = $shipping_price;
        $('#cart_total_price').find('price').text(parseFloat($('#cart_total_price').data('price')) + $shipping_price);
        $('#cart_shipping_price').find('price').text($shipping_price);
      }

      if ($('.cart_payment.completed.active').length && !$(".cart_delivery.completed.active").length) {
        $shipping_price = parseFloat($(this).data('price'));
        $data['shipping_price'] = $shipping_price;
        $('#cart_total_price').find('price').text(parseFloat($('#cart_total_price').data('price')) + $shipping_price);
        $('#cart_shipping_price').find('price').text($shipping_price);
      }

      if (!$('.cart_payment.completed.active').length && $(".cart_delivery.completed.active").length) {
        $shipping_price = $shipping_price + parseFloat($('.cart_delivery.completed.active').data('price'));
        $data['shipping_price'] = $shipping_price;
        $('#cart_total_price').find('price').text(parseFloat($('#cart_total_price').data('price')) + $shipping_price);
        $('.cart_next').removeClass('disabled');
        $('#cart_shipping_price').find('price').text($shipping_price);
      }

      if (!$('.cart_payment.completed.active').length && !$(".cart_delivery.completed.active").length) {
        $shipping_price = parseFloat($(this).data('price'));
        $data['shipping_price'] = $shipping_price;
        $('#cart_total_price').find('price').text(parseFloat($('#cart_total_price').data('price')) + $shipping_price);
        $('#cart_shipping_price').find('price').text($shipping_price);
      }

      $(".cart_payment").removeClass('completed active');

      $.ajax({
        method: "POST",
        url: '/cart',
        data: $data,
        success: function success() {
          if (!$this.hasClass('completed')) {
            $this.addClass('completed active');
            $('#cart_info_wrapper').find('.payment_note').html($paymentNote);
            if ($paymentNote) {
              $('#cart_info_wrapper').show();
            }
          }
        }
      });
    }
  });

  if ($('body').attr('id') == 'body_cart_delivery') {
    $deliveryprice = parseFloat($('.cart_delivery.active').data('price')) || 0;
    $paymentprice = parseFloat($('.cart_payment.active').data('price')) || 0;
    $('#cart_shipping_price').find('price').html($deliveryprice + $paymentprice);
    $('#cart_total_price').find('price').html(parseFloat($deliveryprice + $paymentprice + parseFloat($('#cart_without_vat_price').find('price').text() || 0) + parseFloat($('#cart_vat').find('price').text() || 0) + parseFloat($('#cart_price').find('price').text() || 0)).toFixed(2));

    $.ajax({
      method: "POST",
      url: '/cart',
      data: { 'shipping_price': $deliveryprice + $paymentprice }
    });
  }

  $('#view_goods_btn').click(function () {
    scrollTo('#home_content');
  });

  $('#login_password_input').keypress(function (e) {
    if (e.which == 13) {
      $('#login_form').submit();
    }
  });

  $('#register_password_input').keypress(function (e) {
    if (e.which == 13) {
      $('#register_btn').click();
    }
  });

  $('#product_detail_delete_btn').click(function () {
    $productid = $('#product_main_wrapper').data('id');
    $('#delete_product_modal').modal('setting', {
      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/product/" + $productid,
          data: {},
          success: function success() {
            location.replace('/admin/products');
          }
        });
      }
    }).modal('show');
  });

  $('.admin_delete_category_btn').click(function () {
    $categoryid = $(this).closest('.category').data('id');
    $('#delete_category_modal').modal('setting', {
      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/category/" + $categoryid,
          data: {},
          success: function success() {
            location.replace('/admin/products');
          }
        });
      }
    }).modal('show');
  });

  $('.product_row_delete_btn').click(function () {
    $productid = $(this).closest('.product').data('productid');
    $('#delete_product_modal').modal('setting', {
      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/product/" + $productid,
          data: {},
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  var timeout = null;

  $(".product_search_input input").keyup(function (e) {
    $query = $(this).val();
    removeFilter('search');
    if ($query != '') {
      addFilter('search', $query, 'hľadaj: ' + $query);
      doSort();
    }
  });

  $('#settings_submit_btn').click(function () {
    $validation = 1;

    $userid = $('#settings_user').data('userid');

    $container = $('#right');

    $data = {};

    $rawdata = {
      first_name: $container.find('input[name="first_name"]').val(),
      last_name: $container.find('input[name="last_name"]').val(),
      phone: $container.find('input[name="phone"]').val(),
      invoice_address: {
        street: $container.find('input[name="invoice_address_street"]').val(),
        zip: $container.find('input[name="invoice_address_zip"]').val(),
        city: $container.find('input[name="invoice_address_city"]').val(),

        company: $container.find('input[name="invoice_address_company"]').val(),
        ico: $container.find('input[name="invoice_address_ico"]').val(),
        dic: $container.find('input[name="invoice_address_dic"]').val(),
        icdph: $container.find('input[name="invoice_address_icdph"]').val()
      },
      delivery_address: {
        name: $container.find('input[name="delivery_address_name"]').val(),
        street: $container.find('input[name="delivery_address_street"]').val(),
        city: $container.find('input[name="delivery_address_city"]').val(),
        zip: $container.find('input[name="delivery_address_zip"]').val(),
        additional: $container.find('input[name="delivery_address_additional"]').val(),
        phone: $container.find('input[name="delivery_address_phone"]').val()
      }
    };

    /*
    $deliveryInputsLength = $('.delivery_address.inputs .input').length;
    $deliveryAddressEmpty = [];
      $('.delivery_address.inputs .input input').each(function(index, element){
      if ($(element).val()=='')
      {
        $deliveryAddressEmpty.push($(element).attr('name'));
      }
    })
      if ($deliveryInputsLength != $deliveryAddressEmpty.length){
      $.each($deliveryAddressEmpty, function(i, item) {
        $('input[name="'+item+'"]').closest('.input').addClass('error');
        $validation = 0;
      });
    }
    */

    $data.invoice_address = JSON.stringify($rawdata.invoice_address);
    $data.delivery_address = JSON.stringify($rawdata.delivery_address);
    $data.first_name = $rawdata.first_name;
    $data.last_name = $rawdata.last_name;
    $data.phone = $rawdata.phone;

    $data['redirect'] = $(this).data('redirect');

    if ($validation) {
      $.ajax({
        method: "PUT",
        url: '/user/' + $userid,
        data: $data,
        success: function success(data) {
          location.reload();
          //console.log(data)
        }
      });
    }
  });

  $('#use_delivery_address_input').checkbox({
    onChecked: function onChecked() {
      $('.cart_address .delivery').fadeIn();

      $.ajax({
        method: "POST",
        url: '/cart',
        data: { delivery_address_flag: 1 }
      });
    },
    onUnchecked: function onUnchecked() {
      $('.cart_address .delivery').fadeOut();

      $.ajax({
        method: "POST",
        url: '/cart',
        data: { delivery_address_flag: 0 }
      });
    }
  });

  $('#use_ico_input').checkbox({
    onChecked: function onChecked() {
      $('.cart_address .ico').fadeIn();

      $.ajax({
        method: "POST",
        url: '/cart',
        data: { ico_flag: 1 }
      });
    },
    onUnchecked: function onUnchecked() {
      $('.cart_address .ico').fadeOut();

      $.ajax({
        method: "POST",
        url: '/cart',
        data: { ico_flag: 0 }
      });
    }
  });

  function isEmail(email) {
    var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    return regex.test(email);
  }

  $('#cart_shipping_next_btn').click(function (e) {
    $validation = 1;

    $invoiceAddress = {};
    $deliveryAddress = {};
    $ico = {};

    $button = $(this);
    $button.addClass('loading');

    $invoiceAddressInputs = $('.cart_address').find('.invoice').find('.input');

    $invoiceAddressInputs.each(function (index, item) {
      $type = $(item).data('column');
      $invoiceAddress[$type] = $(item).find('input').val();
      if ($(item).find('input').val() == '') {
        $validation = 0;
        $(item).addClass('error');
      }
    });

    $deliveryAdressFlag = $('#use_delivery_address_input').checkbox('is checked');
    $icoFlag = $('#use_ico_input').checkbox('is checked');
    $email = $('input[type="email"]').val();

    if (!isEmail($email)) {
      $validation = 0;
      $('input[type="email"]').parent().addClass('error');
    }

    $phone = $('.input[data-column="phone"] input').val();

    if (!$.isNumeric($phone)) {
      $validation = 0;
      $('.input[data-column="phone"]').addClass('error');
    }

    if ($deliveryAdressFlag) {
      $deliveryAddressInputs = $('.cart_address').find('.delivery').find('.input');
      $deliveryAddressInputs.each(function (index, item) {
        $type = $(item).data('column');
        $deliveryAddress[$type] = $(item).find('input').val();
        if ($(item).filter('.mandatory').find('input').val() == '') {
          $validation = 0;
          $(item).addClass('error');
        }
      });
    }

    if ($icoFlag) {
      $icoInputs = $('.cart_address').find('.ico').find('.input');
      $icoInputs.each(function (index, item) {
        $type = $(item).data('column');
        $ico[$type] = $(item).find('input').val();
        if ($(item).filter('.mandatory').find('input').val() == '') {
          $validation = 0;
          $(item).addClass('error');
        }
      });
    }

    console.log($validation);

    if ($validation) {
      $.extend($invoiceAddress, $ico);

      $.ajax({
        method: "POST",
        url: '/cart',
        data: { invoice_address: JSON.stringify($invoiceAddress), delivery_address: JSON.stringify($deliveryAddress) }
      });

      e.preventDefault();
      setTimeout(function () {
        $.get($(this).attr('href'), {}, function () {
          location.replace($button.attr('href'));
        });
      }, 1000);
    } else {
      e.preventDefault();
      $button.removeClass('loading');
    }
  });

  $('#submit_order_btn').click(function () {
    $button = $(this);
    $button.addClass('loading');
    $.ajax({
      method: 'POST',
      url: '/order',
      success: function success() {
        location.replace("/order/success");
      }
    });
  });

  $(document).on('click', '.admin_delete_user_btn', function () {
    $userid = $(this).closest('.user').data('userid');
    $.ajax({
      method: "DELETE",
      url: '/user/' + $userid,
      success: function success() {
        location.reload();
      }
    });
  });

  $('.admin_admin_checkbox').checkbox({
    onChecked: function onChecked() {

      $userid = $(this).closest('.user').data('userid');

      $.ajax({
        method: "PUT",
        url: '/user/' + $userid,
        data: { admin: 1 }
      });
    },
    onUnchecked: function onUnchecked() {

      $userid = $(this).closest('.user').data('userid');

      $.ajax({
        method: "PUT",
        url: '/user/' + $userid,
        data: { admin: 0 }
      });
    }
  });

  $('.delete_img').click(function () {
    $image = $(this).closest('.image_div');
    $imageid = $image.data('fileid');

    $.ajax({
      method: "DELETE",
      url: '/file/' + $imageid,
      data: {},
      success: function success() {
        $image.remove();
      }
    });
  });

  $('.make_primary_img').click(function () {
    $image = $(this).closest('.image_div');
    $imageid = $image.data('fileid');

    $.ajax({
      method: "PUT",
      url: '/file/' + $imageid,
      data: { primary: 1 },
      success: function success() {
        $('.image_div').removeClass('primary');
        $image.addClass('primary');
      }
    });
  });

  // callback for clicking the active filter delete icon
  $("#active_filters").on('click', 'span .delete', function () {
    $filter = $(this).parent().data('filter');
    $value = $(this).parent().data('value');
    $(this).parent().remove();
    $('.filter[data-filter="' + $filter + '"][data-value="' + $value + '"]').removeClass('active');
    doSort();
  });

  $("#sidebar_handle").click(function () {
    $('#sidebar').sidebar('toggle');
  });

  $("#catbar_handle").click(function () {
    $('#catbar').sidebar('setting', 'transition', 'overlay').sidebar('toggle');
  });

  $("#parambarbar_handle").click(function () {
    $('#parambar').sidebar('toggle');
  });

  $('.close_btn').click(function () {
    $('.ui.sidebar').sidebar('hide');
  });

  $sales_carousel = $('#home_sales_div .items').flickity({
    cellAlign: 'left',
    contain: false,
    pageDots: false,
    prevNextButtons: false,
    imagesLoaded: true,
    wrapAround: true
  });

  $news_carousel = $('#home_news_div .items').flickity({
    cellAlign: 'left',
    contain: false,
    pageDots: false,
    prevNextButtons: false,
    imagesLoaded: false,
    wrapAround: true

  });

  $bestsellers_carousel = $('#home_bestsellers_div .items').flickity({
    cellAlign: 'left',
    contain: false,
    pageDots: false,
    prevNextButtons: false,
    imagesLoaded: true,
    wrapAround: true

  });

  $sales_carousel.on('staticClick.flickity', function (event, pointer, cellElement, cellIndex) {
    $link = $(cellElement).find('.p_anch').attr('href');
    if ($($(pointer)[0].target).hasClass('to_cart') == false && $($(pointer)[0].target).hasClass('icon') == false) {
      window.location.href = $link;
    }
  });

  $news_carousel.on('staticClick.flickity', function (event, pointer, cellElement, cellIndex) {
    $link = $(cellElement).find('.p_anch').attr('href');
    if ($($(pointer)[0].target).hasClass('to_cart') == false && $($(pointer)[0].target).hasClass('icon') == false) {
      window.location.href = $link;
    }
  });

  $bestsellers_carousel.on('staticClick.flickity', function (event, pointer, cellElement, cellIndex) {
    $link = $(cellElement).find('.p_anch').attr('href');
    if ($($(pointer)[0].target).hasClass('to_cart') == false && $($(pointer)[0].target).hasClass('icon') == false) {
      window.location.href = $link;
    }
  });

  $('#admin_add_category_param_btn').click(function () {
    $html = $('#admin_filters_div .row:first-child').clone();
    $('#admin_filters_div').append($html);
  });

  $('#filterbar .tabs .category.tab').click(function () {
    $('#cat_div').show();
    $('#filterbar .tabs .tab').removeClass('active');
    $(this).addClass('active');
  });

  $('#filterbar .tabs .param.tab:not(".disabled")').click(function () {
    $('#cat_div').hide();
    $('#filterbar .tabs .tab').removeClass('active');
    $(this).addClass('active');
  });

  $carousel = $('.covers').flickity({
    autoPlay: 4000,
    setGallerySize: false
  });

  $carousel_mobile = $('.top_banner_row_mobile').flickity({
    autoPlay: 4000,
    pageDots: false
  });

  $carousel.on('pointerUp.flickity', function () {
    $('#search_results').hide();
  });

  $('.expand_all_toggle').click(function () {
    $target = $(this).data('target');
    if ($(this).hasClass('expanded')) {
      $('[data-target="' + $target + '"]').find('.title').removeClass('active');
      $('[data-target="' + $target + '"]').find('.content').removeClass('active');
      $(this).removeClass('expanded').text('Rozbal všetko');
    } else {
      $('[data-target="' + $target + '"]').find('.title').addClass('active');
      $('[data-target="' + $target + '"]').find('.content').addClass('active');
      $(this).addClass('expanded').text('Zbal všetko');
    }
  });

  $('.tabs .tab').click(function () {
    $('.tabs .tab').removeClass('brown').addClass('basic');
    $(this).addClass('brown').removeClass('basic');
    $('.tabs .content').removeClass('active');
    $('.tabs .content[data-tab="' + $(this).data("tab") + '"]').addClass('active');
  });

  $('#new_page_btn').click(function () {
    $('#add_page_modal').modal('setting', {
      autofocus: true,
      onApprove: function onApprove() {
        $name = $('#add_page_name_input').val();
        $url = $('#add_page_url_input').val();
        $.ajax({
          type: "POST",
          url: "/page",
          data: { name: $name, url: $url },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('#new_text_btn').click(function () {
    $('#add_text_modal').modal('setting', {
      autofocus: true,
      onApprove: function onApprove() {
        $name = $('#add_text_name_input').val();
        $.ajax({
          type: "POST",
          url: "/text",
          data: { name: $name },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.disabled.rating').each(function (index, item) {
    //console.log($(item).data('rating'));
    $(item).rateYo('rating', $(item).data('rating'));
  });

  $('.dashboard_tabs .new.tab').click(function () {
    $('.dashboard_tabs .overall.tab').removeClass('blue').addClass('basic');
    $(this).addClass('blue').removeClass('basic');
    $('.admin_dashboard .new.boxes').removeClass('hidden');
    $('.admin_dashboard .overall.boxes').addClass('hidden');
  });

  $('.dashboard_tabs .overall.tab').click(function () {
    $('.dashboard_tabs .new.tab').removeClass('blue').addClass('basic');
    $(this).addClass('blue').removeClass('basic');
    $('.admin_dashboard .new.boxes').addClass('hidden');
    $('.admin_dashboard .overall.boxes').removeClass('hidden');
  });

  $('.add_delivery_method_btn').click(function () {
    $('#add_delivery_method_modal').modal('setting', {
      onVisible: function onVisible() {
        $('.ui.dropdown').dropdown();
      },
      onApprove: function onApprove() {
        $name = $('#add_delivery_method_name_input').val();
        $desc = $('#add_delivery_method_desc_input').val();
        $price = $('#add_delivery_method_price_input').val();
        $icon = $('#add_delivery_method_modal').find('.ui.dropdown.add').dropdown('get value');
        $note = $('add_delivery_method_note_input').val();

        $.ajax({
          type: "POST",
          url: "/admin/delivery",
          data: { name: $name, desc: $desc, icon: $icon, note: $note, price: $price },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.add_payment_method_btn').click(function () {
    $('#add_payment_method_modal').modal('setting', {
      onApprove: function onApprove() {
        $name = $('#add_payment_method_name_input').val();
        $desc = $('#add_payment_method_desc_input').val();
        $price = $('#add_payment_method_price_input').val();
        $icon = $('#add_payment_method_modal').find('.ui.dropdown.add').dropdown('get value');
        $note = $('add_payment_method_note_input').val();

        $.ajax({
          type: "POST",
          url: "/admin/payment",
          data: { name: $name, desc: $desc, icon: $icon, note: $note, price: $price },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.admin_method_list i.delete').click(function () {
    $item = $(this).closest('.step');
    $id = $(this).closest('.step').data('id');
    $type = $(this).closest('.step').data('type');

    $('#delete_method_modal').modal('setting', {
      autofocus: false,
      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/admin/" + $type + "/" + $id,
          success: function success() {
            $item.remove();
          }
        });
      }
    }).modal('show');
  });

  $('.page_delete_btn').click(function () {
    $id = $(this).closest('.item').data('id');

    $('#delete_page_modal').modal('setting', {
      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/page/" + $id,
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.text_delete_btn').click(function () {
    $id = $(this).closest('.item').data('id');

    $('#delete_text_modal').modal('setting', {
      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/text/" + $id,
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.sticker_delete_btn').click(function () {
    $id = $(this).closest('.item').data('id');

    $('#delete_sticker_modal').modal('setting', {
      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/sticker/" + $id,
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  var sticker_left, sticker_top;
  var sticker_width, sticker_height;

  $('#edit_sticker_submit').click(function () {

    $id = $(this).data('id');
    $sticker_product_row = $('#sticker_product_row').checkbox('is checked');
    $sticker_product_detail = $('#sticker_product_detail').checkbox('is checked');;

    $.ajax({
      url: '/sticker/' + $id,
      method: "PUT",
      data: { left: sticker_left, top: sticker_top, width: sticker_width, height: sticker_height, product_row: $sticker_product_row, product_detail: $sticker_product_detail },
      success: function success() {
        location.reload();
      }

    });
  });

  $('.admin_method_list i.edit').click(function () {
    $item = $(this).closest('.step');
    $id = $item.data('id');
    $type = $item.data('type');

    $('#edit_method_modal').modal('setting', {
      autofocus: false,
      onShow: function onShow() {

        $('#edit_method_name_input').val($item.data('name'));
        $('#edit_method_desc_input').val($item.data('desc'));
        $('#edit_method_price_input').val($item.data('price'));
        $('#edit_method_modal').find('.ui.dropdown.edit').dropdown('set value', $item.data('icon'));
        $('#edit_method_modal').find('.ui.dropdown.edit').dropdown('set text', "<i class='big icon " + $item.data('icon') + "'></i>");

        $('#edit_method_note_input').val($item.data('note'));
      },
      onApprove: function onApprove() {

        $name = $('#edit_method_name_input').val();
        $desc = $('#edit_method_desc_input').val();
        $price = $('#edit_method_price_input').val();
        $icon = $('#edit_method_modal').find('.ui.dropdown.edit').dropdown('get value');
        $note = $('#edit_method_note_input').val();

        console.log($note);

        $.ajax({
          type: "PUT",
          url: "/admin/" + $type + "/" + $id,
          data: { name: $name, desc: $desc, icon: $icon, note: $note, price: $price },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.tabbs .tabb').click(function () {
    $('.tabbs .tabb').removeClass('blue selected').addClass('basic');
    $(this).addClass('blue selected').removeClass('basic');
    $('.tabbs .contents .content').removeClass('active');
    $('.tabbs .contents .content[data-tab="' + $(this).data("tab") + '"]').addClass('active');
  });

  $('.delivery_payment_checkbox').checkbox({
    onChecked: function onChecked() {
      $delivery_method_id = $(this).closest('tr').data('delivery_method_id');
      $payment_method_id = $(this).closest('tr').data('payment_method_id');

      $.ajax({
        method: 'POST',
        url: '/admin/deliverypayment',
        data: { delivery_method_id: $delivery_method_id, payment_method_id: $payment_method_id }
      });
    },
    onUnchecked: function onUnchecked() {
      $delivery_method_id = $(this).closest('tr').data('delivery_method_id');
      $payment_method_id = $(this).closest('tr').data('payment_method_id');

      $.ajax({
        method: 'DELETE',
        url: '/admin/deliverypayment',
        data: { delivery_method_id: $delivery_method_id, payment_method_id: $payment_method_id }
      });
    }
  });

  $('input.delivery_price').keyup(function () {
    $delivery_method_id = $(this).closest('tr').data('delivery_method_id');
    $payment_method_id = $(this).closest('tr').data('payment_method_id');
    $price = $(this).val();

    $.ajax({
      method: 'PUT',
      url: '/admin/deliverypayment',
      data: { delivery_method_id: $delivery_method_id, payment_method_id: $payment_method_id, price: $price }
    });
  });

  var h1Slider = document.getElementById('admin_add_cover_h1_size_slider');
  var h2Slider = document.getElementById('admin_add_cover_h2_size_slider');

  if ($('#admin_add_cover_h1_size_slider').length) {
    noUiSlider.create(h1Slider, {
      start: $('#admin_add_cover_form input[name="h1_size"]').val(),
      connect: true,
      range: {
        'min': 0,
        'max': 6
      }
    });

    noUiSlider.create(h2Slider, {
      start: $('#admin_add_cover_form input[name="h2_size"]').val(),
      connect: true,
      range: {
        'min': 0,
        'max': 6
      }
    });

    h1Slider.noUiSlider.on('update', function (aa) {
      $('.cover_div h1').css('font-size', aa[0] + 'vw');
      $('#admin_add_cover_form input[name="h1_size"]').val(aa[0]);
    });

    h2Slider.noUiSlider.on('update', function (aa) {
      $('.cover_div h2').css('font-size', aa[0] + 'vw');
      $('#admin_add_cover_form input[name="h2_size"]').val(aa[0]);
    });
  }

  $('#admin_add_cover_h1').on('keyup', function (e, color) {
    $('.cover_div h1').html($(this).val());
    $('#admin_add_cover_form input[name="h1_text"]').val($(this).val());
  });

  $('#admin_add_cover_h2').on('keyup', function (e, color) {
    $('.cover_div h2').html($(this).val());
    $('#admin_add_cover_form input[name="h2_text"]').val($(this).val());
  });

  $('.delete_banner_btn').click(function () {
    $btn = $(this);
    $('#delete_banner_modal').modal('setting', {
      autofocus: false,
      onApprove: function onApprove() {
        $id = $btn.closest('.banner').data('id');
        $.ajax({
          type: "DELETE",
          url: "/admin/banner/" + $id,
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('#admin_new_wrapper table tbody .checkbox').checkbox({
    onChecked: function onChecked() {
      $id = $(this).closest('tr').data('id');
      $.ajax({
        method: 'PUT',
        url: '/api/product/' + $id,
        data: { new_carousel: 1 }
      });
    },
    onUnchecked: function onUnchecked() {
      $id = $(this).closest('tr').data('id');
      $.ajax({
        method: 'PUT',
        url: '/api/product/' + $id,
        data: { new_carousel: 0 }
      });
    }
  });

  $('#admin_sale_wrapper table tbody .checkbox').checkbox({
    onChecked: function onChecked() {
      $id = $(this).closest('tr').data('id');
      $.ajax({
        method: 'PUT',
        url: '/api/product/' + $id,
        data: { sale_carousel: 1 }
      });
    },
    onUnchecked: function onUnchecked() {
      $id = $(this).closest('tr').data('id');
      $.ajax({
        method: 'PUT',
        url: '/api/product/' + $id,
        data: { sale_carousel: 0 }
      });
    }
  });

  if ($('body').attr('id') == 'dashboard') {
    initCharts();
    drawCharts();
  }

  function drawCharts() {

    $('canvas').each(function (index, item) {
      var days = $(item).closest('.box').data('days');
      var resource = $(item).closest('.box').data('resource');
      var type = $(item).closest('.box').data('type');
      var chart = $(item).closest('.box').data('resource') + $(item).closest('.box').data('type');

      $.get('/api/' + resource + '/' + type + '/' + days, {}, function (data) {

        var labels = getLastDays(days).reverse();
        var chartdata = getDataByDays(data, days).reverse();

        drawChart(chart, labels, chartdata);
      });
    });
  }

  function drawChart(chart, labels, data) {

    $charts[chart].data.labels = [];
    $charts[chart].data.datasets.forEach(function (dataset) {
      dataset.data = [];
    });

    $(data).each(function (index, element) {
      addChartData($charts[chart], labels[index], data[index]);
    });
  }

  function addChartData(chart, label, data) {
    chart.data.labels.push(label);
    chart.data.datasets.forEach(function (dataset) {
      dataset.data.push(data);
    });
    chart.update();
  }

  function getLastDays(goBackDays) {
    var today = new Date();
    var days = [];

    for (var i = 0; i < goBackDays; i++) {
      var newDate = new Date(today.setDate(today.getDate() - 1));
      days.push(newDate.getFullYear() + '-' + parseInt(newDate.getMonth() + 1) + '-' + newDate.getDate());
    }

    return days;
  }

  function getDataByDays(data, goBackDays) {
    var result = [];

    var days = getLastDays(goBackDays);
    assocData = {};

    $(data).each(function (index, element) {
      assocData[element.date] = element.count;
    });

    $(days).each(function (index, element) {
      if (assocData[element]) {
        result.push(assocData[element]);
      } else {
        result.push(0);
      }
    });
    return result;
  }

  function randomColor() {
    var colorR = Math.floor(Math.random() * 256);
    var colorG = Math.floor(Math.random() * 256);
    var colorB = Math.floor(Math.random() * 256);
    rand = "rgb(" + colorR + "," + colorG + "," + colorB + ")";
    return rand;
  }

  function initCharts() {
    $charts = {};
    $('canvas').each(function (index, item) {
      var canvas = item;
      var ctx = canvas.getContext('2d');
      var color = randomColor();
      canvas.height = $(canvas).parent().height();

      $charts[$(item).closest('.box').data('resource') + $(item).closest('.box').data('type')] = new Chart(ctx, {
        type: 'line',

        data: {
          labels: [],
          datasets: [{
            label: "Počet",
            backgroundColor: color,
            borderColor: color,
            data: [],
            fill: false,
            lineTension: 0
          }]
        },

        options: {
          responsive: true,
          responsiveAnimationDuration: 0,
          maintainAspectRatio: false,

          legend: {
            display: false
          },
          scales: {
            yAxes: [{
              ticks: {
                stepSize: 1
              }
            }]
          }
        }

      });
    });
  }

  $('.chart_days_btn').click(function () {
    var box = $(this).closest('.box');
    var days = $(this).data('days');
    var resource = $(this).closest('.box').data('resource');
    var type = $(this).closest('.box').data('type');
    var chart = resource + type;

    $.get('/api/' + resource + '/' + type + '/' + days, {}, function (data) {
      var labels = getLastDays(days).reverse();
      var chartdata = getDataByDays(data, days).reverse();
      drawChart(chart, labels, chartdata);
    });

    $(this).closest('.fr').find('.chart_days_btn').removeClass('selected');
    $(this).addClass('selected');
  });

  $('.layout_div').click(function () {
    $layout = $(this).data('layout');
    $.post('/admin/layout/set', { layout: $layout }, function () {
      location.reload();
    });
  });

  $('.ui.new.product.search').search({
    apiSettings: {
      url: '/api/products/search?query={query}'
    },
    fields: {
      results: 'results',
      title: 'name',
      url: ''

    },
    onSelect: function onSelect(result, response) {
      $.ajax({
        method: 'PUT',
        url: '/api/product/' + result.id,
        data: { new: 1 },
        success: function success(data) {
          $row = $('#new_product_table tbody tr:first-child').clone();
          $row.find('td:first-child').text(result.id);
          $row.find('td:nth-child(2)').text(result.name);
          $row.data('id', result.id);
          $('#new_product_table tbody tr:last-child').before($row);
          $('.ui.new.product.search input').val('');
        }
      });
    }
  }).unbind('ajaxStart');;

  $('#new_product_table').on('click', '.red.button', function () {
    $row = $(this).closest('tr');
    $id = $row.data('id');
    $.ajax({
      method: 'PUT',
      url: '/api/product/' + $id,
      data: { new: 0 },
      success: function success(data) {
        $row.remove();
      }
    });
  });

  $('.ui.sale.product.search').search({
    apiSettings: {
      url: '/api/products/search?query={query}'
    },
    fields: {
      results: 'results',
      title: 'name',
      url: ''

    },
    onSelect: function onSelect(result, response) {
      $.ajax({
        method: 'PUT',
        url: '/api/product/' + result.id,
        data: { sale: 1 },
        success: function success(data) {
          $row = $('#sale_product_table tbody tr:first-child').clone();
          $row.find('td:first-child').text(result.id);
          $row.find('td:nth-child(2)').text(result.name);
          $row.data('id', result.id);
          $('#sale_product_table tbody tr:last-child').before($row);
          $('.ui.sale.product.search input').val('');
        }
      });
    }
  });

  $('#sale_product_table').on('click', '.red.button', function () {
    $row = $(this).closest('tr');
    $id = $row.data('id');
    $.ajax({
      method: 'PUT',
      url: '/api/product/' + $id,
      data: { sale: 0 },
      success: function success(data) {
        $row.remove();
      }
    });
  });

  $('.ui.inactive.product.search').search({
    apiSettings: {
      url: '/api/products/search?query={query}'
    },
    fields: {
      results: 'results',
      title: 'name',
      url: ''

    },
    onSelect: function onSelect(result, response) {
      $.ajax({
        method: 'PUT',
        url: '/api/product/' + result.id,
        data: { active: 0 },
        success: function success(data) {
          $row = $('#inactive_product_table tbody tr:first-child').clone();
          $row.find('td:first-child').text(result.id);
          $row.find('td:nth-child(2)').text(result.name);
          $row.data('id', result.id);
          $('#inactive_product_table tbody tr:last-child').before($row);
        }
      });
    }
  });

  $('#inactive_product_table').on('click', '.red.button', function () {
    $row = $(this).closest('tr');
    $id = $row.data('id');
    $.ajax({
      method: 'PUT',
      url: '/api/product/' + $id,
      data: { active: 1 },
      success: function success(data) {
        $row.remove();
      }
    });
  });

  $('.ui.bestseller.product.search').search({
    apiSettings: {
      url: '/api/products/search?query={query}'
    },
    fields: {
      results: 'results',
      title: 'name',
      url: ''

    },
    onSelect: function onSelect(result, response) {
      $.ajax({
        method: 'PUT',
        url: '/api/product/' + result.id,
        data: { bestseller: 1 },
        success: function success(data) {
          $row = $('#bestseller_product_table tbody tr:first-child').clone();
          $row.find('td:first-child').text(result.id);
          $row.find('td:nth-child(2)').text(result.name);
          $row.data('id', result.id);
          $('#bestseller_product_table tbody tr:last-child').before($row);
          $('.ui.bestseller.product.search input').val('');
        }
      });
    }
  }).unbind('ajaxStart');;

  $('#bestseller_product_table').on('click', '.red.button', function () {
    $row = $(this).closest('tr');
    $id = $row.data('id');
    $.ajax({
      method: 'PUT',
      url: '/api/product/' + $id,
      data: { bestseller: 0 },
      success: function success(data) {
        $row.remove();
      }
    });
  });

  $('.ui.bestseller.category.search').search({
    apiSettings: {
      url: '/api/categories/search?query={query}'
    },
    fields: {
      results: 'results',
      title: 'full_url',
      image: '',
      action: '',
      actionText: '',
      actionURL: '',
      url: ''
    },
    onSelect: function onSelect(result, response) {
      $.ajax({
        method: 'PUT',
        url: '/api/category/' + result.id,
        data: { bestseller: 1 },
        success: function success(data) {
          $row = $('#bestseller_category_table tbody tr:first-child').clone();
          $row.find('td:first-child').text(result.id);
          $row.find('td:nth-child(2)').text(result.name);
          $row.data('id', result.id);
          $('#bestseller_category_table tbody tr:last-child').before($row);
          $('.ui.bestseller.category.search input').val('');
        }
      });
    }
  }).unbind('ajaxStart');;

  $('#bestseller_category_table').on('click', '.red.button', function () {
    $row = $(this).closest('tr');
    $id = $row.data('id');
    $.ajax({
      method: 'PUT',
      url: '/api/category/' + $id,
      data: { bestseller: 0 },
      success: function success(data) {
        $row.remove();
      }
    });
  });

  $('.ui.cart.product.search').search({
    apiSettings: {
      url: '/api/products/search?query={query}'
    },
    fields: {
      results: 'results',
      title: 'name',
      url: ''

    },
    onSelect: function onSelect(result, response) {
      $cartid = $('.cart.content').data('cartid');
      $.ajax({
        method: 'POST',
        url: "/cart/" + $cartid + "/" + result.id,
        data: { qty: 1 },
        success: function success(data) {
          location.reload();
        }
      });
    }
  });

  $('#import_json_btn').click(function () {
    $json = $.parseJSON($('#import_json').find('textarea').val());
    $table = $('#import_json_table');
    $tbody = $table.find('tbody');
    $table.show();

    $($json).each(function (i, e) {
      $tbody.find('tr:last-child td:nth-child(2)').html('<img src="' + e.img + '" width="100" />');
      $tbody.find('tr:last-child td:nth-child(3)').text(e.id);
      $tbody.find('tr:last-child td:nth-child(4)').text(e.nome);
      $tbody.find('tr:last-child td:nth-child(5)').text(e.descr);
      $tbody.find('tr:last-child').clone().appendTo($tbody);
    });

    $('.ui.checkbox').checkbox();
  });

  $('#import_json_accept').click(function () {
    var json = $('#import_json_table').tableToJSON();
    console.log(json);
    $.post('/admin/import/json', { json: $('#import_json').find('textarea').val() }, function (e) {
      console.log(e);
    });
  });

  $('.add_color_btn').click(function () {
    $('#add_color_modal').modal('setting', {
      onApprove: function onApprove() {
        $key = $('#add_color_key_input').val();
        $value = $('#add_color_value_input').val();

        $.ajax({
          type: "POST",
          url: "/admin/color/",
          data: { key: $key, value: $value },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  function initCartProductSlider() {

    var sliders = document.getElementsByClassName('cart_length_slider');
    $min = [];
    $old = [];
    for (var i = 0; i < sliders.length; i++) {
      $ii = i;

      $qty = $(sliders[i]).data('qty');
      $step = $(sliders[i]).data('step');
      $thresholds = $(sliders[i]).data('thresholds');

      $prices = JSON.parse($(sliders[i]).data('prices'));
      $min[i] = $(sliders[i]).data('min');

      noUiSlider.create(sliders[i], {
        start: $qty,
        step: $step,
        connect: "lower",
        orientation: "horizontal",
        tooltips: true,
        range: {
          'min': 0,
          'max': 500
        },

        format: wNumb({
          decimals: 0
        })
      });

      sliders[i].noUiSlider.on('slide', function (values, handle) {
        $level = getClosestValue($thresholds, values[handle]);
        $index = $thresholds.indexOf($level);
        $newprice = $prices[$index];
        $($(this)[0].target).closest('.item.product').find('.final_price').html($newprice + ' &euro;');
      });

      $cartid = $('.cart.content').data('cartid');

      $old[i] = sliders[i].noUiSlider.get();

      sliders[i].noUiSlider.on('change', function (values, handle) {
        if (values[handle] < $($(this)[0].target).data('min')) {
          sliders[$ii].noUiSlider.set($old[$ii]);
        } else {
          $('#grid_wrapper .dimmer').addClass('active');

          $.ajax({
            type: "PUT",
            url: "/cart/" + $cartid + "/" + $($(this)[0].target).data('productid'),
            data: { qty: values[handle] },
            success: function success() {
              location.reload();
            }
          });
        };
      });
    }
  }

  initCartProductSlider();

  function getClosestValue(myArray, myValue) {
    //optional
    var i = 0;

    while (myArray[++i] <= myValue) {}

    return myArray[--i];
  }

  $('#add_price_level_btn').click(function () {
    $.get('/api/view/pricelevel', {}, function (data) {
      $('#product_price_levels_list').append(data);
    });
  });

  /*
  $('#product_detail .img img').loupe({
      width: 250, // width of magnifier
    height: 200, // height of magnifier
    loupe: 'loupe' // css class for magnifier
  });
  */

  $('.admin_checkbox_onthefly').checkbox({
    onChecked: function onChecked() {
      $resource = $(this).parent().data('resource');
      $name = $(this).attr('name');
      $id = $(this).parent().data('id');
      $data = {};
      $data[$name] = 1;
      $.ajax({
        method: 'PUT',
        url: '/' + $resource + '/' + $id,
        data: $data
      });
    },
    onUnchecked: function onUnchecked() {
      $resource = $(this).parent().data('resource');
      $name = $(this).attr('name');
      $id = $(this).parent().data('id');
      $data = {};
      $data[$name] = 0;
      $.ajax({
        method: 'PUT',
        url: '/' + $resource + '/' + $id,
        data: $data
      });
    }
  });

  if ($('body').attr('id') == "body_bulk") {
    var detailRenderer = function detailRenderer(instance, td, row, col, prop, value, cellProperties) {
      $(td).html('<a class="blue icon mini button" href="/p/' + value + '"><i class="search icon"><i></a>');
      $(td).append('<a class="teal icon mini button" href="/admin/eshop/product/' + value + '"><i class="edit icon"><i></a>');
      return td;
    };

    var categoryRenderer = function categoryRenderer(instance, td, row, col, prop, value, cellProperties) {
      var row = [];

      $(value).each(function (i, e) {
        row[i] = e.path + "<br/>";
      });

      $(td).html(row);
      return td;
    };

    var imageRenderer = function imageRenderer(instance, td, row, col, prop, value, cellProperties) {
      $(function () {
        $('.lazy').Lazy();
      });

      if (value) {
        if (value.path && value.path.toString().indexOf('http') !== -1) {
          $(td).html('<div class="image"><img class="lazy" data-src="' + value.path + '" /></div>');
        } else {
          $(td).html('<div class="image"><img class="lazy" data-src="/' + value.path + '" /></div>');
        }
      }

      return td;
    };

    container = document.getElementById('bulk_products_table');
    var cellChanges = [];
    var selectedCells = [];
    var selectedIds = [];
    var categoryChanges = [];

    $data = {};
    $data['changes'] = [];

    $data['categoryChanges'] = {};
    $data['categoryChanges']['categories'] = [];
    $data['categoryChanges']['products'] = [];

    $data['categoryAdds'] = {};
    $data['categoryAdds']['categories'] = [];
    $data['categoryAdds']['products'] = [];

    $data['categoryRemoved'] = {};
    $data['categoryRemoved']['categories'] = [];
    $data['categoryRemoved']['products'] = [];

    $data['addEcoImages'] = {};
    $data['removeEcoImages'] = {};

    hot = new Handsontable(container, {
      columns: [{ data: "url", renderer: detailRenderer }, { data: "active", type: 'checkbox', checkedTemplate: 1, uncheckedTemplate: 0 }, { data: "image", renderer: imageRenderer }, { data: "code" }, { data: "name" }, { data: "price_levels.0.moc_regular" }, { data: "price_levels.0.moc_sale" }, { data: "sale", type: 'checkbox', checkedTemplate: 1, uncheckedTemplate: 0 }, { data: "categories", renderer: categoryRenderer }],
      colHeaders: ['', 'Aktívny', 'Obrázok', 'Kód', 'Názov', 'Cena', 'Cena v zlave', "Zlava", 'Kategórie'],
      colWidths: [5, 7, 7, 10, '', 10, 10, 5, ''],
      rowHeaders: true,
      minSpareRows: 1,
      stretchH: 'all',
      columnSorting: true,
      rowHeights: 60,

      outsideClickDeselects: false,
      afterChange: function afterChange(change, source) {
        if (source == 'edit' || source == 'CopyPaste.paste') {
          if (change[0][2] != change[0][3]) {
            cellChanges.push({ 'rowid': change[0][0], 'colid': this.propToCol(change[0][1]) });
            $data['changes'].push(this.getSourceDataAtRow(change[0][0]));
          }

          $.each(cellChanges, function (index, element) {
            $this.getCell(element['rowid'], element['colid'], false).className = 'changed';
          });
          console.log($data['changes']);
        }
      },
      afterRender: function afterRender() {
        $this = this;
        $.each(cellChanges, function (index, element) {
          $this.getCell(element['rowid'], element['colid'], false).className = 'changed';
        });
      },
      afterSelection: function afterSelection(row, column, row2, column2, preventScrolling, selectionLayerLevel) {
        selectedIds = [];
        selectedCells = [];

        $ins = this;
        $('#bulk_products_wrapper .actions >.right').show();

        var j;

        $(this.getSelected()).each(function (i, e) {
          for (j = e[0]; j <= e[2]; j++) {
            selectedCells.push($ins.getSourceDataAtRow(j));
            selectedIds.push($ins.getSourceDataAtRow(j).id);
          }
        });

        var i;
        for (i = row; i <= row2; i++) {
          selectedCells.push(this.getSourceDataAtRow(i));
          selectedIds.push(this.getSourceDataAtRow(i).id);
        }
      },
      afterDeselect: function afterDeselect() {
        $('#bulk_products_wrapper .actions .right').hide();
        selectedCells = [];
        selectedIds = [];
      }
    });

    var load_btn = document.getElementById('bulk_load_btn');

    Handsontable.dom.addEvent(load_btn, 'click', function () {

      $(load_btn).addClass('loading');

      $filters = {
        "categories": $('.filter_item.category').dropdown('get value'),
        "name": $('.filter_item.name').find('input').val(),
        "without_category": $('.filter_item.without_category').checkbox('is checked'),
        "inactive_only": $('.filter_item.inactive').checkbox('is checked')
      };

      $.ajax({
        url: '/api/products/filter',
        method: 'GET',
        data: $filters,
        success: function success(data) {
          $('#bulk_products_table').show();
          $('#bulk_save_btn').css('display', 'inline-block');
          $(load_btn).removeClass('loading');
          hot.getInstance().loadData(data);
          hot.getInstance().render();
        }

      });
    });

    $('#bulk_change_category_dropdown').dropdown({
      maxSelections: 10,
      fullTextSearch: true,
      onAdd: function onAdd(addedValue, addedText, $addedChoice) {
        categoryChanges.push(addedValue);
      }
    });

    $('#bulk_change_category_btn').click(function () {
      $('#bulk_change_category_modal').modal('setting', {
        autofocus: false,
        onShow: function onShow() {
          $.ajax({
            method: "GET",
            url: '/api/products/simplelist',
            data: { id: selectedIds },
            success: function success(data) {
              $('#bulk_change_category_modal').find('.product_list').html(data);
            }
          });
        },
        onApprove: function onApprove() {
          $data['categoryChanges']['products'] = selectedIds;
          $data['categoryChanges']['categories'].push($('#bulk_change_category_dropdown').dropdown('get value'));
        }
      }).modal('show');
    });

    $('#bulk_add_category_btn').click(function () {
      $('#bulk_add_category_modal').modal('setting', {
        autofocus: false,
        onShow: function onShow() {
          $.ajax({
            method: "GET",
            url: '/api/products/simplelist',
            data: { id: selectedIds },
            success: function success(data) {
              $('#bulk_add_category_modal').find('.product_list').html(data);
            }
          });
        },
        onApprove: function onApprove() {
          $data['categoryAdds']['products'] = selectedIds;
          $data['categoryAdds']['categories'].push($('#bulk_add_category_dropdown').dropdown('get value'));
        }
      }).modal('show');
    });

    $('#bulk_add_eco_images_btn').click(function () {
      $data['addEcoImages'] = selectedIds;
    });

    $('#bulk_remove_eco_images_btn').click(function () {
      $data['removeEcoImages'] = selectedIds;
    });

    var save_btn = document.getElementById('bulk_save_btn');

    Handsontable.dom.addEvent(save_btn, 'click', function () {
      $(save_btn).addClass('loading');

      console.log(JSON.stringify($data));

      // save all cell's data
      $.ajax({
        url: '/api/bulk',
        method: 'POST',
        data: JSON.stringify($data),
        success: function success(res) {
          $(save_btn).removeClass('loading');
          $('#bulk_products_table').find('td').removeClass('changed');
        }

      });
    });
  }

  $('#bulk_filter_category').dropdown({
    maxSelections: 10,
    fullTextSearch: true,
    onAdd: function onAdd(addedValue, addedText, $addedChoice) {}
  });

  $('#cookies_consent_btn').click(function () {
    $(document).unbind('ajaxStart');
    $('#cookies_msg').hide();
    $.ajax({
      method: "POST",
      url: '/cookies',
      data: { name: 'cookies_consent', value: 1, expiry: 9999999 },
      success: function success() {
        $(document).bind('ajaxStart');
      }
    });
  });

  $('#product_sticker_load_btn').click(function () {

    $filters = {
      "categories": $('.filter_item.category').dropdown('get value'),
      "name": $('.filter_item.name input').val()
    };

    if ($('#filters_stickers_active_checkbox').checkbox('is checked')) {
      $filters['with_stickers_only'] = 1;
    }

    $button = $(this);
    $button.addClass('loading');

    $.ajax({
      url: '/api/products/filter',
      method: 'GET',
      data: $filters,
      success: function success(data) {
        $('.product_list .list').html('');
        $(data).each(function (i, e) {

          $stickers = [];

          if (e.stickers.length != 0) {
            $(e.stickers).each(function (i, e) {
              if (e.path.toString().indexOf('http') !== -1) {
                $stickers.push('<img src=' + e.path + ' data-productid=' + e.pivot.product_id + ' data-stickerid=' + e.pivot.sticker_id + '>');
              } else {
                $stickers.push('<img src=/' + e.path + ' data-productid=' + e.pivot.product_id + ' data-stickerid=' + e.pivot.sticker_id + '>');
              }
            });
          }

          $html = "<div class='item' data-id='" + e.id + "'>";
          $html += "<div class='ui checkbox'><input type='checkbox'><label></label></div>";
          $html += "<div class='name'>" + e.name + "</div>";
          $html += "<div class='active_stickers'>" + $stickers.toString() + "</div>";
          $html += "</div>";
          $('.product_list .list').append($html);

          $('.product_list .list .checkbox').checkbox({
            onChecked: function onChecked() {
              $item = $(this).closest('.item');
              $item.addClass('selected');
            },
            onUnchecked: function onUnchecked() {
              $item = $(this).closest('.item');
              $item.removeClass('selected');
            }
          });
        });
        $button.removeClass('loading');
        $('#product_sticker_save_btn').css('display', 'inline-block');

        $('.active_stickers img').click(function () {
          $image = $(this);
          $productid = $(this).data('productid');
          $stickerid = $(this).data('stickerid');
          $.ajax({
            url: '/product/' + $productid + '/sticker/' + $stickerid,
            method: 'DELETE',
            success: function success(data) {
              $image.remove();
            }
          });
        });
      }
    });
  });

  $('.sticker_list .sticker').click(function () {
    $(this).toggleClass('selected');
  });

  $('#product_sticker_save_btn').click(function () {
    $data = {};
    $data['products'] = [];
    $data['stickers'] = [];
    $data['sticker_paths'] = [];

    $('.sticker_list .sticker.selected').each(function (i, e) {
      $data['stickers'][i] = $(e).data('id');
      $data['sticker_paths'][i] = $(e).find('img').attr('src');
    });

    $('.product_list .list .item.selected').each(function (i, e) {
      $data['products'][i] = $(e).data('id');
    });

    $.ajax({
      url: '/stickers/attach',
      method: 'POST',
      data: $data,
      success: function success(data) {
        $('.product_list .list .item.selected').each(function (i, e) {
          $(e).find('.active_stickers').append('<img src=' + $data['sticker_paths'] + '>');
        });
      }
    });
  });

  if ($('body').attr('id') == 'cartproducts') {
    /*
    $cart_price = 0;
    
    $('#cart_detail .product').each(function(index,item){
      $cart_price = $cart_price + parseFloat($(item).find('.final_price').text());
    })
    
    //$('#cart_total_price').find('price').text(parseFloat($cart_price).toFixed(2));
    
    if(parseFloat($('#cart_total_price').find('price').text()) < parseFloat($('#cart_min_price').find('price').text()))
    {
    	$('#cart_continue_btn').addClass('disabled');
    }
    
    $freeShippingPrice = parseFloat($('#cart_free_shipping_price').data('price')) - parseFloat($('#cart_total_price').find('price').text()).toFixed(2);
    
    if ($freeShippingPrice > 0)
    {
    	$freeShippingPrice = parseFloat($freeShippingPrice).toFixed(2);
    	console.log($freeShippingPrice);
    	$('#cart_free_shipping_price').find('price').text($freeShippingPrice);
    }
    else
    {
    	//$('#cart_free_shipping_price').hide();
    }
    */
  }

  $('.filterbar_handle').mouseover(function () {
    $('.absolute').show();
  });

  $('.absolute #filterbar').mouseleave(function () {
    setTimeout(function () {
      $('.absolute').hide();
    }, 600);
  });

  $('.admin_delete_category_param_btn').click(function () {
    $.ajax({
      method: "DELETE",
      url: '/category/parameter/' + $(this).data('paramid'),
      success: function success() {
        location.reload();
      }
    });
  });

  $('.category i.setting').click(function (e) {
    e.preventDefault();

    location.replace($(this).data('href'));
  });

  $('#change_grid_view_btn').click(function () {
    $('#grid_wrapper').find('.item').addClass('grid').removeClass('list');
    $(this).addClass('active');
    $('#change_list_view_btn').removeClass('active');
  });

  $('#change_list_view_btn').click(function () {
    $('#grid_wrapper').find('.item').addClass('list').removeClass('grid');
    $(this).addClass('active');
    $('#change_grid_view_btn').removeClass('active');
  });

  $('#cart_continue_btn').click(function () {
    $price = $('#cart_total_price price').text();

    $.ajax({
      type: "POST",
      url: "/cart/",
      data: { price: $price },
      success: function success() {
        //
      }
    });
  }).unbind('ajaxStart');

  $().prettyEmbed({
    useFitVids: true
  });

  $(document).on('click', '.pretty-embed', function () {
    var lightbox = lity('//www.youtube.com/watch?v=' + $(this).data('pe-videoid'));
  });

  $('#add_param_btn').click(function () {
    $('#add_param_modal').modal('setting', {
      autofocus: false,
      onApprove: function onApprove() {
        $key = $('#add_param_modal input[name="key"]').val();
        $display_key = $('#add_param_modal input[name="display_key"]').val();

        $.ajax({
          type: "POST",
          url: "/param/",
          data: { key: $key, display_key: $display_key },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.edit_param_btn').click(function () {
    $id = $(this).closest('.param.item').data('paramid');
    $val = $(this).closest('.param.item').data('val');

    $('#edit_param_modal').modal('setting', {
      autofocus: false,
      onShow: function onShow() {
        $('#edit_param_modal input[name="display_key"]').val($val);
      },
      onApprove: function onApprove() {

        $display_key = $('#edit_param_modal input[name="display_key"]').val();

        $.ajax({
          type: "PUT",
          url: "/param/" + $id,
          data: { display_key: $display_key },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.delete_param_btn').click(function () {
    $id = $(this).closest('.param.item').data('paramid');

    $('#delete_param_modal').modal('setting', {
      autofocus: false,
      onApprove: function onApprove() {

        $.ajax({
          type: "DELETE",
          url: "/param/" + $id,
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $(document).on('click', '#params_list .param.item:not(.manage)', function (e) {
    if (e.target == this || $(e.target).hasClass('name') || $(e.target).hasClass('eye')) {
      $paramid = $(this).data('paramid');
      $catid = $(this).data('categoryid');
      $this = $(this);
      $this.find('.dimmer').addClass('active');
      if ($this.hasClass('active')) {
        $.ajax({
          type: "DELETE",
          url: "/category/parameter/" + $paramid,
          data: { category_id: $catid },
          success: function success() {
            $this.removeClass('active');
            $this.find('.dimmer').removeClass('active');
          }
        });
      } else {
        $.ajax({
          type: "POST",
          url: "/category/parameter/add",
          data: { parameter_id: $paramid, category_id: $catid },
          success: function success() {
            $this.addClass('active');
            $this.find('.dimmer').removeClass('active');
          }
        });
      }
    }
  });

  if ($('#admin_category_params_selection').length > 0) {
    $('.dropdown').dropdown({
      onAdd: function onAdd(addedValue, addedText, $addedChoice) {
        $catid = $('#category_image_div').data('categoryid');
        $.ajax({
          type: "POST",
          url: "/category/parameter/add",
          data: { parameter_id: addedValue, category_id: $catid },
          success: function success() {}
        });
      },
      onRemove: function onRemove(removedValue, removedText, $removedChoice) {
        $catid = $('#category_image_div').data('categoryid');
        $.ajax({
          type: "DELETE",
          url: "/category/parameter/" + removedValue,
          data: { category_id: $catid },
          success: function success() {}
        });
      }
    });
  }

  $('#admin_order_params_save').click(function () {
    $data = {};
    $data['min_order_price'] = $('input[name="min_order_price"]').val();
    $data['min_free_shipping_price'] = $('input[name="min_free_shipping_price"]').val();

    $.post('/set/config', $data, function () {});
  });

  $(document).on('click', '.delete_product_param', function () {
    $(this).closest('.row').remove();
  });

  $('#send_remider_btn').click(function () {
    $(this).addClass('loading');
  });

  $(document).on('click', '.delete_price_level_btn', function () {
    $(this).closest('.product_price_level').remove();
  });

  $('.delete_order_btn').click(function () {
    $orderid = $(this).closest('tr').data('order_id');

    $('#delete_order_modal').modal('setting', {

      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/order/" + $orderid,
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.close_order_btn').click(function () {
    $orderid = $(this).closest('tr').data('order_id');

    $('#change_order_modal').modal('setting', {

      onApprove: function onApprove() {
        $.ajax({
          type: "PUT",
          url: "/order/" + $orderid,
          data: { status_id: 5 },
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.delete_user_btn').click(function () {
    $userid = $(this).closest('tr').data('user_id');

    $('#delete_user_modal').modal('setting', {

      onApprove: function onApprove() {
        $.ajax({
          type: "DELETE",
          url: "/user/" + $userid,
          success: function success() {
            location.reload();
          }
        });
      }
    }).modal('show');
  });

  $('.order_change_status_btn').click(function () {
    $orderid = $('.order_detail').data('orderid');
    $status_id = $(this).data('statusid');

    if ($status_id == 0) {
      $('#change_order_modal').modal('setting', {

        onApprove: function onApprove() {
          $.ajax({
            type: "PUT",
            url: "/order/" + $orderid,
            data: { status_id: $status_id },
            success: function success() {
              location.reload();
            }
          });
        }
      }).modal('show');
    }

    if ($status_id == 1) {
      $('#change_order_modal_sent').modal('setting', {

        onApprove: function onApprove() {
          $.ajax({
            type: "PUT",
            url: "/order/" + $orderid,
            data: { status_id: $status_id, package_number: $('input[name="package_number"]').val() },
            success: function success() {
              location.reload();
            }
          });
        }
      }).modal('show');
    }

    if ($status_id == 4) {
      $('#change_order_modal_cancelled').modal('setting', {

        onApprove: function onApprove() {
          $.ajax({
            type: "PUT",
            url: "/order/" + $orderid,
            data: { status_id: $status_id, cancel_text: $('input[name="cancel_text"]').val() },
            success: function success() {
              location.reload();
            }
          });
        }
      }).modal('show');
    }
  });

  $('#main_search input').keyup(function (e) {
    if (e.which == 13) {
      location.replace('/search/' + $query);
    } else {
      $(document).unbind('ajaxStart');
      $query = $(this).val();
      $('.search_view_all_btn').attr('href', '/search/' + $query);
      $.ajax({
        type: "GET",
        url: "/api/search/" + $query,
        success: function success(data) {
          $('#search_results.desktop').show();
          $('#search_results.desktop').find('.products').html(data.products);
          $('#search_results.desktop').find('.users').html(data.users);
          $(document).bind('ajaxStart');
        }
      });
    }
  });

  $('body').mouseup(function (e) {
    var container = $("#search_results.desktop");

    // if the target of the click isn't the container nor a descendant of the container
    if (!container.is(e.target) && container.has(e.target).length === 0) {
      container.hide();
    }
  });

  var geocoder;
  var map;
  function initialize() {
    geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(-34.397, 150.644);
    var mapOptions = {
      zoom: 18,
      center: latlng
    };
    map = new google.maps.Map(document.getElementById('map'), mapOptions);
  }

  function codeAddress() {
    var address = $('#address_map').text();
    geocoder.geocode({ 'address': address }, function (results, status) {
      if (status == 'OK') {
        map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker({
          map: map,
          position: results[0].geometry.location
        });
      } else {
        alert('Geocode was not successful for the following reason: ' + status);
      }
    });
  }

  if ($('body').attr('id') == 'body_contact') {
    initialize();
    codeAddress();
  }

  /*
  if($('body').attr('id') == 'cart_shipping')
  {
  	 var placeSearch, autocomplete;
        var componentForm = {
          street_number: 'short_name',
          route: 'long_name',
          locality: 'long_name',
          administrative_area_level_1: 'short_name',
          country: 'long_name',
          postal_code: 'short_name'
        };
  
        function initAutocomplete() {
          // Create the autocomplete object, restricting the search to geographical
          // location types.
          autocomplete = new google.maps.places.Autocomplete(
              (document.getElementById('autocomplete')),
              {types: ['geocode']});
  
          // When the user selects an address from the dropdown, populate the address
          // fields in the form.
          autocomplete.addListener('place_changed', fillInAddress);
        }
  
        function fillInAddress() {
          // Get the place details from the autocomplete object.
          var place = autocomplete.getPlace();
  
          for (var component in componentForm) {
              $('.invoice_'+component).val('');
          }
  
          // Get each component of the address from the place details
          // and fill the corresponding field on the form.
          for (var i = 0; i < place.address_components.length; i++) {
            var addressType = place.address_components[i].types[0];
            if (componentForm[addressType]) {
              var val = place.address_components[i][componentForm[addressType]];
              console.log(addressType);
              $('.invoice_'+addressType).val(val);
            }
          }
        }
  
        // Bias the autocomplete object to the user's geographical location,
        // as supplied by the browser's 'navigator.geolocation' object.
        function geolocate() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              var geolocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              var circle = new google.maps.Circle({
                center: geolocation,
                radius: position.coords.accuracy
              });
              autocomplete.setBounds(circle.getBounds());
            });
          }
        }
   		initAutocomplete();
  
        $('#autocomplete').focus(function(){
        	geolocate();
        })
  }
  */

  tinymce.init({
    selector: '.richtext.editable',
    auto_focus: "mce_0",
    menubar: false,
    plugins: ['advlist autolink lists link image charmap print preview anchor textcolor', 'searchreplace visualblocks code fullscreen', 'insertdatetime media table contextmenu paste code help wordcount'],
    toolbar: 'fontselect | code | insert | undo redo |  formatselect | bold italic backcolor  | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
    init_instance_callback: function init_instance_callback(editor) {
      $('.text_files_list .item').click(function () {
        $path = $(this).data('content');
        $extension = $path.split('.').pop();
        $filename = $path.split('/').pop();

        if ($extension == 'jpg') {
          $content = "<img src='/" + $path + "' width='100'>";
        } else {
          $content = "<a href='" + $path + "'>" + $filename + "</a>";
        }

        editor.insertContent($content);
      });
    }
  });

  $('.text_save_btn').click(function () {
    $('.text_form').submit();
  });

  $('.page_texts_list .item').click(function () {
    $button = $(this);
    $pageid = $(this).data('pageid');
    $textid = $(this).data('textid');

    if (!$button.hasClass('active')) {
      $.ajax({
        type: "POST",
        url: "/page/" + $pageid + "/attach/" + $textid,
        success: function success(data) {
          $button.addClass('active');

          $.ajax({
            method: "GET",
            url: '/text/' + $textid,
            success: function success(data) {
              $('.page_preview').append(data);
            }
          });
        }
      });
    } else {
      $.ajax({
        type: "POST",
        url: "/page/" + $pageid + "/detach/" + $textid,
        success: function success(data) {
          $button.removeClass('active');

          $('.text_form[data-textid="' + $textid + '"]').remove();
        }
      });
    }
  });

  $('.copy_to_clipboard_btn').click(function () {

    var copyText = $(this).closest('.input').find('input');

    /* Select the text field */
    copyText.select();

    /* Copy the text inside the text field */
    document.execCommand("copy");

    $(this).closest('.button').toggleClass('teal green');
    $(this).toggleClass('copy checkmark');
  });

  function initRelatedSlider(speed) {

    $related_carousel = $('.related_products_carousel').flickity({
      cellAlign: 'left',
      contain: true,
      pageDots: false,
      prevNextButtons: false,
      imagesLoaded: true,
      autoPlay: speed
    });

    $related_carousel.on('staticClick.flickity', function (event, pointer, cellElement, cellIndex) {
      $link = $(cellElement).find('.p_anch').attr('href');

      if ($($(pointer)[0].target).hasClass('to_cart') == false && $($(pointer)[0].target).hasClass('icon') == false) {
        window.location.href = $link;
      }
    });
  }

  initRelatedSlider(parseInt($('#suggested_wrapper_speed').find('value').html()));

  $("#grid_wrapper").on('click', '.product.item', function (e) {
    $link = $(this).find('.p_anch').attr('href');
    if ($(e.target).hasClass('to_cart') == false && $(e.target).hasClass('icon') == false) {
      window.location.href = $link;
    }
  });

  var mobx = $.ModuloBox({
    mediaSelector: '.mobx',
    history: true,
    controls: ['zoom', 'play', 'fullScreen', 'download', 'share', 'close'],
    loop: 1
  });

  mobx.init();

  $('#product_main_wrapper .main').click(function (e) {
    e.preventDefault();
    $gallery = $('#product_main_wrapper').data('gallery');
    $index = $('#product_main_wrapper').data('index');
    mobx.open($gallery, $index);
    mobx.play();
  });

  $('.active_flag').click(function () {
    $item = $(this).closest('.item');
    $icon = $(this).find('i');
    $type = $(this).closest('.item').data('type');
    $id = $(this).closest('.item').data('id');
    $state = $(this).closest('.item').data('active');

    if ($state == 1) {
      $.ajax({
        type: "PUT",
        url: "/" + $type + "/set/" + $id,
        data: { active: 0 },
        success: function success(data) {
          $icon.toggleClass('red green');
          $item.data('active', 0);
        }
      });
    } else {
      $.ajax({
        type: "PUT",
        url: "/" + $type + "/set/" + $id,
        data: { active: 1 },
        success: function success(data) {
          $icon.toggleClass('red green');
          $item.data('active', 1);
        }
      });
    }
  });

  $('#filterbar.horizontal .item').each(function () {
    var $el = $(this);
    $el.popup({
      popup: '#cat_popup_' + $el.data('cat'),
      on: 'hover',
      hoverable: true,
      exclusive: true,
      position: 'bottom left',
      duration: 0,
      lastResort: 'bottom left'
    });
  });

  function setSetting($changes, $view) {
    var $load = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
    var $target = arguments[3];

    $data = {};

    $data['changes'] = $changes;
    $data['view'] = $view;

    $.ajax({
      type: "PUT",
      url: "/admin/page/setting/",
      data: $data,
      success: function success(data) {
        if ($load) {
          $('#page_preview').find('#' + $target).html(data);
        }
      }
    });
  }

  $('#suggested_wrapper_speed i').click(function () {
    $div = $(this).closest('#suggested_wrapper_speed');
    $this = $(this);
    $speed = parseInt($div.find('value').html());

    if ($this.hasClass('plus')) {
      $newSpeed = $speed + 100;
      initRelatedSlider($newSpeed);
      $div.find('value').html($newSpeed);
    } else {
      $newSpeed = $speed - 100;
      initRelatedSlider($newSpeed);
      $div.find('value').html($newSpeed);
    }

    $.ajax({
      type: "PUT",
      url: "/admin/setting/",
      data: { 'suggested_wrapper_speed': $newSpeed }
    });
  });

  $('.admin_page_settings').checkbox({
    onChecked: function onChecked() {
      $item = $(this).data('item');
      $target = $(this).data('target');
      $view = $(this).data('view');

      $changes = {};
      $changes[$item] = 1;

      setSetting($changes, $view, true, $target);
    },
    onUnchecked: function onUnchecked() {
      $item = $(this).data('item');
      $target = $(this).data('target');
      $view = $(this).data('view');

      $changes = {};
      $changes[$item] = 0;

      setSetting($changes, $view, true, $target);
    }
  });

  $('#cover_product_url').search({
    apiSettings: {
      url: '/api/products/search?query={query}'
    },
    fields: {
      results: 'results',
      title: 'url',
      image: '',
      action: '',
      actionText: '',
      actionURL: '',
      url: ''
    },
    onSelect: function onSelect(result, response) {
      $('#admin_add_cover_form').find('input[name="url"]').val(result.full_url);
    }
  }).unbind('ajaxStart');;

  $('#cover_category_url').search({
    apiSettings: {
      url: '/api/categories/search?query={query}'
    },
    fields: {
      results: 'results',
      title: 'full_url',
      image: '',
      action: '',
      actionText: '',
      actionURL: '',
      url: ''
    },
    onSelect: function onSelect(result, response) {
      $('#admin_add_cover_form').find('input[name="url"]').val(result.full_url);
    }
  }).unbind('ajaxStart');;

  $('#cover_other_url input').change(function () {
    $('#admin_add_cover_form').find('input[name="url"]').val($(this).val());
  });

  $('.catalogue_path_btn').click(function () {
    $('#catalogue_url_input').css('display', 'flex');
    $('.catalogue_ok_btn').css('display', 'inline-block');
    $('.catalogue_upload_btn').hide();
    $('.catalogue_path_btn').hide();
  });

  $('.sticker_path_btn').click(function () {
    $('#sticker_url_input').css('display', 'flex');
    $('.sticker_ok_btn').css('display', 'inline-block');
    $('.sticker_upload_btn').hide();
    $('.sticker_path_btn').hide();
  });

  $('.catalogue_ok_btn').click(function () {
    $path = $('#catalogue_url_input input').val();
    $.ajax({
      type: "POST",
      url: "/file",
      data: { type: 'catalogue', path: $path, do_not_upload: true },
      success: function success(data) {
        location.reload();
      }
    });
  });

  $('.sticker_ok_btn').click(function () {
    $path = $('#sticker_url_input input').val();
    $.ajax({
      type: "POST",
      url: "/sticker",
      data: { path: $path, do_not_upload: true },
      success: function success(data) {
        location.reload();
      }
    });
  });

  $('#xml_update_check_btn').click(function () {
    $url = $('#xml_url_input').val();
    $external = $('#xml_url_input').data('external');
    $(this).addClass('loading');

    $.ajax({
      type: "PUT",
      url: "/admin/eshop/postXmlUpdate/",
      data: { 'external': $external, 'url': $url },
      success: function success(data) {
        $('#xml_results').show();
        $('#xml_results').find('.new_categories_count value').text(data.changes.new_categories.length);
        $('#xml_results').find('.new_products_count value').text(data.changes.new_products.length);
        $('#xml_results').find('.removed_categories_count value').text(data.changes.removed_categories.length);
        $('#xml_results').find('.removed_products_count value').text(data.changes.removed_products);

        $('#xml_results').find('.new_categories_list .list').html(data.newCategories);
        $('#xml_results').find('.new_products_list .list').html(data.newProducts);

        $('#xml_results').find('.removed_categories_list .list').html(data.removedCategories);
        $('#xml_results').find('.removed_products_list .list').html(data.removedProducts);

        $('#xml_update_check_btn').removeClass('loading');
        $('#xml_update_confirm_btn').css('display', 'inline-block');
      }
    });
  });

  $('#edit_product_categories_input').dropdown({
    maxSelections: 10,
    fullTextSearch: true,
    onAdd: function onAdd(addedValue, addedText, $addedChoice) {
      console.log(addedValue);
    }
  });

  $('#add_banner_radioboxes').find('.checkbox:eq(0)').checkbox({
    onChecked: function onChecked() {
      $('#cover_category_url').show();
      $('#cover_product_url').hide();
      $('#cover_other_url').hide();
    }
  });

  $('#add_banner_radioboxes').find('.checkbox:eq(1)').checkbox({
    onChecked: function onChecked() {
      $('#cover_category_url').hide();
      $('#cover_product_url').show();
      $('#cover_other_url').hide();
    }
  });

  $('#add_banner_radioboxes').find('.checkbox:eq(2)').checkbox({
    onChecked: function onChecked() {
      $('#cover_category_url').hide();
      $('#cover_product_url').hide();
      $('#cover_other_url').show();
    }
  });

  $('.scroll_to_top').click(function () {
    $("html, body").animate({ scrollTop: 0 }, "fast");
  });

  $('#home_sales_div').on('click', '.right.icon', function () {
    $sales_carousel.flickity('next');
  }).on('click', '.left.icon', function () {
    $sales_carousel.flickity('previous');
  });

  $('#home_news_div').on('click', '.right.icon', function () {
    $news_carousel.flickity('next');
  }).on('click', '.left.icon', function () {
    $news_carousel.flickity('previous');
  });

  $('#cartproducts').on('click', 'i.qty', function () {
    $productid = $(this).closest('.product').data('productid');
    $cartid = $('.cart.content').data('cartid');
    $qty = $(this).closest('.actions').find('.cart_qty_input').val();

    if ($(this).hasClass('plus')) {
      $newqty = parseFloat($qty) + 1;
    } else {
      $newqty = parseFloat($qty) - 1;
    }

    $.ajax({
      type: "PUT",
      url: "/cart/" + $cartid + "/" + $productid,
      data: { qty: $newqty },
      success: function success() {
        location.reload();
      }
    });
  });

  $('#cartproducts').on('blur', '.cart_qty_input', function () {
    $productid = $(this).closest('.product').data('productid');
    $cartid = $('.cart.content').data('cartid');
    $qty = $(this).val();

    $.ajax({
      type: "PUT",
      url: "/cart/" + $cartid + "/" + $productid,
      data: { qty: $qty },
      success: function success() {
        location.reload();
      }
    });
  });

  $('#product_detail_translate_btn').click(function () {
    $productid = $('#product_main_wrapper').data('id');

    $.ajax({
      type: "PUT",
      url: "/product/" + $productid + '/translate',
      success: function success() {
        location.reload();
      }
    });
  });

  $('.pages_list .checkbox').checkbox({
    onChecked: function onChecked() {
      $pageid = $(this).closest('.item').data('id');
      $.ajax({
        type: "PUT",
        url: "/api/page/" + $pageid,
        data: { footer: 1 },
        success: function success() {
          location.reload();
        }
      });
    },
    onUnchecked: function onUnchecked() {
      $pageid = $(this).closest('.item').data('id');
      $.ajax({
        type: "PUT",
        url: "/api/page/" + $pageid,
        data: { footer: 0 },
        success: function success() {
          location.reload();
        }
      });
    }
  });

  $('#product_main_wrapper .sizes .size.active').click(function () {
    $code = $(this).data('code');
    $('#product_main_wrapper #code scode').text($code);

    $('#product_main_wrapper .sizes .size').removeClass('selected');
    $(this).addClass('selected');
  });

  $('#seo_wrapper .checkbox').checkbox({
    onChecked: function onChecked() {
      $id = $(this).closest('.item').data('id');
      $.ajax({
        type: "PUT",
        url: "/api/seo/tool/" + $id,
        data: { active: 1 },
        success: function success() {
          location.reload();
        }
      });
    },
    onUnchecked: function onUnchecked() {
      $id = $(this).closest('.item').data('id');
      $.ajax({
        type: "PUT",
        url: "/api/seo/tool/" + $id,
        data: { active: 0 },
        success: function success() {
          location.reload();
        }
      });
    }
  });

  $('#new_xml_field_btn').click(function () {
    $html = $('#seo_tool_profile_wrapper').find('.xml_field').html();
    $('#seo_tool_profile_wrapper .field_list').append($html);
  });

  $('#product_update_btn').click(function () {
    $id = $(this).data('id');
    $(this).addClass('loading disabled');
    $.ajax({
      type: "POST",
      url: "/api/product/" + $id + "/xmlupdate",
      success: function success(data) {
        location.reload();
        console.log(data);
      }
    });
  });

  /*
  
  $(document).unbind('keypress').on('keypress', '.msg_input', function(e) {
  	$this = $(this);
  	$text = $this.val();
  	$user = $this.closest('.chat_window').data('user');
  
  	if(e.which == 13) {
  	   	$.post('/chat/message', {'text':$text, 'user': $user}, function(data){
  	   		$this.val('');
  	    });
     	}
  });
  
  $(document).unbind('click').on('click', '.chat_window i.delete', function(e) {
  	$window = $(this).closest('.chat_window');
  	$window.hide();
  	$('.chat_icon.user').show();
  });
  
  if(Laravel.user.admin)
  {
  	// activate chat for users
  	$('.chat_icon.operator').click(function(){
  		$this=$(this);
  
  		if($this.hasClass('inactive'))
  		{
  			$.post('/chat/activate', {}, function(data){
  				$this.addClass('active').removeClass('inactive');
  			});
  		}
  		else
  		{
  			$.post('/chat/deactivate', {}, function(data){
  				$this.addClass('inactive').removeClass('active');
  			});	
  		}
  	})
  
  	//listen for all opened chats
  	Echo.private('chats').listen('InitChat', (e) => {
          Echo.channel('chat.'+e.data['user']).listen('MessageSent', (f) => {
  
  			$window = $('.chat_window[data-user="'+e.data['user']+'"]');
  
  			$exists = $window.length;
  
  			if($exists==0)
  			{
  				$.get('/chat/window/html',{user: e.data['user']}, function(data){
  					$('.chat_windows').prepend(data);
  					$window = $('.chat_window[data-user="'+e.data['user']+'"]');
  					$window.show();
  					if(f.data['sender'] == Laravel.user.id)
  					{
  						$window.find('.msgs').append('<div class="msg own">'+f.data['text']+'</div>');
  					}
  					else
  					{
  						$window.find('.msgs').append('<div class="msg">'+f.data['text']+'</div>');
  					}
  				})
  			}
  			else
  			{
  				$window = $('.chat_window[data-user="'+e.data['user']+'"]');
  				$window.show();
  				if(f.data['sender'] == Laravel.user.id)
  				{
  					$window.find('.msgs').append('<div class="msg own">'+f.data['text']+'</div>');
  				}
  				else
  				{
  					$window.find('.msgs').append('<div class="msg">'+f.data['text']+'</div>');
  				}
  			}
  
  
          }) 
      });
  }
  else
  {
  	// init chat on click
  	$('.chat_icon.user').click(function(){
  		$this = $(this);
  		$this.hide();
  
  		if(!$this.hasClass('initiated'))
  		{
  			$.post('/chat/init', {'user':Laravel.user.id}, function(data){
  				$('.chat_window').show();
  				$this.addClass('initiated');
  			});
  		}
  		else
  		{
  			$('.chat_window').show();
  		}
  	})
  
  
  	Echo.channel('chat.'+Laravel.user.id).listen('MessageSent', (e) => {
  		$window = $('.chat_window[data-user="'+e.data['user']+'"]');
  		
  		if(e.data['sender'] == Laravel.user.id)
  		{
  			$window.find('.msgs').append('<div class="msg own">'+e.data['text']+'</div>');
  		}
  		else
  		{
  			$window.find('.msgs').append('<div class="msg">'+e.data['text']+'</div>');
  		}
  	})
  
  	Echo.channel('chats').listen('ActivateChat', (e) => {
  		$('.chat_icon.user').show();
  	});
  
  	Echo.channel('chats').listen('DeactivateChat', (e) => {
  		$('.chat_icon.user').hide();
  	});
  }
  
  
  
  */
});

$(document).scroll(function () {
  var y = $(this).scrollTop();
  if (y > 800) {
    $('.scroll_to_top').fadeIn();
  } else {
    $('.scroll_to_top').fadeOut();
  }
});

var sticky;
var div;

$(document).on("scroll", function () {
  if ($(document).scrollTop() > 100) {
    $("#header.shrinkable").addClass("shrink");
  } else {
    $("#header.shrinkable").removeClass("shrink");
  }
});

$(window).on('load', function () {
  if ($('.sticky_div').length) {
    sticky = $('.sticky_div').offset().top - 20;
    window.onscroll = function () {
      myFunction();
    };
  }

  function myFunction() {
    div = $('.sticky_div');

    if (window.pageYOffset >= sticky) {
      div.addClass("stickyy");
      $('#product_content #filterbar').css('position', 'fixed');
    } else {
      div.removeClass("stickyy");
      $('#product_content #filterbar').css('position', 'absolute');
    }
  }
});

/*!
 * # Semantic UI 2.4.2 - Checkbox
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */

;(function ($, window, document, undefined) {

  'use strict';

  window = typeof window != 'undefined' && window.Math == Math ? window : typeof self != 'undefined' && self.Math == Math ? self : Function('return this')();

  $.fn.checkbox = function (parameters) {
    var $allModules = $(this),
        moduleSelector = $allModules.selector || '',
        time = new Date().getTime(),
        performance = [],
        query = arguments[0],
        methodInvoked = typeof query == 'string',
        queryArguments = [].slice.call(arguments, 1),
        returnedValue;

    $allModules.each(function () {
      var settings = $.extend(true, {}, $.fn.checkbox.settings, parameters),
          className = settings.className,
          namespace = settings.namespace,
          selector = settings.selector,
          error = settings.error,
          eventNamespace = '.' + namespace,
          moduleNamespace = 'module-' + namespace,
          $module = $(this),
          $label = $(this).children(selector.label),
          $input = $(this).children(selector.input),
          input = $input[0],
          _initialLoad = false,
          shortcutPressed = false,
          instance = $module.data(moduleNamespace),
          observer,
          element = this,
          module;

      module = {

        initialize: function initialize() {
          module.verbose('Initializing checkbox', settings);

          module.create.label();
          module.bind.events();

          module.set.tabbable();
          module.hide.input();

          module.observeChanges();
          module.instantiate();
          module.setup();
        },

        instantiate: function instantiate() {
          module.verbose('Storing instance of module', module);
          instance = module;
          $module.data(moduleNamespace, module);
        },

        destroy: function destroy() {
          module.verbose('Destroying module');
          module.unbind.events();
          module.show.input();
          $module.removeData(moduleNamespace);
        },

        fix: {
          reference: function reference() {
            if ($module.is(selector.input)) {
              module.debug('Behavior called on <input> adjusting invoked element');
              $module = $module.closest(selector.checkbox);
              module.refresh();
            }
          }
        },

        setup: function setup() {
          module.set.initialLoad();
          if (module.is.indeterminate()) {
            module.debug('Initial value is indeterminate');
            module.indeterminate();
          } else if (module.is.checked()) {
            module.debug('Initial value is checked');
            module.check();
          } else {
            module.debug('Initial value is unchecked');
            module.uncheck();
          }
          module.remove.initialLoad();
        },

        refresh: function refresh() {
          $label = $module.children(selector.label);
          $input = $module.children(selector.input);
          input = $input[0];
        },

        hide: {
          input: function input() {
            module.verbose('Modifying <input> z-index to be unselectable');
            $input.addClass(className.hidden);
          }
        },
        show: {
          input: function input() {
            module.verbose('Modifying <input> z-index to be selectable');
            $input.removeClass(className.hidden);
          }
        },

        observeChanges: function observeChanges() {
          if ('MutationObserver' in window) {
            observer = new MutationObserver(function (mutations) {
              module.debug('DOM tree modified, updating selector cache');
              module.refresh();
            });
            observer.observe(element, {
              childList: true,
              subtree: true
            });
            module.debug('Setting up mutation observer', observer);
          }
        },

        attachEvents: function attachEvents(selector, event) {
          var $element = $(selector);
          event = $.isFunction(module[event]) ? module[event] : module.toggle;
          if ($element.length > 0) {
            module.debug('Attaching checkbox events to element', selector, event);
            $element.on('click' + eventNamespace, event);
          } else {
            module.error(error.notFound);
          }
        },

        event: {
          click: function click(event) {
            var $target = $(event.target);
            if ($target.is(selector.input)) {
              module.verbose('Using default check action on initialized checkbox');
              return;
            }
            if ($target.is(selector.link)) {
              module.debug('Clicking link inside checkbox, skipping toggle');
              return;
            }
            module.toggle();
            $input.focus();
            event.preventDefault();
          },
          keydown: function keydown(event) {
            var key = event.which,
                keyCode = {
              enter: 13,
              space: 32,
              escape: 27
            };
            if (key == keyCode.escape) {
              module.verbose('Escape key pressed blurring field');
              $input.blur();
              shortcutPressed = true;
            } else if (!event.ctrlKey && (key == keyCode.space || key == keyCode.enter)) {
              module.verbose('Enter/space key pressed, toggling checkbox');
              module.toggle();
              shortcutPressed = true;
            } else {
              shortcutPressed = false;
            }
          },
          keyup: function keyup(event) {
            if (shortcutPressed) {
              event.preventDefault();
            }
          }
        },

        check: function check() {
          if (!module.should.allowCheck()) {
            return;
          }
          module.debug('Checking checkbox', $input);
          module.set.checked();
          if (!module.should.ignoreCallbacks()) {
            settings.onChecked.call(input);
            settings.onChange.call(input);
          }
        },

        uncheck: function uncheck() {
          if (!module.should.allowUncheck()) {
            return;
          }
          module.debug('Unchecking checkbox');
          module.set.unchecked();
          if (!module.should.ignoreCallbacks()) {
            settings.onUnchecked.call(input);
            settings.onChange.call(input);
          }
        },

        indeterminate: function indeterminate() {
          if (module.should.allowIndeterminate()) {
            module.debug('Checkbox is already indeterminate');
            return;
          }
          module.debug('Making checkbox indeterminate');
          module.set.indeterminate();
          if (!module.should.ignoreCallbacks()) {
            settings.onIndeterminate.call(input);
            settings.onChange.call(input);
          }
        },

        determinate: function determinate() {
          if (module.should.allowDeterminate()) {
            module.debug('Checkbox is already determinate');
            return;
          }
          module.debug('Making checkbox determinate');
          module.set.determinate();
          if (!module.should.ignoreCallbacks()) {
            settings.onDeterminate.call(input);
            settings.onChange.call(input);
          }
        },

        enable: function enable() {
          if (module.is.enabled()) {
            module.debug('Checkbox is already enabled');
            return;
          }
          module.debug('Enabling checkbox');
          module.set.enabled();
          settings.onEnable.call(input);
          // preserve legacy callbacks
          settings.onEnabled.call(input);
        },

        disable: function disable() {
          if (module.is.disabled()) {
            module.debug('Checkbox is already disabled');
            return;
          }
          module.debug('Disabling checkbox');
          module.set.disabled();
          settings.onDisable.call(input);
          // preserve legacy callbacks
          settings.onDisabled.call(input);
        },

        get: {
          radios: function radios() {
            var name = module.get.name();
            return $('input[name="' + name + '"]').closest(selector.checkbox);
          },
          otherRadios: function otherRadios() {
            return module.get.radios().not($module);
          },
          name: function name() {
            return $input.attr('name');
          }
        },

        is: {
          initialLoad: function initialLoad() {
            return _initialLoad;
          },
          radio: function radio() {
            return $input.hasClass(className.radio) || $input.attr('type') == 'radio';
          },
          indeterminate: function indeterminate() {
            return $input.prop('indeterminate') !== undefined && $input.prop('indeterminate');
          },
          checked: function checked() {
            return $input.prop('checked') !== undefined && $input.prop('checked');
          },
          disabled: function disabled() {
            return $input.prop('disabled') !== undefined && $input.prop('disabled');
          },
          enabled: function enabled() {
            return !module.is.disabled();
          },
          determinate: function determinate() {
            return !module.is.indeterminate();
          },
          unchecked: function unchecked() {
            return !module.is.checked();
          }
        },

        should: {
          allowCheck: function allowCheck() {
            if (module.is.determinate() && module.is.checked() && !module.should.forceCallbacks()) {
              module.debug('Should not allow check, checkbox is already checked');
              return false;
            }
            if (settings.beforeChecked.apply(input) === false) {
              module.debug('Should not allow check, beforeChecked cancelled');
              return false;
            }
            return true;
          },
          allowUncheck: function allowUncheck() {
            if (module.is.determinate() && module.is.unchecked() && !module.should.forceCallbacks()) {
              module.debug('Should not allow uncheck, checkbox is already unchecked');
              return false;
            }
            if (settings.beforeUnchecked.apply(input) === false) {
              module.debug('Should not allow uncheck, beforeUnchecked cancelled');
              return false;
            }
            return true;
          },
          allowIndeterminate: function allowIndeterminate() {
            if (module.is.indeterminate() && !module.should.forceCallbacks()) {
              module.debug('Should not allow indeterminate, checkbox is already indeterminate');
              return false;
            }
            if (settings.beforeIndeterminate.apply(input) === false) {
              module.debug('Should not allow indeterminate, beforeIndeterminate cancelled');
              return false;
            }
            return true;
          },
          allowDeterminate: function allowDeterminate() {
            if (module.is.determinate() && !module.should.forceCallbacks()) {
              module.debug('Should not allow determinate, checkbox is already determinate');
              return false;
            }
            if (settings.beforeDeterminate.apply(input) === false) {
              module.debug('Should not allow determinate, beforeDeterminate cancelled');
              return false;
            }
            return true;
          },
          forceCallbacks: function forceCallbacks() {
            return module.is.initialLoad() && settings.fireOnInit;
          },
          ignoreCallbacks: function ignoreCallbacks() {
            return _initialLoad && !settings.fireOnInit;
          }
        },

        can: {
          change: function change() {
            return !($module.hasClass(className.disabled) || $module.hasClass(className.readOnly) || $input.prop('disabled') || $input.prop('readonly'));
          },
          uncheck: function uncheck() {
            return typeof settings.uncheckable === 'boolean' ? settings.uncheckable : !module.is.radio();
          }
        },

        set: {
          initialLoad: function initialLoad() {
            _initialLoad = true;
          },
          checked: function checked() {
            module.verbose('Setting class to checked');
            $module.removeClass(className.indeterminate).addClass(className.checked);
            if (module.is.radio()) {
              module.uncheckOthers();
            }
            if (!module.is.indeterminate() && module.is.checked()) {
              module.debug('Input is already checked, skipping input property change');
              return;
            }
            module.verbose('Setting state to checked', input);
            $input.prop('indeterminate', false).prop('checked', true);
            module.trigger.change();
          },
          unchecked: function unchecked() {
            module.verbose('Removing checked class');
            $module.removeClass(className.indeterminate).removeClass(className.checked);
            if (!module.is.indeterminate() && module.is.unchecked()) {
              module.debug('Input is already unchecked');
              return;
            }
            module.debug('Setting state to unchecked');
            $input.prop('indeterminate', false).prop('checked', false);
            module.trigger.change();
          },
          indeterminate: function indeterminate() {
            module.verbose('Setting class to indeterminate');
            $module.addClass(className.indeterminate);
            if (module.is.indeterminate()) {
              module.debug('Input is already indeterminate, skipping input property change');
              return;
            }
            module.debug('Setting state to indeterminate');
            $input.prop('indeterminate', true);
            module.trigger.change();
          },
          determinate: function determinate() {
            module.verbose('Removing indeterminate class');
            $module.removeClass(className.indeterminate);
            if (module.is.determinate()) {
              module.debug('Input is already determinate, skipping input property change');
              return;
            }
            module.debug('Setting state to determinate');
            $input.prop('indeterminate', false);
          },
          disabled: function disabled() {
            module.verbose('Setting class to disabled');
            $module.addClass(className.disabled);
            if (module.is.disabled()) {
              module.debug('Input is already disabled, skipping input property change');
              return;
            }
            module.debug('Setting state to disabled');
            $input.prop('disabled', 'disabled');
            module.trigger.change();
          },
          enabled: function enabled() {
            module.verbose('Removing disabled class');
            $module.removeClass(className.disabled);
            if (module.is.enabled()) {
              module.debug('Input is already enabled, skipping input property change');
              return;
            }
            module.debug('Setting state to enabled');
            $input.prop('disabled', false);
            module.trigger.change();
          },
          tabbable: function tabbable() {
            module.verbose('Adding tabindex to checkbox');
            if ($input.attr('tabindex') === undefined) {
              $input.attr('tabindex', 0);
            }
          }
        },

        remove: {
          initialLoad: function initialLoad() {
            _initialLoad = false;
          }
        },

        trigger: {
          change: function change() {
            var events = document.createEvent('HTMLEvents'),
                inputElement = $input[0];
            if (inputElement) {
              module.verbose('Triggering native change event');
              events.initEvent('change', true, false);
              inputElement.dispatchEvent(events);
            }
          }
        },

        create: {
          label: function label() {
            if ($input.prevAll(selector.label).length > 0) {
              $input.prev(selector.label).detach().insertAfter($input);
              module.debug('Moving existing label', $label);
            } else if (!module.has.label()) {
              $label = $('<label>').insertAfter($input);
              module.debug('Creating label', $label);
            }
          }
        },

        has: {
          label: function label() {
            return $label.length > 0;
          }
        },

        bind: {
          events: function events() {
            module.verbose('Attaching checkbox events');
            $module.on('click' + eventNamespace, module.event.click).on('keydown' + eventNamespace, selector.input, module.event.keydown).on('keyup' + eventNamespace, selector.input, module.event.keyup);
          }
        },

        unbind: {
          events: function events() {
            module.debug('Removing events');
            $module.off(eventNamespace);
          }
        },

        uncheckOthers: function uncheckOthers() {
          var $radios = module.get.otherRadios();
          module.debug('Unchecking other radios', $radios);
          $radios.removeClass(className.checked);
        },

        toggle: function toggle() {
          if (!module.can.change()) {
            if (!module.is.radio()) {
              module.debug('Checkbox is read-only or disabled, ignoring toggle');
            }
            return;
          }
          if (module.is.indeterminate() || module.is.unchecked()) {
            module.debug('Currently unchecked');
            module.check();
          } else if (module.is.checked() && module.can.uncheck()) {
            module.debug('Currently checked');
            module.uncheck();
          }
        },
        setting: function setting(name, value) {
          module.debug('Changing setting', name, value);
          if ($.isPlainObject(name)) {
            $.extend(true, settings, name);
          } else if (value !== undefined) {
            if ($.isPlainObject(settings[name])) {
              $.extend(true, settings[name], value);
            } else {
              settings[name] = value;
            }
          } else {
            return settings[name];
          }
        },
        internal: function internal(name, value) {
          if ($.isPlainObject(name)) {
            $.extend(true, module, name);
          } else if (value !== undefined) {
            module[name] = value;
          } else {
            return module[name];
          }
        },
        debug: function debug() {
          if (!settings.silent && settings.debug) {
            if (settings.performance) {
              module.performance.log(arguments);
            } else {
              module.debug = Function.prototype.bind.call(console.info, console, settings.name + ':');
              module.debug.apply(console, arguments);
            }
          }
        },
        verbose: function verbose() {
          if (!settings.silent && settings.verbose && settings.debug) {
            if (settings.performance) {
              module.performance.log(arguments);
            } else {
              module.verbose = Function.prototype.bind.call(console.info, console, settings.name + ':');
              module.verbose.apply(console, arguments);
            }
          }
        },
        error: function error() {
          if (!settings.silent) {
            module.error = Function.prototype.bind.call(console.error, console, settings.name + ':');
            module.error.apply(console, arguments);
          }
        },
        performance: {
          log: function log(message) {
            var currentTime, executionTime, previousTime;
            if (settings.performance) {
              currentTime = new Date().getTime();
              previousTime = time || currentTime;
              executionTime = currentTime - previousTime;
              time = currentTime;
              performance.push({
                'Name': message[0],
                'Arguments': [].slice.call(message, 1) || '',
                'Element': element,
                'Execution Time': executionTime
              });
            }
            clearTimeout(module.performance.timer);
            module.performance.timer = setTimeout(module.performance.display, 500);
          },
          display: function display() {
            var title = settings.name + ':',
                totalTime = 0;
            time = false;
            clearTimeout(module.performance.timer);
            $.each(performance, function (index, data) {
              totalTime += data['Execution Time'];
            });
            title += ' ' + totalTime + 'ms';
            if (moduleSelector) {
              title += ' \'' + moduleSelector + '\'';
            }
            if ((console.group !== undefined || console.table !== undefined) && performance.length > 0) {
              console.groupCollapsed(title);
              if (console.table) {
                console.table(performance);
              } else {
                $.each(performance, function (index, data) {
                  console.log(data['Name'] + ': ' + data['Execution Time'] + 'ms');
                });
              }
              console.groupEnd();
            }
            performance = [];
          }
        },
        invoke: function invoke(query, passedArguments, context) {
          var object = instance,
              maxDepth,
              found,
              response;
          passedArguments = passedArguments || queryArguments;
          context = element || context;
          if (typeof query == 'string' && object !== undefined) {
            query = query.split(/[\. ]/);
            maxDepth = query.length - 1;
            $.each(query, function (depth, value) {
              var camelCaseValue = depth != maxDepth ? value + query[depth + 1].charAt(0).toUpperCase() + query[depth + 1].slice(1) : query;
              if ($.isPlainObject(object[camelCaseValue]) && depth != maxDepth) {
                object = object[camelCaseValue];
              } else if (object[camelCaseValue] !== undefined) {
                found = object[camelCaseValue];
                return false;
              } else if ($.isPlainObject(object[value]) && depth != maxDepth) {
                object = object[value];
              } else if (object[value] !== undefined) {
                found = object[value];
                return false;
              } else {
                module.error(error.method, query);
                return false;
              }
            });
          }
          if ($.isFunction(found)) {
            response = found.apply(context, passedArguments);
          } else if (found !== undefined) {
            response = found;
          }
          if ($.isArray(returnedValue)) {
            returnedValue.push(response);
          } else if (returnedValue !== undefined) {
            returnedValue = [returnedValue, response];
          } else if (response !== undefined) {
            returnedValue = response;
          }
          return found;
        }
      };

      if (methodInvoked) {
        if (instance === undefined) {
          module.initialize();
        }
        module.invoke(query);
      } else {
        if (instance !== undefined) {
          instance.invoke('destroy');
        }
        module.initialize();
      }
    });

    return returnedValue !== undefined ? returnedValue : this;
  };

  $.fn.checkbox.settings = {

    name: 'Checkbox',
    namespace: 'checkbox',

    silent: false,
    debug: false,
    verbose: true,
    performance: true,

    // delegated event context
    uncheckable: 'auto',
    fireOnInit: false,

    onChange: function onChange() {},

    beforeChecked: function beforeChecked() {},
    beforeUnchecked: function beforeUnchecked() {},
    beforeDeterminate: function beforeDeterminate() {},
    beforeIndeterminate: function beforeIndeterminate() {},

    onChecked: function onChecked() {},
    onUnchecked: function onUnchecked() {},

    onDeterminate: function onDeterminate() {},
    onIndeterminate: function onIndeterminate() {},

    onEnable: function onEnable() {},
    onDisable: function onDisable() {},

    // preserve misspelled callbacks (will be removed in 3.0)
    onEnabled: function onEnabled() {},
    onDisabled: function onDisabled() {},

    className: {
      checked: 'checked',
      indeterminate: 'indeterminate',
      disabled: 'disabled',
      hidden: 'hidden',
      radio: 'radio',
      readOnly: 'read-only'
    },

    error: {
      method: 'The method you called is not defined'
    },

    selector: {
      checkbox: '.ui.checkbox',
      label: 'label, .box',
      input: 'input[type="checkbox"], input[type="radio"]',
      link: 'a[href]'
    }

  };
})(jQuery, window, document);

/*!
 * # Semantic UI 2.4.2 - Popup
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */

;(function ($, window, document, undefined) {

  'use strict';

  window = typeof window != 'undefined' && window.Math == Math ? window : typeof self != 'undefined' && self.Math == Math ? self : Function('return this')();

  $.fn.popup = function (parameters) {
    var $allModules = $(this),
        $document = $(document),
        $window = $(window),
        $body = $('body'),
        moduleSelector = $allModules.selector || '',
        hasTouch = true,
        time = new Date().getTime(),
        performance = [],
        query = arguments[0],
        methodInvoked = typeof query == 'string',
        queryArguments = [].slice.call(arguments, 1),
        returnedValue;
    $allModules.each(function () {
      var settings = $.isPlainObject(parameters) ? $.extend(true, {}, $.fn.popup.settings, parameters) : $.extend({}, $.fn.popup.settings),
          selector = settings.selector,
          className = settings.className,
          error = settings.error,
          metadata = settings.metadata,
          namespace = settings.namespace,
          eventNamespace = '.' + settings.namespace,
          moduleNamespace = 'module-' + namespace,
          $module = $(this),
          $context = $(settings.context),
          $scrollContext = $(settings.scrollContext),
          $boundary = $(settings.boundary),
          $target = settings.target ? $(settings.target) : $module,
          $popup,
          $offsetParent,
          searchDepth = 0,
          triedPositions = false,
          openedWithTouch = false,
          element = this,
          instance = $module.data(moduleNamespace),
          documentObserver,
          elementNamespace,
          _id,
          module;

      module = {

        // binds events
        initialize: function initialize() {
          module.debug('Initializing', $module);
          module.createID();
          module.bind.events();
          if (!module.exists() && settings.preserve) {
            module.create();
          }
          if (settings.observeChanges) {
            module.observeChanges();
          }
          module.instantiate();
        },

        instantiate: function instantiate() {
          module.verbose('Storing instance', module);
          instance = module;
          $module.data(moduleNamespace, instance);
        },

        observeChanges: function observeChanges() {
          if ('MutationObserver' in window) {
            documentObserver = new MutationObserver(module.event.documentChanged);
            documentObserver.observe(document, {
              childList: true,
              subtree: true
            });
            module.debug('Setting up mutation observer', documentObserver);
          }
        },

        refresh: function refresh() {
          if (settings.popup) {
            $popup = $(settings.popup).eq(0);
          } else {
            if (settings.inline) {
              $popup = $target.nextAll(selector.popup).eq(0);
              settings.popup = $popup;
            }
          }
          if (settings.popup) {
            $popup.addClass(className.loading);
            $offsetParent = module.get.offsetParent();
            $popup.removeClass(className.loading);
            if (settings.movePopup && module.has.popup() && module.get.offsetParent($popup)[0] !== $offsetParent[0]) {
              module.debug('Moving popup to the same offset parent as target');
              $popup.detach().appendTo($offsetParent);
            }
          } else {
            $offsetParent = settings.inline ? module.get.offsetParent($target) : module.has.popup() ? module.get.offsetParent($popup) : $body;
          }
          if ($offsetParent.is('html') && $offsetParent[0] !== $body[0]) {
            module.debug('Setting page as offset parent');
            $offsetParent = $body;
          }
          if (module.get.variation()) {
            module.set.variation();
          }
        },

        reposition: function reposition() {
          module.refresh();
          module.set.position();
        },

        destroy: function destroy() {
          module.debug('Destroying previous module');
          if (documentObserver) {
            documentObserver.disconnect();
          }
          // remove element only if was created dynamically
          if ($popup && !settings.preserve) {
            module.removePopup();
          }
          // clear all timeouts
          clearTimeout(module.hideTimer);
          clearTimeout(module.showTimer);
          // remove events
          module.unbind.close();
          module.unbind.events();
          $module.removeData(moduleNamespace);
        },

        event: {
          start: function start(event) {
            var delay = $.isPlainObject(settings.delay) ? settings.delay.show : settings.delay;
            clearTimeout(module.hideTimer);
            if (!openedWithTouch) {
              module.showTimer = setTimeout(module.show, delay);
            }
          },
          end: function end() {
            var delay = $.isPlainObject(settings.delay) ? settings.delay.hide : settings.delay;
            clearTimeout(module.showTimer);
            module.hideTimer = setTimeout(module.hide, delay);
          },
          touchstart: function touchstart(event) {
            openedWithTouch = true;
            module.show();
          },
          resize: function resize() {
            if (module.is.visible()) {
              module.set.position();
            }
          },
          documentChanged: function documentChanged(mutations) {
            [].forEach.call(mutations, function (mutation) {
              if (mutation.removedNodes) {
                [].forEach.call(mutation.removedNodes, function (node) {
                  if (node == element || $(node).find(element).length > 0) {
                    module.debug('Element removed from DOM, tearing down events');
                    module.destroy();
                  }
                });
              }
            });
          },
          hideGracefully: function hideGracefully(event) {
            var $target = $(event.target),
                isInDOM = $.contains(document.documentElement, event.target),
                inPopup = $target.closest(selector.popup).length > 0;
            // don't close on clicks inside popup
            if (event && !inPopup && isInDOM) {
              module.debug('Click occurred outside popup hiding popup');
              module.hide();
            } else {
              module.debug('Click was inside popup, keeping popup open');
            }
          }
        },

        // generates popup html from metadata
        create: function create() {
          var html = module.get.html(),
              title = module.get.title(),
              content = module.get.content();

          if (html || content || title) {
            module.debug('Creating pop-up html');
            if (!html) {
              html = settings.templates.popup({
                title: title,
                content: content
              });
            }
            $popup = $('<div/>').addClass(className.popup).data(metadata.activator, $module).html(html);
            if (settings.inline) {
              module.verbose('Inserting popup element inline', $popup);
              $popup.insertAfter($module);
            } else {
              module.verbose('Appending popup element to body', $popup);
              $popup.appendTo($context);
            }
            module.refresh();
            module.set.variation();

            if (settings.hoverable) {
              module.bind.popup();
            }
            settings.onCreate.call($popup, element);
          } else if ($target.next(selector.popup).length !== 0) {
            module.verbose('Pre-existing popup found');
            settings.inline = true;
            settings.popup = $target.next(selector.popup).data(metadata.activator, $module);
            module.refresh();
            if (settings.hoverable) {
              module.bind.popup();
            }
          } else if (settings.popup) {
            $(settings.popup).data(metadata.activator, $module);
            module.verbose('Used popup specified in settings');
            module.refresh();
            if (settings.hoverable) {
              module.bind.popup();
            }
          } else {
            module.debug('No content specified skipping display', element);
          }
        },

        createID: function createID() {
          _id = (Math.random().toString(16) + '000000000').substr(2, 8);
          elementNamespace = '.' + _id;
          module.verbose('Creating unique id for element', _id);
        },

        // determines popup state
        toggle: function toggle() {
          module.debug('Toggling pop-up');
          if (module.is.hidden()) {
            module.debug('Popup is hidden, showing pop-up');
            module.unbind.close();
            module.show();
          } else {
            module.debug('Popup is visible, hiding pop-up');
            module.hide();
          }
        },

        show: function show(callback) {
          callback = callback || function () {};
          module.debug('Showing pop-up', settings.transition);
          if (module.is.hidden() && !(module.is.active() && module.is.dropdown())) {
            if (!module.exists()) {
              module.create();
            }
            if (settings.onShow.call($popup, element) === false) {
              module.debug('onShow callback returned false, cancelling popup animation');
              return;
            } else if (!settings.preserve && !settings.popup) {
              module.refresh();
            }
            if ($popup && module.set.position()) {
              module.save.conditions();
              if (settings.exclusive) {
                module.hideAll();
              }
              module.animate.show(callback);
            }
          }
        },

        hide: function hide(callback) {
          callback = callback || function () {};
          if (module.is.visible() || module.is.animating()) {
            if (settings.onHide.call($popup, element) === false) {
              module.debug('onHide callback returned false, cancelling popup animation');
              return;
            }
            module.remove.visible();
            module.unbind.close();
            module.restore.conditions();
            module.animate.hide(callback);
          }
        },

        hideAll: function hideAll() {
          $(selector.popup).filter('.' + className.popupVisible).each(function () {
            $(this).data(metadata.activator).popup('hide');
          });
        },
        exists: function exists() {
          if (!$popup) {
            return false;
          }
          if (settings.inline || settings.popup) {
            return module.has.popup();
          } else {
            return $popup.closest($context).length >= 1 ? true : false;
          }
        },

        removePopup: function removePopup() {
          if (module.has.popup() && !settings.popup) {
            module.debug('Removing popup', $popup);
            $popup.remove();
            $popup = undefined;
            settings.onRemove.call($popup, element);
          }
        },

        save: {
          conditions: function conditions() {
            module.cache = {
              title: $module.attr('title')
            };
            if (module.cache.title) {
              $module.removeAttr('title');
            }
            module.verbose('Saving original attributes', module.cache.title);
          }
        },
        restore: {
          conditions: function conditions() {
            if (module.cache && module.cache.title) {
              $module.attr('title', module.cache.title);
              module.verbose('Restoring original attributes', module.cache.title);
            }
            return true;
          }
        },
        supports: {
          svg: function svg() {
            return typeof SVGGraphicsElement === 'undefined';
          }
        },
        animate: {
          show: function show(callback) {
            callback = $.isFunction(callback) ? callback : function () {};
            if (settings.transition && $.fn.transition !== undefined && $module.transition('is supported')) {
              module.set.visible();
              $popup.transition({
                animation: settings.transition + ' in',
                queue: false,
                debug: settings.debug,
                verbose: settings.verbose,
                duration: settings.duration,
                onComplete: function onComplete() {
                  module.bind.close();
                  callback.call($popup, element);
                  settings.onVisible.call($popup, element);
                }
              });
            } else {
              module.error(error.noTransition);
            }
          },
          hide: function hide(callback) {
            callback = $.isFunction(callback) ? callback : function () {};
            module.debug('Hiding pop-up');
            if (settings.onHide.call($popup, element) === false) {
              module.debug('onHide callback returned false, cancelling popup animation');
              return;
            }
            if (settings.transition && $.fn.transition !== undefined && $module.transition('is supported')) {
              $popup.transition({
                animation: settings.transition + ' out',
                queue: false,
                duration: settings.duration,
                debug: settings.debug,
                verbose: settings.verbose,
                onComplete: function onComplete() {
                  module.reset();
                  callback.call($popup, element);
                  settings.onHidden.call($popup, element);
                }
              });
            } else {
              module.error(error.noTransition);
            }
          }
        },

        change: {
          content: function content(html) {
            $popup.html(html);
          }
        },

        get: {
          html: function html() {
            $module.removeData(metadata.html);
            return $module.data(metadata.html) || settings.html;
          },
          title: function title() {
            $module.removeData(metadata.title);
            return $module.data(metadata.title) || settings.title;
          },
          content: function content() {
            $module.removeData(metadata.content);
            return $module.data(metadata.content) || settings.content || $module.attr('title');
          },
          variation: function variation() {
            $module.removeData(metadata.variation);
            return $module.data(metadata.variation) || settings.variation;
          },
          popup: function popup() {
            return $popup;
          },
          popupOffset: function popupOffset() {
            return $popup.offset();
          },
          calculations: function calculations() {
            var $popupOffsetParent = module.get.offsetParent($popup),
                targetElement = $target[0],
                isWindow = $boundary[0] == window,
                targetPosition = settings.inline || settings.popup && settings.movePopup ? $target.position() : $target.offset(),
                screenPosition = isWindow ? { top: 0, left: 0 } : $boundary.offset(),
                calculations = {},
                scroll = isWindow ? { top: $window.scrollTop(), left: $window.scrollLeft() } : { top: 0, left: 0 },
                screen;
            calculations = {
              // element which is launching popup
              target: {
                element: $target[0],
                width: $target.outerWidth(),
                height: $target.outerHeight(),
                top: targetPosition.top,
                left: targetPosition.left,
                margin: {}
              },
              // popup itself
              popup: {
                width: $popup.outerWidth(),
                height: $popup.outerHeight()
              },
              // offset container (or 3d context)
              parent: {
                width: $offsetParent.outerWidth(),
                height: $offsetParent.outerHeight()
              },
              // screen boundaries
              screen: {
                top: screenPosition.top,
                left: screenPosition.left,
                scroll: {
                  top: scroll.top,
                  left: scroll.left
                },
                width: $boundary.width(),
                height: $boundary.height()
              }
            };

            // if popup offset context is not same as target, then adjust calculations
            if ($popupOffsetParent.get(0) !== $offsetParent.get(0)) {
              var popupOffset = $popupOffsetParent.offset();
              calculations.target.top -= popupOffset.top;
              calculations.target.left -= popupOffset.left;
              calculations.parent.width = $popupOffsetParent.outerWidth();
              calculations.parent.height = $popupOffsetParent.outerHeight();
            }

            // add in container calcs if fluid
            if (settings.setFluidWidth && module.is.fluid()) {
              calculations.container = {
                width: $popup.parent().outerWidth()
              };
              calculations.popup.width = calculations.container.width;
            }

            // add in margins if inline
            calculations.target.margin.top = settings.inline ? parseInt(window.getComputedStyle(targetElement).getPropertyValue('margin-top'), 10) : 0;
            calculations.target.margin.left = settings.inline ? module.is.rtl() ? parseInt(window.getComputedStyle(targetElement).getPropertyValue('margin-right'), 10) : parseInt(window.getComputedStyle(targetElement).getPropertyValue('margin-left'), 10) : 0;
            // calculate screen boundaries
            screen = calculations.screen;
            calculations.boundary = {
              top: screen.top + screen.scroll.top,
              bottom: screen.top + screen.scroll.top + screen.height,
              left: screen.left + screen.scroll.left,
              right: screen.left + screen.scroll.left + screen.width
            };
            return calculations;
          },
          id: function id() {
            return _id;
          },
          startEvent: function startEvent() {
            if (settings.on == 'hover') {
              return 'mouseenter';
            } else if (settings.on == 'focus') {
              return 'focus';
            }
            return false;
          },
          scrollEvent: function scrollEvent() {
            return 'scroll';
          },
          endEvent: function endEvent() {
            if (settings.on == 'hover') {
              return 'mouseleave';
            } else if (settings.on == 'focus') {
              return 'blur';
            }
            return false;
          },
          distanceFromBoundary: function distanceFromBoundary(offset, calculations) {
            var distanceFromBoundary = {},
                popup,
                boundary;
            calculations = calculations || module.get.calculations();

            // shorthand
            popup = calculations.popup;
            boundary = calculations.boundary;

            if (offset) {
              distanceFromBoundary = {
                top: offset.top - boundary.top,
                left: offset.left - boundary.left,
                right: boundary.right - (offset.left + popup.width),
                bottom: boundary.bottom - (offset.top + popup.height)
              };
              module.verbose('Distance from boundaries determined', offset, distanceFromBoundary);
            }
            return distanceFromBoundary;
          },
          offsetParent: function offsetParent($element) {
            var element = $element !== undefined ? $element[0] : $target[0],
                parentNode = element.parentNode,
                $node = $(parentNode);
            if (parentNode) {
              var is2D = $node.css('transform') === 'none',
                  isStatic = $node.css('position') === 'static',
                  isBody = $node.is('body');
              while (parentNode && !isBody && isStatic && is2D) {
                parentNode = parentNode.parentNode;
                $node = $(parentNode);
                is2D = $node.css('transform') === 'none';
                isStatic = $node.css('position') === 'static';
                isBody = $node.is('body');
              }
            }
            return $node && $node.length > 0 ? $node : $();
          },
          positions: function positions() {
            return {
              'top left': false,
              'top center': false,
              'top right': false,
              'bottom left': false,
              'bottom center': false,
              'bottom right': false,
              'left center': false,
              'right center': false
            };
          },
          nextPosition: function nextPosition(position) {
            var positions = position.split(' '),
                verticalPosition = positions[0],
                horizontalPosition = positions[1],
                opposite = {
              top: 'bottom',
              bottom: 'top',
              left: 'right',
              right: 'left'
            },
                adjacent = {
              left: 'center',
              center: 'right',
              right: 'left'
            },
                backup = {
              'top left': 'top center',
              'top center': 'top right',
              'top right': 'right center',
              'right center': 'bottom right',
              'bottom right': 'bottom center',
              'bottom center': 'bottom left',
              'bottom left': 'left center',
              'left center': 'top left'
            },
                adjacentsAvailable = verticalPosition == 'top' || verticalPosition == 'bottom',
                oppositeTried = false,
                adjacentTried = false,
                nextPosition = false;
            if (!triedPositions) {
              module.verbose('All available positions available');
              triedPositions = module.get.positions();
            }

            module.debug('Recording last position tried', position);
            triedPositions[position] = true;

            if (settings.prefer === 'opposite') {
              nextPosition = [opposite[verticalPosition], horizontalPosition];
              nextPosition = nextPosition.join(' ');
              oppositeTried = triedPositions[nextPosition] === true;
              module.debug('Trying opposite strategy', nextPosition);
            }
            if (settings.prefer === 'adjacent' && adjacentsAvailable) {
              nextPosition = [verticalPosition, adjacent[horizontalPosition]];
              nextPosition = nextPosition.join(' ');
              adjacentTried = triedPositions[nextPosition] === true;
              module.debug('Trying adjacent strategy', nextPosition);
            }
            if (adjacentTried || oppositeTried) {
              module.debug('Using backup position', nextPosition);
              nextPosition = backup[position];
            }
            return nextPosition;
          }
        },

        set: {
          position: function position(_position, calculations) {

            // exit conditions
            if ($target.length === 0 || $popup.length === 0) {
              module.error(error.notFound);
              return;
            }
            var offset, distanceAway, target, popup, parent, positioning, popupOffset, distanceFromBoundary;

            calculations = calculations || module.get.calculations();
            _position = _position || $module.data(metadata.position) || settings.position;

            offset = $module.data(metadata.offset) || settings.offset;
            distanceAway = settings.distanceAway;

            // shorthand
            target = calculations.target;
            popup = calculations.popup;
            parent = calculations.parent;

            if (module.should.centerArrow(calculations)) {
              module.verbose('Adjusting offset to center arrow on small target element');
              if (_position == 'top left' || _position == 'bottom left') {
                offset += target.width / 2;
                offset -= settings.arrowPixelsFromEdge;
              }
              if (_position == 'top right' || _position == 'bottom right') {
                offset -= target.width / 2;
                offset += settings.arrowPixelsFromEdge;
              }
            }

            if (target.width === 0 && target.height === 0 && !module.is.svg(target.element)) {
              module.debug('Popup target is hidden, no action taken');
              return false;
            }

            if (settings.inline) {
              module.debug('Adding margin to calculation', target.margin);
              if (_position == 'left center' || _position == 'right center') {
                offset += target.margin.top;
                distanceAway += -target.margin.left;
              } else if (_position == 'top left' || _position == 'top center' || _position == 'top right') {
                offset += target.margin.left;
                distanceAway -= target.margin.top;
              } else {
                offset += target.margin.left;
                distanceAway += target.margin.top;
              }
            }

            module.debug('Determining popup position from calculations', _position, calculations);

            if (module.is.rtl()) {
              _position = _position.replace(/left|right/g, function (match) {
                return match == 'left' ? 'right' : 'left';
              });
              module.debug('RTL: Popup position updated', _position);
            }

            // if last attempt use specified last resort position
            if (searchDepth == settings.maxSearchDepth && typeof settings.lastResort === 'string') {
              _position = settings.lastResort;
            }

            switch (_position) {
              case 'top left':
                positioning = {
                  top: 'auto',
                  bottom: parent.height - target.top + distanceAway,
                  left: target.left + offset,
                  right: 'auto'
                };
                break;
              case 'top center':
                positioning = {
                  bottom: parent.height - target.top + distanceAway,
                  left: target.left + target.width / 2 - popup.width / 2 + offset,
                  top: 'auto',
                  right: 'auto'
                };
                break;
              case 'top right':
                positioning = {
                  bottom: parent.height - target.top + distanceAway,
                  right: parent.width - target.left - target.width - offset,
                  top: 'auto',
                  left: 'auto'
                };
                break;
              case 'left center':
                positioning = {
                  top: target.top + target.height / 2 - popup.height / 2 + offset,
                  right: parent.width - target.left + distanceAway,
                  left: 'auto',
                  bottom: 'auto'
                };
                break;
              case 'right center':
                positioning = {
                  top: target.top + target.height / 2 - popup.height / 2 + offset,
                  left: target.left + target.width + distanceAway,
                  bottom: 'auto',
                  right: 'auto'
                };
                break;
              case 'bottom left':
                positioning = {
                  top: target.top + target.height + distanceAway,
                  left: target.left + offset,
                  bottom: 'auto',
                  right: 'auto'
                };
                break;
              case 'bottom center':
                positioning = {
                  top: target.top + target.height + distanceAway,
                  left: target.left + target.width / 2 - popup.width / 2 + offset,
                  bottom: 'auto',
                  right: 'auto'
                };
                break;
              case 'bottom right':
                positioning = {
                  top: target.top + target.height + distanceAway,
                  right: parent.width - target.left - target.width - offset,
                  left: 'auto',
                  bottom: 'auto'
                };
                break;
            }
            if (positioning === undefined) {
              module.error(error.invalidPosition, _position);
            }

            module.debug('Calculated popup positioning values', positioning);

            // tentatively place on stage
            $popup.css(positioning).removeClass(className.position).addClass(_position).addClass(className.loading);

            popupOffset = module.get.popupOffset();

            // see if any boundaries are surpassed with this tentative position
            distanceFromBoundary = module.get.distanceFromBoundary(popupOffset, calculations);

            if (module.is.offstage(distanceFromBoundary, _position)) {
              module.debug('Position is outside viewport', _position);
              if (searchDepth < settings.maxSearchDepth) {
                searchDepth++;
                _position = module.get.nextPosition(_position);
                module.debug('Trying new position', _position);
                return $popup ? module.set.position(_position, calculations) : false;
              } else {
                if (settings.lastResort) {
                  module.debug('No position found, showing with last position');
                } else {
                  module.debug('Popup could not find a position to display', $popup);
                  module.error(error.cannotPlace, element);
                  module.remove.attempts();
                  module.remove.loading();
                  module.reset();
                  settings.onUnplaceable.call($popup, element);
                  return false;
                }
              }
            }
            module.debug('Position is on stage', _position);
            module.remove.attempts();
            module.remove.loading();
            if (settings.setFluidWidth && module.is.fluid()) {
              module.set.fluidWidth(calculations);
            }
            return true;
          },

          fluidWidth: function fluidWidth(calculations) {
            calculations = calculations || module.get.calculations();
            module.debug('Automatically setting element width to parent width', calculations.parent.width);
            $popup.css('width', calculations.container.width);
          },

          variation: function variation(_variation) {
            _variation = _variation || module.get.variation();
            if (_variation && module.has.popup()) {
              module.verbose('Adding variation to popup', _variation);
              $popup.addClass(_variation);
            }
          },

          visible: function visible() {
            $module.addClass(className.visible);
          }
        },

        remove: {
          loading: function loading() {
            $popup.removeClass(className.loading);
          },
          variation: function variation(_variation2) {
            _variation2 = _variation2 || module.get.variation();
            if (_variation2) {
              module.verbose('Removing variation', _variation2);
              $popup.removeClass(_variation2);
            }
          },
          visible: function visible() {
            $module.removeClass(className.visible);
          },
          attempts: function attempts() {
            module.verbose('Resetting all searched positions');
            searchDepth = 0;
            triedPositions = false;
          }
        },

        bind: {
          events: function events() {
            module.debug('Binding popup events to module');
            if (settings.on == 'click') {
              $module.on('click' + eventNamespace, module.toggle);
            }
            if (settings.on == 'hover' && hasTouch) {
              $module.on('touchstart' + eventNamespace, module.event.touchstart);
            }
            if (module.get.startEvent()) {
              $module.on(module.get.startEvent() + eventNamespace, module.event.start).on(module.get.endEvent() + eventNamespace, module.event.end);
            }
            if (settings.target) {
              module.debug('Target set to element', $target);
            }
            $window.on('resize' + elementNamespace, module.event.resize);
          },
          popup: function popup() {
            module.verbose('Allowing hover events on popup to prevent closing');
            if ($popup && module.has.popup()) {
              $popup.on('mouseenter' + eventNamespace, module.event.start).on('mouseleave' + eventNamespace, module.event.end);
            }
          },
          close: function close() {
            if (settings.hideOnScroll === true || settings.hideOnScroll == 'auto' && settings.on != 'click') {
              module.bind.closeOnScroll();
            }
            if (module.is.closable()) {
              module.bind.clickaway();
            } else if (settings.on == 'hover' && openedWithTouch) {
              module.bind.touchClose();
            }
          },
          closeOnScroll: function closeOnScroll() {
            module.verbose('Binding scroll close event to document');
            $scrollContext.one(module.get.scrollEvent() + elementNamespace, module.event.hideGracefully);
          },
          touchClose: function touchClose() {
            module.verbose('Binding popup touchclose event to document');
            $document.on('touchstart' + elementNamespace, function (event) {
              module.verbose('Touched away from popup');
              module.event.hideGracefully.call(element, event);
            });
          },
          clickaway: function clickaway() {
            module.verbose('Binding popup close event to document');
            $document.on('click' + elementNamespace, function (event) {
              module.verbose('Clicked away from popup');
              module.event.hideGracefully.call(element, event);
            });
          }
        },

        unbind: {
          events: function events() {
            $window.off(elementNamespace);
            $module.off(eventNamespace);
          },
          close: function close() {
            $document.off(elementNamespace);
            $scrollContext.off(elementNamespace);
          }
        },

        has: {
          popup: function popup() {
            return $popup && $popup.length > 0;
          }
        },

        should: {
          centerArrow: function centerArrow(calculations) {
            return !module.is.basic() && calculations.target.width <= settings.arrowPixelsFromEdge * 2;
          }
        },

        is: {
          closable: function closable() {
            if (settings.closable == 'auto') {
              if (settings.on == 'hover') {
                return false;
              }
              return true;
            }
            return settings.closable;
          },
          offstage: function offstage(distanceFromBoundary, position) {
            var offstage = [];
            // return boundaries that have been surpassed
            $.each(distanceFromBoundary, function (direction, distance) {
              if (distance < -settings.jitter) {
                module.debug('Position exceeds allowable distance from edge', direction, distance, position);
                offstage.push(direction);
              }
            });
            if (offstage.length > 0) {
              return true;
            } else {
              return false;
            }
          },
          svg: function svg(element) {
            return module.supports.svg() && element instanceof SVGGraphicsElement;
          },
          basic: function basic() {
            return $module.hasClass(className.basic);
          },
          active: function active() {
            return $module.hasClass(className.active);
          },
          animating: function animating() {
            return $popup !== undefined && $popup.hasClass(className.animating);
          },
          fluid: function fluid() {
            return $popup !== undefined && $popup.hasClass(className.fluid);
          },
          visible: function visible() {
            return $popup !== undefined && $popup.hasClass(className.popupVisible);
          },
          dropdown: function dropdown() {
            return $module.hasClass(className.dropdown);
          },
          hidden: function hidden() {
            return !module.is.visible();
          },
          rtl: function rtl() {
            return $module.css('direction') == 'rtl';
          }
        },

        reset: function reset() {
          module.remove.visible();
          if (settings.preserve) {
            if ($.fn.transition !== undefined) {
              $popup.transition('remove transition');
            }
          } else {
            module.removePopup();
          }
        },

        setting: function setting(name, value) {
          if ($.isPlainObject(name)) {
            $.extend(true, settings, name);
          } else if (value !== undefined) {
            settings[name] = value;
          } else {
            return settings[name];
          }
        },
        internal: function internal(name, value) {
          if ($.isPlainObject(name)) {
            $.extend(true, module, name);
          } else if (value !== undefined) {
            module[name] = value;
          } else {
            return module[name];
          }
        },
        debug: function debug() {
          if (!settings.silent && settings.debug) {
            if (settings.performance) {
              module.performance.log(arguments);
            } else {
              module.debug = Function.prototype.bind.call(console.info, console, settings.name + ':');
              module.debug.apply(console, arguments);
            }
          }
        },
        verbose: function verbose() {
          if (!settings.silent && settings.verbose && settings.debug) {
            if (settings.performance) {
              module.performance.log(arguments);
            } else {
              module.verbose = Function.prototype.bind.call(console.info, console, settings.name + ':');
              module.verbose.apply(console, arguments);
            }
          }
        },
        error: function error() {
          if (!settings.silent) {
            module.error = Function.prototype.bind.call(console.error, console, settings.name + ':');
            module.error.apply(console, arguments);
          }
        },
        performance: {
          log: function log(message) {
            var currentTime, executionTime, previousTime;
            if (settings.performance) {
              currentTime = new Date().getTime();
              previousTime = time || currentTime;
              executionTime = currentTime - previousTime;
              time = currentTime;
              performance.push({
                'Name': message[0],
                'Arguments': [].slice.call(message, 1) || '',
                'Element': element,
                'Execution Time': executionTime
              });
            }
            clearTimeout(module.performance.timer);
            module.performance.timer = setTimeout(module.performance.display, 500);
          },
          display: function display() {
            var title = settings.name + ':',
                totalTime = 0;
            time = false;
            clearTimeout(module.performance.timer);
            $.each(performance, function (index, data) {
              totalTime += data['Execution Time'];
            });
            title += ' ' + totalTime + 'ms';
            if (moduleSelector) {
              title += ' \'' + moduleSelector + '\'';
            }
            if ((console.group !== undefined || console.table !== undefined) && performance.length > 0) {
              console.groupCollapsed(title);
              if (console.table) {
                console.table(performance);
              } else {
                $.each(performance, function (index, data) {
                  console.log(data['Name'] + ': ' + data['Execution Time'] + 'ms');
                });
              }
              console.groupEnd();
            }
            performance = [];
          }
        },
        invoke: function invoke(query, passedArguments, context) {
          var object = instance,
              maxDepth,
              found,
              response;
          passedArguments = passedArguments || queryArguments;
          context = element || context;
          if (typeof query == 'string' && object !== undefined) {
            query = query.split(/[\. ]/);
            maxDepth = query.length - 1;
            $.each(query, function (depth, value) {
              var camelCaseValue = depth != maxDepth ? value + query[depth + 1].charAt(0).toUpperCase() + query[depth + 1].slice(1) : query;
              if ($.isPlainObject(object[camelCaseValue]) && depth != maxDepth) {
                object = object[camelCaseValue];
              } else if (object[camelCaseValue] !== undefined) {
                found = object[camelCaseValue];
                return false;
              } else if ($.isPlainObject(object[value]) && depth != maxDepth) {
                object = object[value];
              } else if (object[value] !== undefined) {
                found = object[value];
                return false;
              } else {
                return false;
              }
            });
          }
          if ($.isFunction(found)) {
            response = found.apply(context, passedArguments);
          } else if (found !== undefined) {
            response = found;
          }
          if ($.isArray(returnedValue)) {
            returnedValue.push(response);
          } else if (returnedValue !== undefined) {
            returnedValue = [returnedValue, response];
          } else if (response !== undefined) {
            returnedValue = response;
          }
          return found;
        }
      };

      if (methodInvoked) {
        if (instance === undefined) {
          module.initialize();
        }
        module.invoke(query);
      } else {
        if (instance !== undefined) {
          instance.invoke('destroy');
        }
        module.initialize();
      }
    });

    return returnedValue !== undefined ? returnedValue : this;
  };

  $.fn.popup.settings = {

    name: 'Popup',

    // module settings
    silent: false,
    debug: false,
    verbose: false,
    performance: true,
    namespace: 'popup',

    // whether it should use dom mutation observers
    observeChanges: true,

    // callback only when element added to dom
    onCreate: function onCreate() {},

    // callback before element removed from dom
    onRemove: function onRemove() {},

    // callback before show animation
    onShow: function onShow() {},

    // callback after show animation
    onVisible: function onVisible() {},

    // callback before hide animation
    onHide: function onHide() {},

    // callback when popup cannot be positioned in visible screen
    onUnplaceable: function onUnplaceable() {},

    // callback after hide animation
    onHidden: function onHidden() {},

    // when to show popup
    on: 'hover',

    // element to use to determine if popup is out of boundary
    boundary: window,

    // whether to add touchstart events when using hover
    addTouchEvents: true,

    // default position relative to element
    position: 'top left',

    // name of variation to use
    variation: '',

    // whether popup should be moved to context
    movePopup: true,

    // element which popup should be relative to
    target: false,

    // jq selector or element that should be used as popup
    popup: false,

    // popup should remain inline next to activator
    inline: false,

    // popup should be removed from page on hide
    preserve: false,

    // popup should not close when being hovered on
    hoverable: false,

    // explicitly set content
    content: false,

    // explicitly set html
    html: false,

    // explicitly set title
    title: false,

    // whether automatically close on clickaway when on click
    closable: true,

    // automatically hide on scroll
    hideOnScroll: 'auto',

    // hide other popups on show
    exclusive: false,

    // context to attach popups
    context: 'body',

    // context for binding scroll events
    scrollContext: window,

    // position to prefer when calculating new position
    prefer: 'opposite',

    // specify position to appear even if it doesn't fit
    lastResort: false,

    // number of pixels from edge of popup to pointing arrow center (used from centering)
    arrowPixelsFromEdge: 20,

    // delay used to prevent accidental refiring of animations due to user error
    delay: {
      show: 50,
      hide: 70
    },

    // whether fluid variation should assign width explicitly
    setFluidWidth: true,

    // transition settings
    duration: 200,
    transition: 'scale',

    // distance away from activating element in px
    distanceAway: 0,

    // number of pixels an element is allowed to be "offstage" for a position to be chosen (allows for rounding)
    jitter: 2,

    // offset on aligning axis from calculated position
    offset: 0,

    // maximum times to look for a position before failing (9 positions total)
    maxSearchDepth: 15,

    error: {
      invalidPosition: 'The position you specified is not a valid position',
      cannotPlace: 'Popup does not fit within the boundaries of the viewport',
      method: 'The method you called is not defined.',
      noTransition: 'This module requires ui transitions <https://github.com/Semantic-Org/UI-Transition>',
      notFound: 'The target or popup you specified does not exist on the page'
    },

    metadata: {
      activator: 'activator',
      content: 'content',
      html: 'html',
      offset: 'offset',
      position: 'position',
      title: 'title',
      variation: 'variation'
    },

    className: {
      active: 'active',
      basic: 'basic',
      animating: 'animating',
      dropdown: 'dropdown',
      fluid: 'fluid',
      loading: 'loading',
      popup: 'ui popup',
      position: 'top left center bottom right',
      visible: 'visible',
      popupVisible: 'visible'
    },

    selector: {
      popup: '.ui.popup'
    },

    templates: {
      escape: function escape(string) {
        var badChars = /[&<>"'`]/g,
            shouldEscape = /[&<>"'`]/,
            escape = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#x27;",
          "`": "&#x60;"
        },
            escapedChar = function escapedChar(chr) {
          return escape[chr];
        };
        if (shouldEscape.test(string)) {
          return string.replace(badChars, escapedChar);
        }
        return string;
      },
      popup: function popup(text) {
        var html = '',
            escape = $.fn.popup.settings.templates.escape;
        if ((typeof text === "undefined" ? "undefined" : _typeof(text)) !== undefined) {
          if (_typeof(text.title) !== undefined && text.title) {
            text.title = escape(text.title);
            html += '<div class="header">' + text.title + '</div>';
          }
          if (_typeof(text.content) !== undefined && text.content) {
            text.content = escape(text.content);
            html += '<div class="content">' + text.content + '</div>';
          }
        }
        return html;
      }
    }

  };
})(jQuery, window, document);

/*!
 * # Semantic UI 2.4.2 - Dropdown
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */

;(function ($, window, document, undefined) {

  'use strict';

  window = typeof window != 'undefined' && window.Math == Math ? window : typeof self != 'undefined' && self.Math == Math ? self : Function('return this')();

  $.fn.dropdown = function (parameters) {
    var $allModules = $(this),
        $document = $(document),
        moduleSelector = $allModules.selector || '',
        hasTouch = 'ontouchstart' in document.documentElement,
        time = new Date().getTime(),
        performance = [],
        query = arguments[0],
        methodInvoked = typeof query == 'string',
        queryArguments = [].slice.call(arguments, 1),
        returnedValue;

    $allModules.each(function (elementIndex) {
      var settings = $.isPlainObject(parameters) ? $.extend(true, {}, $.fn.dropdown.settings, parameters) : $.extend({}, $.fn.dropdown.settings),
          className = settings.className,
          message = settings.message,
          fields = settings.fields,
          keys = settings.keys,
          metadata = settings.metadata,
          namespace = settings.namespace,
          regExp = settings.regExp,
          selector = settings.selector,
          error = settings.error,
          templates = settings.templates,
          eventNamespace = '.' + namespace,
          moduleNamespace = 'module-' + namespace,
          $module = $(this),
          $context = $(settings.context),
          $text = $module.find(selector.text),
          $search = $module.find(selector.search),
          $sizer = $module.find(selector.sizer),
          $input = $module.find(selector.input),
          $icon = $module.find(selector.icon),
          $combo = $module.prev().find(selector.text).length > 0 ? $module.prev().find(selector.text) : $module.prev(),
          $menu = $module.children(selector.menu),
          $item = $menu.find(selector.item),
          activated = false,
          itemActivated = false,
          internalChange = false,
          element = this,
          instance = $module.data(moduleNamespace),
          _initialLoad2,
          pageLostFocus,
          willRefocus,
          elementNamespace,
          _id2,
          _selectObserver,
          _menuObserver,
          module;

      module = {

        initialize: function initialize() {
          module.debug('Initializing dropdown', settings);

          if (module.is.alreadySetup()) {
            module.setup.reference();
          } else {

            module.setup.layout();

            if (settings.values) {
              module.change.values(settings.values);
            }

            module.refreshData();

            module.save.defaults();
            module.restore.selected();

            module.create.id();
            module.bind.events();

            module.observeChanges();
            module.instantiate();
          }
        },

        instantiate: function instantiate() {
          module.verbose('Storing instance of dropdown', module);
          instance = module;
          $module.data(moduleNamespace, module);
        },

        destroy: function destroy() {
          module.verbose('Destroying previous dropdown', $module);
          module.remove.tabbable();
          $module.off(eventNamespace).removeData(moduleNamespace);
          $menu.off(eventNamespace);
          $document.off(elementNamespace);
          module.disconnect.menuObserver();
          module.disconnect.selectObserver();
        },

        observeChanges: function observeChanges() {
          if ('MutationObserver' in window) {
            _selectObserver = new MutationObserver(module.event.select.mutation);
            _menuObserver = new MutationObserver(module.event.menu.mutation);
            module.debug('Setting up mutation observer', _selectObserver, _menuObserver);
            module.observe.select();
            module.observe.menu();
          }
        },

        disconnect: {
          menuObserver: function menuObserver() {
            if (_menuObserver) {
              _menuObserver.disconnect();
            }
          },
          selectObserver: function selectObserver() {
            if (_selectObserver) {
              _selectObserver.disconnect();
            }
          }
        },
        observe: {
          select: function select() {
            if (module.has.input()) {
              _selectObserver.observe($module[0], {
                childList: true,
                subtree: true
              });
            }
          },
          menu: function menu() {
            if (module.has.menu()) {
              _menuObserver.observe($menu[0], {
                childList: true,
                subtree: true
              });
            }
          }
        },

        create: {
          id: function id() {
            _id2 = (Math.random().toString(16) + '000000000').substr(2, 8);
            elementNamespace = '.' + _id2;
            module.verbose('Creating unique id for element', _id2);
          },
          userChoice: function userChoice(values) {
            var $userChoices, $userChoice, isUserValue, html;
            values = values || module.get.userValues();
            if (!values) {
              return false;
            }
            values = $.isArray(values) ? values : [values];
            $.each(values, function (index, value) {
              if (module.get.item(value) === false) {
                html = settings.templates.addition(module.add.variables(message.addResult, value));
                $userChoice = $('<div />').html(html).attr('data-' + metadata.value, value).attr('data-' + metadata.text, value).addClass(className.addition).addClass(className.item);
                if (settings.hideAdditions) {
                  $userChoice.addClass(className.hidden);
                }
                $userChoices = $userChoices === undefined ? $userChoice : $userChoices.add($userChoice);
                module.verbose('Creating user choices for value', value, $userChoice);
              }
            });
            return $userChoices;
          },
          userLabels: function userLabels(value) {
            var userValues = module.get.userValues();
            if (userValues) {
              module.debug('Adding user labels', userValues);
              $.each(userValues, function (index, value) {
                module.verbose('Adding custom user value');
                module.add.label(value, value);
              });
            }
          },
          menu: function menu() {
            $menu = $('<div />').addClass(className.menu).appendTo($module);
          },
          sizer: function sizer() {
            $sizer = $('<span />').addClass(className.sizer).insertAfter($search);
          }
        },

        search: function search(query) {
          query = query !== undefined ? query : module.get.query();
          module.verbose('Searching for query', query);
          if (module.has.minCharacters(query)) {
            module.filter(query);
          } else {
            module.hide();
          }
        },

        select: {
          firstUnfiltered: function firstUnfiltered() {
            module.verbose('Selecting first non-filtered element');
            module.remove.selectedItem();
            $item.not(selector.unselectable).not(selector.addition + selector.hidden).eq(0).addClass(className.selected);
          },
          nextAvailable: function nextAvailable($selected) {
            $selected = $selected.eq(0);
            var $nextAvailable = $selected.nextAll(selector.item).not(selector.unselectable).eq(0),
                $prevAvailable = $selected.prevAll(selector.item).not(selector.unselectable).eq(0),
                hasNext = $nextAvailable.length > 0;
            if (hasNext) {
              module.verbose('Moving selection to', $nextAvailable);
              $nextAvailable.addClass(className.selected);
            } else {
              module.verbose('Moving selection to', $prevAvailable);
              $prevAvailable.addClass(className.selected);
            }
          }
        },

        setup: {
          api: function api() {
            var apiSettings = {
              debug: settings.debug,
              urlData: {
                value: module.get.value(),
                query: module.get.query()
              },
              on: false
            };
            module.verbose('First request, initializing API');
            $module.api(apiSettings);
          },
          layout: function layout() {
            if ($module.is('select')) {
              module.setup.select();
              module.setup.returnedObject();
            }
            if (!module.has.menu()) {
              module.create.menu();
            }
            if (module.is.search() && !module.has.search()) {
              module.verbose('Adding search input');
              $search = $('<input />').addClass(className.search).prop('autocomplete', 'off').insertBefore($text);
            }
            if (module.is.multiple() && module.is.searchSelection() && !module.has.sizer()) {
              module.create.sizer();
            }
            if (settings.allowTab) {
              module.set.tabbable();
            }
          },
          select: function select() {
            var selectValues = module.get.selectValues();
            module.debug('Dropdown initialized on a select', selectValues);
            if ($module.is('select')) {
              $input = $module;
            }
            // see if select is placed correctly already
            if ($input.parent(selector.dropdown).length > 0) {
              module.debug('UI dropdown already exists. Creating dropdown menu only');
              $module = $input.closest(selector.dropdown);
              if (!module.has.menu()) {
                module.create.menu();
              }
              $menu = $module.children(selector.menu);
              module.setup.menu(selectValues);
            } else {
              module.debug('Creating entire dropdown from select');
              $module = $('<div />').attr('class', $input.attr('class')).addClass(className.selection).addClass(className.dropdown).html(templates.dropdown(selectValues)).insertBefore($input);
              if ($input.hasClass(className.multiple) && $input.prop('multiple') === false) {
                module.error(error.missingMultiple);
                $input.prop('multiple', true);
              }
              if ($input.is('[multiple]')) {
                module.set.multiple();
              }
              if ($input.prop('disabled')) {
                module.debug('Disabling dropdown');
                $module.addClass(className.disabled);
              }
              $input.removeAttr('class').detach().prependTo($module);
            }
            module.refresh();
          },
          menu: function menu(values) {
            $menu.html(templates.menu(values, fields));
            $item = $menu.find(selector.item);
          },
          reference: function reference() {
            module.debug('Dropdown behavior was called on select, replacing with closest dropdown');
            // replace module reference
            $module = $module.parent(selector.dropdown);
            instance = $module.data(moduleNamespace);
            element = $module.get(0);
            module.refresh();
            module.setup.returnedObject();
          },
          returnedObject: function returnedObject() {
            var $firstModules = $allModules.slice(0, elementIndex),
                $lastModules = $allModules.slice(elementIndex + 1);
            // adjust all modules to use correct reference
            $allModules = $firstModules.add($module).add($lastModules);
          }
        },

        refresh: function refresh() {
          module.refreshSelectors();
          module.refreshData();
        },

        refreshItems: function refreshItems() {
          $item = $menu.find(selector.item);
        },

        refreshSelectors: function refreshSelectors() {
          module.verbose('Refreshing selector cache');
          $text = $module.find(selector.text);
          $search = $module.find(selector.search);
          $input = $module.find(selector.input);
          $icon = $module.find(selector.icon);
          $combo = $module.prev().find(selector.text).length > 0 ? $module.prev().find(selector.text) : $module.prev();
          $menu = $module.children(selector.menu);
          $item = $menu.find(selector.item);
        },

        refreshData: function refreshData() {
          module.verbose('Refreshing cached metadata');
          $item.removeData(metadata.text).removeData(metadata.value);
        },

        clearData: function clearData() {
          module.verbose('Clearing metadata');
          $item.removeData(metadata.text).removeData(metadata.value);
          $module.removeData(metadata.defaultText).removeData(metadata.defaultValue).removeData(metadata.placeholderText);
        },

        toggle: function toggle() {
          module.verbose('Toggling menu visibility');
          if (!module.is.active()) {
            module.show();
          } else {
            module.hide();
          }
        },

        show: function show(callback) {
          callback = $.isFunction(callback) ? callback : function () {};
          if (!module.can.show() && module.is.remote()) {
            module.debug('No API results retrieved, searching before show');
            module.queryRemote(module.get.query(), module.show);
          }
          if (module.can.show() && !module.is.active()) {
            module.debug('Showing dropdown');
            if (module.has.message() && !(module.has.maxSelections() || module.has.allResultsFiltered())) {
              module.remove.message();
            }
            if (module.is.allFiltered()) {
              return true;
            }
            if (settings.onShow.call(element) !== false) {
              module.animate.show(function () {
                if (module.can.click()) {
                  module.bind.intent();
                }
                if (module.has.menuSearch()) {
                  module.focusSearch();
                }
                module.set.visible();
                callback.call(element);
              });
            }
          }
        },

        hide: function hide(callback) {
          callback = $.isFunction(callback) ? callback : function () {};
          if (module.is.active() && !module.is.animatingOutward()) {
            module.debug('Hiding dropdown');
            if (settings.onHide.call(element) !== false) {
              module.animate.hide(function () {
                module.remove.visible();
                callback.call(element);
              });
            }
          }
        },

        hideOthers: function hideOthers() {
          module.verbose('Finding other dropdowns to hide');
          $allModules.not($module).has(selector.menu + '.' + className.visible).dropdown('hide');
        },

        hideMenu: function hideMenu() {
          module.verbose('Hiding menu  instantaneously');
          module.remove.active();
          module.remove.visible();
          $menu.transition('hide');
        },

        hideSubMenus: function hideSubMenus() {
          var $subMenus = $menu.children(selector.item).find(selector.menu);
          module.verbose('Hiding sub menus', $subMenus);
          $subMenus.transition('hide');
        },

        bind: {
          events: function events() {
            if (hasTouch) {
              module.bind.touchEvents();
            }
            module.bind.keyboardEvents();
            module.bind.inputEvents();
            module.bind.mouseEvents();
          },
          touchEvents: function touchEvents() {
            module.debug('Touch device detected binding additional touch events');
            if (module.is.searchSelection()) {
              // do nothing special yet
            } else if (module.is.single()) {
              $module.on('touchstart' + eventNamespace, module.event.test.toggle);
            }
            $menu.on('touchstart' + eventNamespace, selector.item, module.event.item.mouseenter);
          },
          keyboardEvents: function keyboardEvents() {
            module.verbose('Binding keyboard events');
            $module.on('keydown' + eventNamespace, module.event.keydown);
            if (module.has.search()) {
              $module.on(module.get.inputEvent() + eventNamespace, selector.search, module.event.input);
            }
            if (module.is.multiple()) {
              $document.on('keydown' + elementNamespace, module.event.document.keydown);
            }
          },
          inputEvents: function inputEvents() {
            module.verbose('Binding input change events');
            $module.on('change' + eventNamespace, selector.input, module.event.change);
          },
          mouseEvents: function mouseEvents() {
            module.verbose('Binding mouse events');
            if (module.is.multiple()) {
              $module.on('click' + eventNamespace, selector.label, module.event.label.click).on('click' + eventNamespace, selector.remove, module.event.remove.click);
            }
            if (module.is.searchSelection()) {
              $module.on('mousedown' + eventNamespace, module.event.mousedown).on('mouseup' + eventNamespace, module.event.mouseup).on('mousedown' + eventNamespace, selector.menu, module.event.menu.mousedown).on('mouseup' + eventNamespace, selector.menu, module.event.menu.mouseup).on('click' + eventNamespace, selector.icon, module.event.icon.click).on('focus' + eventNamespace, selector.search, module.event.search.focus).on('click' + eventNamespace, selector.search, module.event.search.focus).on('blur' + eventNamespace, selector.search, module.event.search.blur).on('click' + eventNamespace, selector.text, module.event.text.focus);
              if (module.is.multiple()) {
                $module.on('click' + eventNamespace, module.event.click);
              }
            } else {
              if (settings.on == 'click') {
                $module.on('click' + eventNamespace, module.event.test.toggle);
              } else if (settings.on == 'hover') {
                $module.on('mouseenter' + eventNamespace, module.delay.show).on('mouseleave' + eventNamespace, module.delay.hide);
              } else {
                $module.on(settings.on + eventNamespace, module.toggle);
              }
              $module.on('click' + eventNamespace, selector.icon, module.event.icon.click).on('mousedown' + eventNamespace, module.event.mousedown).on('mouseup' + eventNamespace, module.event.mouseup).on('focus' + eventNamespace, module.event.focus);
              if (module.has.menuSearch()) {
                $module.on('blur' + eventNamespace, selector.search, module.event.search.blur);
              } else {
                $module.on('blur' + eventNamespace, module.event.blur);
              }
            }
            $menu.on('mouseenter' + eventNamespace, selector.item, module.event.item.mouseenter).on('mouseleave' + eventNamespace, selector.item, module.event.item.mouseleave).on('click' + eventNamespace, selector.item, module.event.item.click);
          },
          intent: function intent() {
            module.verbose('Binding hide intent event to document');
            if (hasTouch) {
              $document.on('touchstart' + elementNamespace, module.event.test.touch).on('touchmove' + elementNamespace, module.event.test.touch);
            }
            $document.on('click' + elementNamespace, module.event.test.hide);
          }
        },

        unbind: {
          intent: function intent() {
            module.verbose('Removing hide intent event from document');
            if (hasTouch) {
              $document.off('touchstart' + elementNamespace).off('touchmove' + elementNamespace);
            }
            $document.off('click' + elementNamespace);
          }
        },

        filter: function filter(query) {
          var searchTerm = query !== undefined ? query : module.get.query(),
              afterFiltered = function afterFiltered() {
            if (module.is.multiple()) {
              module.filterActive();
            }
            if (query || !query && module.get.activeItem().length == 0) {
              module.select.firstUnfiltered();
            }
            if (module.has.allResultsFiltered()) {
              if (settings.onNoResults.call(element, searchTerm)) {
                if (settings.allowAdditions) {
                  if (settings.hideAdditions) {
                    module.verbose('User addition with no menu, setting empty style');
                    module.set.empty();
                    module.hideMenu();
                  }
                } else {
                  module.verbose('All items filtered, showing message', searchTerm);
                  module.add.message(message.noResults);
                }
              } else {
                module.verbose('All items filtered, hiding dropdown', searchTerm);
                module.hideMenu();
              }
            } else {
              module.remove.empty();
              module.remove.message();
            }
            if (settings.allowAdditions) {
              module.add.userSuggestion(query);
            }
            if (module.is.searchSelection() && module.can.show() && module.is.focusedOnSearch()) {
              module.show();
            }
          };
          if (settings.useLabels && module.has.maxSelections()) {
            return;
          }
          if (settings.apiSettings) {
            if (module.can.useAPI()) {
              module.queryRemote(searchTerm, function () {
                if (settings.filterRemoteData) {
                  module.filterItems(searchTerm);
                }
                afterFiltered();
              });
            } else {
              module.error(error.noAPI);
            }
          } else {
            module.filterItems(searchTerm);
            afterFiltered();
          }
        },

        queryRemote: function queryRemote(query, callback) {
          var apiSettings = {
            errorDuration: false,
            cache: 'local',
            throttle: settings.throttle,
            urlData: {
              query: query
            },
            onError: function onError() {
              module.add.message(message.serverError);
              callback();
            },
            onFailure: function onFailure() {
              module.add.message(message.serverError);
              callback();
            },
            onSuccess: function onSuccess(response) {
              var values = response[fields.remoteValues],
                  hasRemoteValues = $.isArray(values) && values.length > 0;
              if (hasRemoteValues) {
                module.remove.message();
                module.setup.menu({
                  values: response[fields.remoteValues]
                });
              } else {
                module.add.message(message.noResults);
              }
              callback();
            }
          };
          if (!$module.api('get request')) {
            module.setup.api();
          }
          apiSettings = $.extend(true, {}, apiSettings, settings.apiSettings);
          $module.api('setting', apiSettings).api('query');
        },

        filterItems: function filterItems(query) {
          var searchTerm = query !== undefined ? query : module.get.query(),
              results = null,
              escapedTerm = module.escape.string(searchTerm),
              beginsWithRegExp = new RegExp('^' + escapedTerm, 'igm');
          // avoid loop if we're matching nothing
          if (module.has.query()) {
            results = [];

            module.verbose('Searching for matching values', searchTerm);
            $item.each(function () {
              var $choice = $(this),
                  text,
                  value;
              if (settings.match == 'both' || settings.match == 'text') {
                text = String(module.get.choiceText($choice, false));
                if (text.search(beginsWithRegExp) !== -1) {
                  results.push(this);
                  return true;
                } else if (settings.fullTextSearch === 'exact' && module.exactSearch(searchTerm, text)) {
                  results.push(this);
                  return true;
                } else if (settings.fullTextSearch === true && module.fuzzySearch(searchTerm, text)) {
                  results.push(this);
                  return true;
                }
              }
              if (settings.match == 'both' || settings.match == 'value') {
                value = String(module.get.choiceValue($choice, text));
                if (value.search(beginsWithRegExp) !== -1) {
                  results.push(this);
                  return true;
                } else if (settings.fullTextSearch === 'exact' && module.exactSearch(searchTerm, value)) {
                  results.push(this);
                  return true;
                } else if (settings.fullTextSearch === true && module.fuzzySearch(searchTerm, value)) {
                  results.push(this);
                  return true;
                }
              }
            });
          }
          module.debug('Showing only matched items', searchTerm);
          module.remove.filteredItem();
          if (results) {
            $item.not(results).addClass(className.filtered);
          }
        },

        fuzzySearch: function fuzzySearch(query, term) {
          var termLength = term.length,
              queryLength = query.length;
          query = query.toLowerCase();
          term = term.toLowerCase();
          if (queryLength > termLength) {
            return false;
          }
          if (queryLength === termLength) {
            return query === term;
          }
          search: for (var characterIndex = 0, nextCharacterIndex = 0; characterIndex < queryLength; characterIndex++) {
            var queryCharacter = query.charCodeAt(characterIndex);
            while (nextCharacterIndex < termLength) {
              if (term.charCodeAt(nextCharacterIndex++) === queryCharacter) {
                continue search;
              }
            }
            return false;
          }
          return true;
        },
        exactSearch: function exactSearch(query, term) {
          query = query.toLowerCase();
          term = term.toLowerCase();
          if (term.indexOf(query) > -1) {
            return true;
          }
          return false;
        },
        filterActive: function filterActive() {
          if (settings.useLabels) {
            $item.filter('.' + className.active).addClass(className.filtered);
          }
        },

        focusSearch: function focusSearch(skipHandler) {
          if (module.has.search() && !module.is.focusedOnSearch()) {
            if (skipHandler) {
              $module.off('focus' + eventNamespace, selector.search);
              $search.focus();
              $module.on('focus' + eventNamespace, selector.search, module.event.search.focus);
            } else {
              $search.focus();
            }
          }
        },

        forceSelection: function forceSelection() {
          var $currentlySelected = $item.not(className.filtered).filter('.' + className.selected).eq(0),
              $activeItem = $item.not(className.filtered).filter('.' + className.active).eq(0),
              $selectedItem = $currentlySelected.length > 0 ? $currentlySelected : $activeItem,
              hasSelected = $selectedItem.length > 0;
          if (hasSelected && !module.is.multiple()) {
            module.debug('Forcing partial selection to selected item', $selectedItem);
            module.event.item.click.call($selectedItem, {}, true);
            return;
          } else {
            if (settings.allowAdditions) {
              module.set.selected(module.get.query());
              module.remove.searchTerm();
            } else {
              module.remove.searchTerm();
            }
          }
        },

        change: {
          values: function values(_values) {
            if (!settings.allowAdditions) {
              module.clear();
            }
            module.debug('Creating dropdown with specified values', _values);
            module.setup.menu({ values: _values });
            $.each(_values, function (index, item) {
              if (item.selected == true) {
                module.debug('Setting initial selection to', item.value);
                module.set.selected(item.value);
                return true;
              }
            });
          }
        },

        event: {
          change: function change() {
            if (!internalChange) {
              module.debug('Input changed, updating selection');
              module.set.selected();
            }
          },
          focus: function focus() {
            if (settings.showOnFocus && !activated && module.is.hidden() && !pageLostFocus) {
              module.show();
            }
          },
          blur: function blur(event) {
            pageLostFocus = document.activeElement === this;
            if (!activated && !pageLostFocus) {
              module.remove.activeLabel();
              module.hide();
            }
          },
          mousedown: function mousedown() {
            if (module.is.searchSelection()) {
              // prevent menu hiding on immediate re-focus
              willRefocus = true;
            } else {
              // prevents focus callback from occurring on mousedown
              activated = true;
            }
          },
          mouseup: function mouseup() {
            if (module.is.searchSelection()) {
              // prevent menu hiding on immediate re-focus
              willRefocus = false;
            } else {
              activated = false;
            }
          },
          click: function click(event) {
            var $target = $(event.target);
            // focus search
            if ($target.is($module)) {
              if (!module.is.focusedOnSearch()) {
                module.focusSearch();
              } else {
                module.show();
              }
            }
          },
          search: {
            focus: function focus() {
              activated = true;
              if (module.is.multiple()) {
                module.remove.activeLabel();
              }
              if (settings.showOnFocus) {
                module.search();
              }
            },
            blur: function blur(event) {
              pageLostFocus = document.activeElement === this;
              if (module.is.searchSelection() && !willRefocus) {
                if (!itemActivated && !pageLostFocus) {
                  if (settings.forceSelection) {
                    module.forceSelection();
                  }
                  module.hide();
                }
              }
              willRefocus = false;
            }
          },
          icon: {
            click: function click(event) {
              if ($icon.hasClass(className.clear)) {
                module.clear();
              } else if (module.can.click()) {
                module.toggle();
              }
            }
          },
          text: {
            focus: function focus(event) {
              activated = true;
              module.focusSearch();
            }
          },
          input: function input(event) {
            if (module.is.multiple() || module.is.searchSelection()) {
              module.set.filtered();
            }
            clearTimeout(module.timer);
            module.timer = setTimeout(module.search, settings.delay.search);
          },
          label: {
            click: function click(event) {
              var $label = $(this),
                  $labels = $module.find(selector.label),
                  $activeLabels = $labels.filter('.' + className.active),
                  $nextActive = $label.nextAll('.' + className.active),
                  $prevActive = $label.prevAll('.' + className.active),
                  $range = $nextActive.length > 0 ? $label.nextUntil($nextActive).add($activeLabels).add($label) : $label.prevUntil($prevActive).add($activeLabels).add($label);
              if (event.shiftKey) {
                $activeLabels.removeClass(className.active);
                $range.addClass(className.active);
              } else if (event.ctrlKey) {
                $label.toggleClass(className.active);
              } else {
                $activeLabels.removeClass(className.active);
                $label.addClass(className.active);
              }
              settings.onLabelSelect.apply(this, $labels.filter('.' + className.active));
            }
          },
          remove: {
            click: function click() {
              var $label = $(this).parent();
              if ($label.hasClass(className.active)) {
                // remove all selected labels
                module.remove.activeLabels();
              } else {
                // remove this label only
                module.remove.activeLabels($label);
              }
            }
          },
          test: {
            toggle: function toggle(event) {
              var toggleBehavior = module.is.multiple() ? module.show : module.toggle;
              if (module.is.bubbledLabelClick(event) || module.is.bubbledIconClick(event)) {
                return;
              }
              if (module.determine.eventOnElement(event, toggleBehavior)) {
                event.preventDefault();
              }
            },
            touch: function touch(event) {
              module.determine.eventOnElement(event, function () {
                if (event.type == 'touchstart') {
                  module.timer = setTimeout(function () {
                    module.hide();
                  }, settings.delay.touch);
                } else if (event.type == 'touchmove') {
                  clearTimeout(module.timer);
                }
              });
              event.stopPropagation();
            },
            hide: function hide(event) {
              module.determine.eventInModule(event, module.hide);
            }
          },
          select: {
            mutation: function mutation(mutations) {
              module.debug('<select> modified, recreating menu');
              var isSelectMutation = false;
              $.each(mutations, function (index, mutation) {
                if ($(mutation.target).is('select') || $(mutation.addedNodes).is('select')) {
                  isSelectMutation = true;
                  return true;
                }
              });
              if (isSelectMutation) {
                module.disconnect.selectObserver();
                module.refresh();
                module.setup.select();
                module.set.selected();
                module.observe.select();
              }
            }
          },
          menu: {
            mutation: function mutation(mutations) {
              var mutation = mutations[0],
                  $addedNode = mutation.addedNodes ? $(mutation.addedNodes[0]) : $(false),
                  $removedNode = mutation.removedNodes ? $(mutation.removedNodes[0]) : $(false),
                  $changedNodes = $addedNode.add($removedNode),
                  isUserAddition = $changedNodes.is(selector.addition) || $changedNodes.closest(selector.addition).length > 0,
                  isMessage = $changedNodes.is(selector.message) || $changedNodes.closest(selector.message).length > 0;
              if (isUserAddition || isMessage) {
                module.debug('Updating item selector cache');
                module.refreshItems();
              } else {
                module.debug('Menu modified, updating selector cache');
                module.refresh();
              }
            },
            mousedown: function mousedown() {
              itemActivated = true;
            },
            mouseup: function mouseup() {
              itemActivated = false;
            }
          },
          item: {
            mouseenter: function mouseenter(event) {
              var $target = $(event.target),
                  $item = $(this),
                  $subMenu = $item.children(selector.menu),
                  $otherMenus = $item.siblings(selector.item).children(selector.menu),
                  hasSubMenu = $subMenu.length > 0,
                  isBubbledEvent = $subMenu.find($target).length > 0;
              if (!isBubbledEvent && hasSubMenu) {
                clearTimeout(module.itemTimer);
                module.itemTimer = setTimeout(function () {
                  module.verbose('Showing sub-menu', $subMenu);
                  $.each($otherMenus, function () {
                    module.animate.hide(false, $(this));
                  });
                  module.animate.show(false, $subMenu);
                }, settings.delay.show);
                event.preventDefault();
              }
            },
            mouseleave: function mouseleave(event) {
              var $subMenu = $(this).children(selector.menu);
              if ($subMenu.length > 0) {
                clearTimeout(module.itemTimer);
                module.itemTimer = setTimeout(function () {
                  module.verbose('Hiding sub-menu', $subMenu);
                  module.animate.hide(false, $subMenu);
                }, settings.delay.hide);
              }
            },
            click: function click(event, skipRefocus) {
              var $choice = $(this),
                  $target = event ? $(event.target) : $(''),
                  $subMenu = $choice.find(selector.menu),
                  text = module.get.choiceText($choice),
                  value = module.get.choiceValue($choice, text),
                  hasSubMenu = $subMenu.length > 0,
                  isBubbledEvent = $subMenu.find($target).length > 0;
              // prevents IE11 bug where menu receives focus even though `tabindex=-1`
              if (module.has.menuSearch()) {
                $(document.activeElement).blur();
              }
              if (!isBubbledEvent && (!hasSubMenu || settings.allowCategorySelection)) {
                if (module.is.searchSelection()) {
                  if (settings.allowAdditions) {
                    module.remove.userAddition();
                  }
                  module.remove.searchTerm();
                  if (!module.is.focusedOnSearch() && !(skipRefocus == true)) {
                    module.focusSearch(true);
                  }
                }
                if (!settings.useLabels) {
                  module.remove.filteredItem();
                  module.set.scrollPosition($choice);
                }
                module.determine.selectAction.call(this, text, value);
              }
            }
          },

          document: {
            // label selection should occur even when element has no focus
            keydown: function keydown(event) {
              var pressedKey = event.which,
                  isShortcutKey = module.is.inObject(pressedKey, keys);
              if (isShortcutKey) {
                var $label = $module.find(selector.label),
                    $activeLabel = $label.filter('.' + className.active),
                    activeValue = $activeLabel.data(metadata.value),
                    labelIndex = $label.index($activeLabel),
                    labelCount = $label.length,
                    hasActiveLabel = $activeLabel.length > 0,
                    hasMultipleActive = $activeLabel.length > 1,
                    isFirstLabel = labelIndex === 0,
                    isLastLabel = labelIndex + 1 == labelCount,
                    isSearch = module.is.searchSelection(),
                    isFocusedOnSearch = module.is.focusedOnSearch(),
                    isFocused = module.is.focused(),
                    caretAtStart = isFocusedOnSearch && module.get.caretPosition() === 0,
                    $nextLabel;
                if (isSearch && !hasActiveLabel && !isFocusedOnSearch) {
                  return;
                }

                if (pressedKey == keys.leftArrow) {
                  // activate previous label
                  if ((isFocused || caretAtStart) && !hasActiveLabel) {
                    module.verbose('Selecting previous label');
                    $label.last().addClass(className.active);
                  } else if (hasActiveLabel) {
                    if (!event.shiftKey) {
                      module.verbose('Selecting previous label');
                      $label.removeClass(className.active);
                    } else {
                      module.verbose('Adding previous label to selection');
                    }
                    if (isFirstLabel && !hasMultipleActive) {
                      $activeLabel.addClass(className.active);
                    } else {
                      $activeLabel.prev(selector.siblingLabel).addClass(className.active).end();
                    }
                    event.preventDefault();
                  }
                } else if (pressedKey == keys.rightArrow) {
                  // activate first label
                  if (isFocused && !hasActiveLabel) {
                    $label.first().addClass(className.active);
                  }
                  // activate next label
                  if (hasActiveLabel) {
                    if (!event.shiftKey) {
                      module.verbose('Selecting next label');
                      $label.removeClass(className.active);
                    } else {
                      module.verbose('Adding next label to selection');
                    }
                    if (isLastLabel) {
                      if (isSearch) {
                        if (!isFocusedOnSearch) {
                          module.focusSearch();
                        } else {
                          $label.removeClass(className.active);
                        }
                      } else if (hasMultipleActive) {
                        $activeLabel.next(selector.siblingLabel).addClass(className.active);
                      } else {
                        $activeLabel.addClass(className.active);
                      }
                    } else {
                      $activeLabel.next(selector.siblingLabel).addClass(className.active);
                    }
                    event.preventDefault();
                  }
                } else if (pressedKey == keys.deleteKey || pressedKey == keys.backspace) {
                  if (hasActiveLabel) {
                    module.verbose('Removing active labels');
                    if (isLastLabel) {
                      if (isSearch && !isFocusedOnSearch) {
                        module.focusSearch();
                      }
                    }
                    $activeLabel.last().next(selector.siblingLabel).addClass(className.active);
                    module.remove.activeLabels($activeLabel);
                    event.preventDefault();
                  } else if (caretAtStart && !hasActiveLabel && pressedKey == keys.backspace) {
                    module.verbose('Removing last label on input backspace');
                    $activeLabel = $label.last().addClass(className.active);
                    module.remove.activeLabels($activeLabel);
                  }
                } else {
                  $activeLabel.removeClass(className.active);
                }
              }
            }
          },

          keydown: function keydown(event) {
            var pressedKey = event.which,
                isShortcutKey = module.is.inObject(pressedKey, keys);
            if (isShortcutKey) {
              var $currentlySelected = $item.not(selector.unselectable).filter('.' + className.selected).eq(0),
                  $activeItem = $menu.children('.' + className.active).eq(0),
                  $selectedItem = $currentlySelected.length > 0 ? $currentlySelected : $activeItem,
                  $visibleItems = $selectedItem.length > 0 ? $selectedItem.siblings(':not(.' + className.filtered + ')').addBack() : $menu.children(':not(.' + className.filtered + ')'),
                  $subMenu = $selectedItem.children(selector.menu),
                  $parentMenu = $selectedItem.closest(selector.menu),
                  inVisibleMenu = $parentMenu.hasClass(className.visible) || $parentMenu.hasClass(className.animating) || $parentMenu.parent(selector.menu).length > 0,
                  hasSubMenu = $subMenu.length > 0,
                  hasSelectedItem = $selectedItem.length > 0,
                  selectedIsSelectable = $selectedItem.not(selector.unselectable).length > 0,
                  delimiterPressed = pressedKey == keys.delimiter && settings.allowAdditions && module.is.multiple(),
                  isAdditionWithoutMenu = settings.allowAdditions && settings.hideAdditions && (pressedKey == keys.enter || delimiterPressed) && selectedIsSelectable,
                  $nextItem,
                  isSubMenuItem,
                  newIndex;
              // allow selection with menu closed
              if (isAdditionWithoutMenu) {
                module.verbose('Selecting item from keyboard shortcut', $selectedItem);
                module.event.item.click.call($selectedItem, event);
                if (module.is.searchSelection()) {
                  module.remove.searchTerm();
                }
              }

              // visible menu keyboard shortcuts
              if (module.is.visible()) {

                // enter (select or open sub-menu)
                if (pressedKey == keys.enter || delimiterPressed) {
                  if (pressedKey == keys.enter && hasSelectedItem && hasSubMenu && !settings.allowCategorySelection) {
                    module.verbose('Pressed enter on unselectable category, opening sub menu');
                    pressedKey = keys.rightArrow;
                  } else if (selectedIsSelectable) {
                    module.verbose('Selecting item from keyboard shortcut', $selectedItem);
                    module.event.item.click.call($selectedItem, event);
                    if (module.is.searchSelection()) {
                      module.remove.searchTerm();
                    }
                  }
                  event.preventDefault();
                }

                // sub-menu actions
                if (hasSelectedItem) {

                  if (pressedKey == keys.leftArrow) {

                    isSubMenuItem = $parentMenu[0] !== $menu[0];

                    if (isSubMenuItem) {
                      module.verbose('Left key pressed, closing sub-menu');
                      module.animate.hide(false, $parentMenu);
                      $selectedItem.removeClass(className.selected);
                      $parentMenu.closest(selector.item).addClass(className.selected);
                      event.preventDefault();
                    }
                  }

                  // right arrow (show sub-menu)
                  if (pressedKey == keys.rightArrow) {
                    if (hasSubMenu) {
                      module.verbose('Right key pressed, opening sub-menu');
                      module.animate.show(false, $subMenu);
                      $selectedItem.removeClass(className.selected);
                      $subMenu.find(selector.item).eq(0).addClass(className.selected);
                      event.preventDefault();
                    }
                  }
                }

                // up arrow (traverse menu up)
                if (pressedKey == keys.upArrow) {
                  $nextItem = hasSelectedItem && inVisibleMenu ? $selectedItem.prevAll(selector.item + ':not(' + selector.unselectable + ')').eq(0) : $item.eq(0);
                  if ($visibleItems.index($nextItem) < 0) {
                    module.verbose('Up key pressed but reached top of current menu');
                    event.preventDefault();
                    return;
                  } else {
                    module.verbose('Up key pressed, changing active item');
                    $selectedItem.removeClass(className.selected);
                    $nextItem.addClass(className.selected);
                    module.set.scrollPosition($nextItem);
                    if (settings.selectOnKeydown && module.is.single()) {
                      module.set.selectedItem($nextItem);
                    }
                  }
                  event.preventDefault();
                }

                // down arrow (traverse menu down)
                if (pressedKey == keys.downArrow) {
                  $nextItem = hasSelectedItem && inVisibleMenu ? $nextItem = $selectedItem.nextAll(selector.item + ':not(' + selector.unselectable + ')').eq(0) : $item.eq(0);
                  if ($nextItem.length === 0) {
                    module.verbose('Down key pressed but reached bottom of current menu');
                    event.preventDefault();
                    return;
                  } else {
                    module.verbose('Down key pressed, changing active item');
                    $item.removeClass(className.selected);
                    $nextItem.addClass(className.selected);
                    module.set.scrollPosition($nextItem);
                    if (settings.selectOnKeydown && module.is.single()) {
                      module.set.selectedItem($nextItem);
                    }
                  }
                  event.preventDefault();
                }

                // page down (show next page)
                if (pressedKey == keys.pageUp) {
                  module.scrollPage('up');
                  event.preventDefault();
                }
                if (pressedKey == keys.pageDown) {
                  module.scrollPage('down');
                  event.preventDefault();
                }

                // escape (close menu)
                if (pressedKey == keys.escape) {
                  module.verbose('Escape key pressed, closing dropdown');
                  module.hide();
                }
              } else {
                // delimiter key
                if (delimiterPressed) {
                  event.preventDefault();
                }
                // down arrow (open menu)
                if (pressedKey == keys.downArrow && !module.is.visible()) {
                  module.verbose('Down key pressed, showing dropdown');
                  module.show();
                  event.preventDefault();
                }
              }
            } else {
              if (!module.has.search()) {
                module.set.selectedLetter(String.fromCharCode(pressedKey));
              }
            }
          }
        },

        trigger: {
          change: function change() {
            var events = document.createEvent('HTMLEvents'),
                inputElement = $input[0];
            if (inputElement) {
              module.verbose('Triggering native change event');
              events.initEvent('change', true, false);
              inputElement.dispatchEvent(events);
            }
          }
        },

        determine: {
          selectAction: function selectAction(text, value) {
            module.verbose('Determining action', settings.action);
            if ($.isFunction(module.action[settings.action])) {
              module.verbose('Triggering preset action', settings.action, text, value);
              module.action[settings.action].call(element, text, value, this);
            } else if ($.isFunction(settings.action)) {
              module.verbose('Triggering user action', settings.action, text, value);
              settings.action.call(element, text, value, this);
            } else {
              module.error(error.action, settings.action);
            }
          },
          eventInModule: function eventInModule(event, callback) {
            var $target = $(event.target),
                inDocument = $target.closest(document.documentElement).length > 0,
                inModule = $target.closest($module).length > 0;
            callback = $.isFunction(callback) ? callback : function () {};
            if (inDocument && !inModule) {
              module.verbose('Triggering event', callback);
              callback();
              return true;
            } else {
              module.verbose('Event occurred in dropdown, canceling callback');
              return false;
            }
          },
          eventOnElement: function eventOnElement(event, callback) {
            var $target = $(event.target),
                $label = $target.closest(selector.siblingLabel),
                inVisibleDOM = document.body.contains(event.target),
                notOnLabel = $module.find($label).length === 0,
                notInMenu = $target.closest($menu).length === 0;
            callback = $.isFunction(callback) ? callback : function () {};
            if (inVisibleDOM && notOnLabel && notInMenu) {
              module.verbose('Triggering event', callback);
              callback();
              return true;
            } else {
              module.verbose('Event occurred in dropdown menu, canceling callback');
              return false;
            }
          }
        },

        action: {

          nothing: function nothing() {},

          activate: function activate(text, value, element) {
            value = value !== undefined ? value : text;
            if (module.can.activate($(element))) {
              module.set.selected(value, $(element));
              if (module.is.multiple() && !module.is.allFiltered()) {
                return;
              } else {
                module.hideAndClear();
              }
            }
          },

          select: function select(text, value, element) {
            value = value !== undefined ? value : text;
            if (module.can.activate($(element))) {
              module.set.value(value, text, $(element));
              if (module.is.multiple() && !module.is.allFiltered()) {
                return;
              } else {
                module.hideAndClear();
              }
            }
          },

          combo: function combo(text, value, element) {
            value = value !== undefined ? value : text;
            module.set.selected(value, $(element));
            module.hideAndClear();
          },

          hide: function hide(text, value, element) {
            module.set.value(value, text, $(element));
            module.hideAndClear();
          }

        },

        get: {
          id: function id() {
            return _id2;
          },
          defaultText: function defaultText() {
            return $module.data(metadata.defaultText);
          },
          defaultValue: function defaultValue() {
            return $module.data(metadata.defaultValue);
          },
          placeholderText: function placeholderText() {
            if (settings.placeholder != 'auto' && typeof settings.placeholder == 'string') {
              return settings.placeholder;
            }
            return $module.data(metadata.placeholderText) || '';
          },
          text: function text() {
            return $text.text();
          },
          query: function query() {
            return $.trim($search.val());
          },
          searchWidth: function searchWidth(value) {
            value = value !== undefined ? value : $search.val();
            $sizer.text(value);
            // prevent rounding issues
            return Math.ceil($sizer.width() + 1);
          },
          selectionCount: function selectionCount() {
            var values = module.get.values(),
                count;
            count = module.is.multiple() ? $.isArray(values) ? values.length : 0 : module.get.value() !== '' ? 1 : 0;
            return count;
          },
          transition: function transition($subMenu) {
            return settings.transition == 'auto' ? module.is.upward($subMenu) ? 'slide up' : 'slide down' : settings.transition;
          },
          userValues: function userValues() {
            var values = module.get.values();
            if (!values) {
              return false;
            }
            values = $.isArray(values) ? values : [values];
            return $.grep(values, function (value) {
              return module.get.item(value) === false;
            });
          },
          uniqueArray: function uniqueArray(array) {
            return $.grep(array, function (value, index) {
              return $.inArray(value, array) === index;
            });
          },
          caretPosition: function caretPosition() {
            var input = $search.get(0),
                range,
                rangeLength;
            if ('selectionStart' in input) {
              return input.selectionStart;
            } else if (document.selection) {
              input.focus();
              range = document.selection.createRange();
              rangeLength = range.text.length;
              range.moveStart('character', -input.value.length);
              return range.text.length - rangeLength;
            }
          },
          value: function value() {
            var value = $input.length > 0 ? $input.val() : $module.data(metadata.value),
                isEmptyMultiselect = $.isArray(value) && value.length === 1 && value[0] === '';
            // prevents placeholder element from being selected when multiple
            return value === undefined || isEmptyMultiselect ? '' : value;
          },
          values: function values() {
            var value = module.get.value();
            if (value === '') {
              return '';
            }
            return !module.has.selectInput() && module.is.multiple() ? typeof value == 'string' ? // delimited string
            value.split(settings.delimiter) : '' : value;
          },
          remoteValues: function remoteValues() {
            var values = module.get.values(),
                remoteValues = false;
            if (values) {
              if (typeof values == 'string') {
                values = [values];
              }
              $.each(values, function (index, value) {
                var name = module.read.remoteData(value);
                module.verbose('Restoring value from session data', name, value);
                if (name) {
                  if (!remoteValues) {
                    remoteValues = {};
                  }
                  remoteValues[value] = name;
                }
              });
            }
            return remoteValues;
          },
          choiceText: function choiceText($choice, preserveHTML) {
            preserveHTML = preserveHTML !== undefined ? preserveHTML : settings.preserveHTML;
            if ($choice) {
              if ($choice.find(selector.menu).length > 0) {
                module.verbose('Retrieving text of element with sub-menu');
                $choice = $choice.clone();
                $choice.find(selector.menu).remove();
                $choice.find(selector.menuIcon).remove();
              }
              return $choice.data(metadata.text) !== undefined ? $choice.data(metadata.text) : preserveHTML ? $.trim($choice.html()) : $.trim($choice.text());
            }
          },
          choiceValue: function choiceValue($choice, choiceText) {
            choiceText = choiceText || module.get.choiceText($choice);
            if (!$choice) {
              return false;
            }
            return $choice.data(metadata.value) !== undefined ? String($choice.data(metadata.value)) : typeof choiceText === 'string' ? $.trim(choiceText.toLowerCase()) : String(choiceText);
          },
          inputEvent: function inputEvent() {
            var input = $search[0];
            if (input) {
              return input.oninput !== undefined ? 'input' : input.onpropertychange !== undefined ? 'propertychange' : 'keyup';
            }
            return false;
          },
          selectValues: function selectValues() {
            var select = {};
            select.values = [];
            $module.find('option').each(function () {
              var $option = $(this),
                  name = $option.html(),
                  disabled = $option.attr('disabled'),
                  value = $option.attr('value') !== undefined ? $option.attr('value') : name;
              if (settings.placeholder === 'auto' && value === '') {
                select.placeholder = name;
              } else {
                select.values.push({
                  name: name,
                  value: value,
                  disabled: disabled
                });
              }
            });
            if (settings.placeholder && settings.placeholder !== 'auto') {
              module.debug('Setting placeholder value to', settings.placeholder);
              select.placeholder = settings.placeholder;
            }
            if (settings.sortSelect) {
              select.values.sort(function (a, b) {
                return a.name > b.name ? 1 : -1;
              });
              module.debug('Retrieved and sorted values from select', select);
            } else {
              module.debug('Retrieved values from select', select);
            }
            return select;
          },
          activeItem: function activeItem() {
            return $item.filter('.' + className.active);
          },
          selectedItem: function selectedItem() {
            var $selectedItem = $item.not(selector.unselectable).filter('.' + className.selected);
            return $selectedItem.length > 0 ? $selectedItem : $item.eq(0);
          },
          itemWithAdditions: function itemWithAdditions(value) {
            var $items = module.get.item(value),
                $userItems = module.create.userChoice(value),
                hasUserItems = $userItems && $userItems.length > 0;
            if (hasUserItems) {
              $items = $items.length > 0 ? $items.add($userItems) : $userItems;
            }
            return $items;
          },
          item: function item(value, strict) {
            var $selectedItem = false,
                shouldSearch,
                isMultiple;
            value = value !== undefined ? value : module.get.values() !== undefined ? module.get.values() : module.get.text();
            shouldSearch = isMultiple ? value.length > 0 : value !== undefined && value !== null;
            isMultiple = module.is.multiple() && $.isArray(value);
            strict = value === '' || value === 0 ? true : strict || false;
            if (shouldSearch) {
              $item.each(function () {
                var $choice = $(this),
                    optionText = module.get.choiceText($choice),
                    optionValue = module.get.choiceValue($choice, optionText);
                // safe early exit
                if (optionValue === null || optionValue === undefined) {
                  return;
                }
                if (isMultiple) {
                  if ($.inArray(String(optionValue), value) !== -1 || $.inArray(optionText, value) !== -1) {
                    $selectedItem = $selectedItem ? $selectedItem.add($choice) : $choice;
                  }
                } else if (strict) {
                  module.verbose('Ambiguous dropdown value using strict type check', $choice, value);
                  if (optionValue === value || optionText === value) {
                    $selectedItem = $choice;
                    return true;
                  }
                } else {
                  if (String(optionValue) == String(value) || optionText == value) {
                    module.verbose('Found select item by value', optionValue, value);
                    $selectedItem = $choice;
                    return true;
                  }
                }
              });
            }
            return $selectedItem;
          }
        },

        check: {
          maxSelections: function maxSelections(selectionCount) {
            if (settings.maxSelections) {
              selectionCount = selectionCount !== undefined ? selectionCount : module.get.selectionCount();
              if (selectionCount >= settings.maxSelections) {
                module.debug('Maximum selection count reached');
                if (settings.useLabels) {
                  $item.addClass(className.filtered);
                  module.add.message(message.maxSelections);
                }
                return true;
              } else {
                module.verbose('No longer at maximum selection count');
                module.remove.message();
                module.remove.filteredItem();
                if (module.is.searchSelection()) {
                  module.filterItems();
                }
                return false;
              }
            }
            return true;
          }
        },

        restore: {
          defaults: function defaults() {
            module.clear();
            module.restore.defaultText();
            module.restore.defaultValue();
          },
          defaultText: function defaultText() {
            var defaultText = module.get.defaultText(),
                placeholderText = module.get.placeholderText;
            if (defaultText === placeholderText) {
              module.debug('Restoring default placeholder text', defaultText);
              module.set.placeholderText(defaultText);
            } else {
              module.debug('Restoring default text', defaultText);
              module.set.text(defaultText);
            }
          },
          placeholderText: function placeholderText() {
            module.set.placeholderText();
          },
          defaultValue: function defaultValue() {
            var defaultValue = module.get.defaultValue();
            if (defaultValue !== undefined) {
              module.debug('Restoring default value', defaultValue);
              if (defaultValue !== '') {
                module.set.value(defaultValue);
                module.set.selected();
              } else {
                module.remove.activeItem();
                module.remove.selectedItem();
              }
            }
          },
          labels: function labels() {
            if (settings.allowAdditions) {
              if (!settings.useLabels) {
                module.error(error.labels);
                settings.useLabels = true;
              }
              module.debug('Restoring selected values');
              module.create.userLabels();
            }
            module.check.maxSelections();
          },
          selected: function selected() {
            module.restore.values();
            if (module.is.multiple()) {
              module.debug('Restoring previously selected values and labels');
              module.restore.labels();
            } else {
              module.debug('Restoring previously selected values');
            }
          },
          values: function values() {
            // prevents callbacks from occurring on initial load
            module.set.initialLoad();
            if (settings.apiSettings && settings.saveRemoteData && module.get.remoteValues()) {
              module.restore.remoteValues();
            } else {
              module.set.selected();
            }
            module.remove.initialLoad();
          },
          remoteValues: function remoteValues() {
            var values = module.get.remoteValues();
            module.debug('Recreating selected from session data', values);
            if (values) {
              if (module.is.single()) {
                $.each(values, function (value, name) {
                  module.set.text(name);
                });
              } else {
                $.each(values, function (value, name) {
                  module.add.label(value, name);
                });
              }
            }
          }
        },

        read: {
          remoteData: function remoteData(value) {
            var name;
            if (window.Storage === undefined) {
              module.error(error.noStorage);
              return;
            }
            name = sessionStorage.getItem(value);
            return name !== undefined ? name : false;
          }
        },

        save: {
          defaults: function defaults() {
            module.save.defaultText();
            module.save.placeholderText();
            module.save.defaultValue();
          },
          defaultValue: function defaultValue() {
            var value = module.get.value();
            module.verbose('Saving default value as', value);
            $module.data(metadata.defaultValue, value);
          },
          defaultText: function defaultText() {
            var text = module.get.text();
            module.verbose('Saving default text as', text);
            $module.data(metadata.defaultText, text);
          },
          placeholderText: function placeholderText() {
            var text;
            if (settings.placeholder !== false && $text.hasClass(className.placeholder)) {
              text = module.get.text();
              module.verbose('Saving placeholder text as', text);
              $module.data(metadata.placeholderText, text);
            }
          },
          remoteData: function remoteData(name, value) {
            if (window.Storage === undefined) {
              module.error(error.noStorage);
              return;
            }
            module.verbose('Saving remote data to session storage', value, name);
            sessionStorage.setItem(value, name);
          }
        },

        clear: function clear() {
          if (module.is.multiple() && settings.useLabels) {
            module.remove.labels();
          } else {
            module.remove.activeItem();
            module.remove.selectedItem();
          }
          module.set.placeholderText();
          module.clearValue();
        },

        clearValue: function clearValue() {
          module.set.value('');
        },

        scrollPage: function scrollPage(direction, $selectedItem) {
          var $currentItem = $selectedItem || module.get.selectedItem(),
              $menu = $currentItem.closest(selector.menu),
              menuHeight = $menu.outerHeight(),
              currentScroll = $menu.scrollTop(),
              itemHeight = $item.eq(0).outerHeight(),
              itemsPerPage = Math.floor(menuHeight / itemHeight),
              maxScroll = $menu.prop('scrollHeight'),
              newScroll = direction == 'up' ? currentScroll - itemHeight * itemsPerPage : currentScroll + itemHeight * itemsPerPage,
              $selectableItem = $item.not(selector.unselectable),
              isWithinRange,
              $nextSelectedItem,
              elementIndex;
          elementIndex = direction == 'up' ? $selectableItem.index($currentItem) - itemsPerPage : $selectableItem.index($currentItem) + itemsPerPage;
          isWithinRange = direction == 'up' ? elementIndex >= 0 : elementIndex < $selectableItem.length;
          $nextSelectedItem = isWithinRange ? $selectableItem.eq(elementIndex) : direction == 'up' ? $selectableItem.first() : $selectableItem.last();
          if ($nextSelectedItem.length > 0) {
            module.debug('Scrolling page', direction, $nextSelectedItem);
            $currentItem.removeClass(className.selected);
            $nextSelectedItem.addClass(className.selected);
            if (settings.selectOnKeydown && module.is.single()) {
              module.set.selectedItem($nextSelectedItem);
            }
            $menu.scrollTop(newScroll);
          }
        },

        set: {
          filtered: function filtered() {
            var isMultiple = module.is.multiple(),
                isSearch = module.is.searchSelection(),
                isSearchMultiple = isMultiple && isSearch,
                searchValue = isSearch ? module.get.query() : '',
                hasSearchValue = typeof searchValue === 'string' && searchValue.length > 0,
                searchWidth = module.get.searchWidth(),
                valueIsSet = searchValue !== '';
            if (isMultiple && hasSearchValue) {
              module.verbose('Adjusting input width', searchWidth, settings.glyphWidth);
              $search.css('width', searchWidth);
            }
            if (hasSearchValue || isSearchMultiple && valueIsSet) {
              module.verbose('Hiding placeholder text');
              $text.addClass(className.filtered);
            } else if (!isMultiple || isSearchMultiple && !valueIsSet) {
              module.verbose('Showing placeholder text');
              $text.removeClass(className.filtered);
            }
          },
          empty: function empty() {
            $module.addClass(className.empty);
          },
          loading: function loading() {
            $module.addClass(className.loading);
          },
          placeholderText: function placeholderText(text) {
            text = text || module.get.placeholderText();
            module.debug('Setting placeholder text', text);
            module.set.text(text);
            $text.addClass(className.placeholder);
          },
          tabbable: function tabbable() {
            if (module.is.searchSelection()) {
              module.debug('Added tabindex to searchable dropdown');
              $search.val('').attr('tabindex', 0);
              $menu.attr('tabindex', -1);
            } else {
              module.debug('Added tabindex to dropdown');
              if ($module.attr('tabindex') === undefined) {
                $module.attr('tabindex', 0);
                $menu.attr('tabindex', -1);
              }
            }
          },
          initialLoad: function initialLoad() {
            module.verbose('Setting initial load');
            _initialLoad2 = true;
          },
          activeItem: function activeItem($item) {
            if (settings.allowAdditions && $item.filter(selector.addition).length > 0) {
              $item.addClass(className.filtered);
            } else {
              $item.addClass(className.active);
            }
          },
          partialSearch: function partialSearch(text) {
            var length = module.get.query().length;
            $search.val(text.substr(0, length));
          },
          scrollPosition: function scrollPosition($item, forceScroll) {
            var edgeTolerance = 5,
                $menu,
                hasActive,
                offset,
                itemHeight,
                itemOffset,
                menuOffset,
                menuScroll,
                menuHeight,
                abovePage,
                belowPage;

            $item = $item || module.get.selectedItem();
            $menu = $item.closest(selector.menu);
            hasActive = $item && $item.length > 0;
            forceScroll = forceScroll !== undefined ? forceScroll : false;
            if ($item && $menu.length > 0 && hasActive) {
              itemOffset = $item.position().top;

              $menu.addClass(className.loading);
              menuScroll = $menu.scrollTop();
              menuOffset = $menu.offset().top;
              itemOffset = $item.offset().top;
              offset = menuScroll - menuOffset + itemOffset;
              if (!forceScroll) {
                menuHeight = $menu.height();
                belowPage = menuScroll + menuHeight < offset + edgeTolerance;
                abovePage = offset - edgeTolerance < menuScroll;
              }
              module.debug('Scrolling to active item', offset);
              if (forceScroll || abovePage || belowPage) {
                $menu.scrollTop(offset);
              }
              $menu.removeClass(className.loading);
            }
          },
          text: function text(_text) {
            if (settings.action !== 'select') {
              if (settings.action == 'combo') {
                module.debug('Changing combo button text', _text, $combo);
                if (settings.preserveHTML) {
                  $combo.html(_text);
                } else {
                  $combo.text(_text);
                }
              } else {
                if (_text !== module.get.placeholderText()) {
                  $text.removeClass(className.placeholder);
                }
                module.debug('Changing text', _text, $text);
                $text.removeClass(className.filtered);
                if (settings.preserveHTML) {
                  $text.html(_text);
                } else {
                  $text.text(_text);
                }
              }
            }
          },
          selectedItem: function selectedItem($item) {
            var value = module.get.choiceValue($item),
                searchText = module.get.choiceText($item, false),
                text = module.get.choiceText($item, true);
            module.debug('Setting user selection to item', $item);
            module.remove.activeItem();
            module.set.partialSearch(searchText);
            module.set.activeItem($item);
            module.set.selected(value, $item);
            module.set.text(text);
          },
          selectedLetter: function selectedLetter(letter) {
            var $selectedItem = $item.filter('.' + className.selected),
                alreadySelectedLetter = $selectedItem.length > 0 && module.has.firstLetter($selectedItem, letter),
                $nextValue = false,
                $nextItem;
            // check next of same letter
            if (alreadySelectedLetter) {
              $nextItem = $selectedItem.nextAll($item).eq(0);
              if (module.has.firstLetter($nextItem, letter)) {
                $nextValue = $nextItem;
              }
            }
            // check all values
            if (!$nextValue) {
              $item.each(function () {
                if (module.has.firstLetter($(this), letter)) {
                  $nextValue = $(this);
                  return false;
                }
              });
            }
            // set next value
            if ($nextValue) {
              module.verbose('Scrolling to next value with letter', letter);
              module.set.scrollPosition($nextValue);
              $selectedItem.removeClass(className.selected);
              $nextValue.addClass(className.selected);
              if (settings.selectOnKeydown && module.is.single()) {
                module.set.selectedItem($nextValue);
              }
            }
          },
          direction: function direction($menu) {
            if (settings.direction == 'auto') {
              // reset position
              module.remove.upward();

              if (module.can.openDownward($menu)) {
                module.remove.upward($menu);
              } else {
                module.set.upward($menu);
              }
              if (!module.is.leftward($menu) && !module.can.openRightward($menu)) {
                module.set.leftward($menu);
              }
            } else if (settings.direction == 'upward') {
              module.set.upward($menu);
            }
          },
          upward: function upward($currentMenu) {
            var $element = $currentMenu || $module;
            $element.addClass(className.upward);
          },
          leftward: function leftward($currentMenu) {
            var $element = $currentMenu || $menu;
            $element.addClass(className.leftward);
          },
          value: function value(_value, text, $selected) {
            var escapedValue = module.escape.value(_value),
                hasInput = $input.length > 0,
                currentValue = module.get.values(),
                stringValue = _value !== undefined ? String(_value) : _value,
                newValue;
            if (hasInput) {
              if (!settings.allowReselection && stringValue == currentValue) {
                module.verbose('Skipping value update already same value', _value, currentValue);
                if (!module.is.initialLoad()) {
                  return;
                }
              }

              if (module.is.single() && module.has.selectInput() && module.can.extendSelect()) {
                module.debug('Adding user option', _value);
                module.add.optionValue(_value);
              }
              module.debug('Updating input value', escapedValue, currentValue);
              internalChange = true;
              $input.val(escapedValue);
              if (settings.fireOnInit === false && module.is.initialLoad()) {
                module.debug('Input native change event ignored on initial load');
              } else {
                module.trigger.change();
              }
              internalChange = false;
            } else {
              module.verbose('Storing value in metadata', escapedValue, $input);
              if (escapedValue !== currentValue) {
                $module.data(metadata.value, stringValue);
              }
            }
            if (module.is.single() && settings.clearable) {
              // treat undefined or '' as empty
              if (!escapedValue) {
                module.remove.clearable();
              } else {
                module.set.clearable();
              }
            }
            if (settings.fireOnInit === false && module.is.initialLoad()) {
              module.verbose('No callback on initial load', settings.onChange);
            } else {
              settings.onChange.call(element, _value, text, $selected);
            }
          },
          active: function active() {
            $module.addClass(className.active);
          },
          multiple: function multiple() {
            $module.addClass(className.multiple);
          },
          visible: function visible() {
            $module.addClass(className.visible);
          },
          exactly: function exactly(value, $selectedItem) {
            module.debug('Setting selected to exact values');
            module.clear();
            module.set.selected(value, $selectedItem);
          },
          selected: function selected(value, $selectedItem) {
            var isMultiple = module.is.multiple(),
                $userSelectedItem;
            $selectedItem = settings.allowAdditions ? $selectedItem || module.get.itemWithAdditions(value) : $selectedItem || module.get.item(value);
            if (!$selectedItem) {
              return;
            }
            module.debug('Setting selected menu item to', $selectedItem);
            if (module.is.multiple()) {
              module.remove.searchWidth();
            }
            if (module.is.single()) {
              module.remove.activeItem();
              module.remove.selectedItem();
            } else if (settings.useLabels) {
              module.remove.selectedItem();
            }
            // select each item
            $selectedItem.each(function () {
              var $selected = $(this),
                  selectedText = module.get.choiceText($selected),
                  selectedValue = module.get.choiceValue($selected, selectedText),
                  isFiltered = $selected.hasClass(className.filtered),
                  isActive = $selected.hasClass(className.active),
                  isUserValue = $selected.hasClass(className.addition),
                  shouldAnimate = isMultiple && $selectedItem.length == 1;
              if (isMultiple) {
                if (!isActive || isUserValue) {
                  if (settings.apiSettings && settings.saveRemoteData) {
                    module.save.remoteData(selectedText, selectedValue);
                  }
                  if (settings.useLabels) {
                    module.add.label(selectedValue, selectedText, shouldAnimate);
                    module.add.value(selectedValue, selectedText, $selected);
                    module.set.activeItem($selected);
                    module.filterActive();
                    module.select.nextAvailable($selectedItem);
                  } else {
                    module.add.value(selectedValue, selectedText, $selected);
                    module.set.text(module.add.variables(message.count));
                    module.set.activeItem($selected);
                  }
                } else if (!isFiltered) {
                  module.debug('Selected active value, removing label');
                  module.remove.selected(selectedValue);
                }
              } else {
                if (settings.apiSettings && settings.saveRemoteData) {
                  module.save.remoteData(selectedText, selectedValue);
                }
                module.set.text(selectedText);
                module.set.value(selectedValue, selectedText, $selected);
                $selected.addClass(className.active).addClass(className.selected);
              }
            });
          },
          clearable: function clearable() {
            $icon.addClass(className.clear);
          }
        },

        add: {
          label: function label(value, text, shouldAnimate) {
            var $next = module.is.searchSelection() ? $search : $text,
                escapedValue = module.escape.value(value),
                $label;
            if (settings.ignoreCase) {
              escapedValue = escapedValue.toLowerCase();
            }
            $label = $('<a />').addClass(className.label).attr('data-' + metadata.value, escapedValue).html(templates.label(escapedValue, text));
            $label = settings.onLabelCreate.call($label, escapedValue, text);

            if (module.has.label(value)) {
              module.debug('User selection already exists, skipping', escapedValue);
              return;
            }
            if (settings.label.variation) {
              $label.addClass(settings.label.variation);
            }
            if (shouldAnimate === true) {
              module.debug('Animating in label', $label);
              $label.addClass(className.hidden).insertBefore($next).transition(settings.label.transition, settings.label.duration);
            } else {
              module.debug('Adding selection label', $label);
              $label.insertBefore($next);
            }
          },
          message: function message(_message) {
            var $message = $menu.children(selector.message),
                html = settings.templates.message(module.add.variables(_message));
            if ($message.length > 0) {
              $message.html(html);
            } else {
              $message = $('<div/>').html(html).addClass(className.message).appendTo($menu);
            }
          },
          optionValue: function optionValue(value) {
            var escapedValue = module.escape.value(value),
                $option = $input.find('option[value="' + module.escape.string(escapedValue) + '"]'),
                hasOption = $option.length > 0;
            if (hasOption) {
              return;
            }
            // temporarily disconnect observer
            module.disconnect.selectObserver();
            if (module.is.single()) {
              module.verbose('Removing previous user addition');
              $input.find('option.' + className.addition).remove();
            }
            $('<option/>').prop('value', escapedValue).addClass(className.addition).html(value).appendTo($input);
            module.verbose('Adding user addition as an <option>', value);
            module.observe.select();
          },
          userSuggestion: function userSuggestion(value) {
            var $addition = $menu.children(selector.addition),
                $existingItem = module.get.item(value),
                alreadyHasValue = $existingItem && $existingItem.not(selector.addition).length,
                hasUserSuggestion = $addition.length > 0,
                html;
            if (settings.useLabels && module.has.maxSelections()) {
              return;
            }
            if (value === '' || alreadyHasValue) {
              $addition.remove();
              return;
            }
            if (hasUserSuggestion) {
              $addition.data(metadata.value, value).data(metadata.text, value).attr('data-' + metadata.value, value).attr('data-' + metadata.text, value).removeClass(className.filtered);
              if (!settings.hideAdditions) {
                html = settings.templates.addition(module.add.variables(message.addResult, value));
                $addition.html(html);
              }
              module.verbose('Replacing user suggestion with new value', $addition);
            } else {
              $addition = module.create.userChoice(value);
              $addition.prependTo($menu);
              module.verbose('Adding item choice to menu corresponding with user choice addition', $addition);
            }
            if (!settings.hideAdditions || module.is.allFiltered()) {
              $addition.addClass(className.selected).siblings().removeClass(className.selected);
            }
            module.refreshItems();
          },
          variables: function variables(message, term) {
            var hasCount = message.search('{count}') !== -1,
                hasMaxCount = message.search('{maxCount}') !== -1,
                hasTerm = message.search('{term}') !== -1,
                values,
                count,
                query;
            module.verbose('Adding templated variables to message', message);
            if (hasCount) {
              count = module.get.selectionCount();
              message = message.replace('{count}', count);
            }
            if (hasMaxCount) {
              count = module.get.selectionCount();
              message = message.replace('{maxCount}', settings.maxSelections);
            }
            if (hasTerm) {
              query = term || module.get.query();
              message = message.replace('{term}', query);
            }
            return message;
          },
          value: function value(addedValue, addedText, $selectedItem) {
            var currentValue = module.get.values(),
                newValue;
            if (module.has.value(addedValue)) {
              module.debug('Value already selected');
              return;
            }
            if (addedValue === '') {
              module.debug('Cannot select blank values from multiselect');
              return;
            }
            // extend current array
            if ($.isArray(currentValue)) {
              newValue = currentValue.concat([addedValue]);
              newValue = module.get.uniqueArray(newValue);
            } else {
              newValue = [addedValue];
            }
            // add values
            if (module.has.selectInput()) {
              if (module.can.extendSelect()) {
                module.debug('Adding value to select', addedValue, newValue, $input);
                module.add.optionValue(addedValue);
              }
            } else {
              newValue = newValue.join(settings.delimiter);
              module.debug('Setting hidden input to delimited value', newValue, $input);
            }

            if (settings.fireOnInit === false && module.is.initialLoad()) {
              module.verbose('Skipping onadd callback on initial load', settings.onAdd);
            } else {
              settings.onAdd.call(element, addedValue, addedText, $selectedItem);
            }
            module.set.value(newValue, addedValue, addedText, $selectedItem);
            module.check.maxSelections();
          }
        },

        remove: {
          active: function active() {
            $module.removeClass(className.active);
          },
          activeLabel: function activeLabel() {
            $module.find(selector.label).removeClass(className.active);
          },
          empty: function empty() {
            $module.removeClass(className.empty);
          },
          loading: function loading() {
            $module.removeClass(className.loading);
          },
          initialLoad: function initialLoad() {
            _initialLoad2 = false;
          },
          upward: function upward($currentMenu) {
            var $element = $currentMenu || $module;
            $element.removeClass(className.upward);
          },
          leftward: function leftward($currentMenu) {
            var $element = $currentMenu || $menu;
            $element.removeClass(className.leftward);
          },
          visible: function visible() {
            $module.removeClass(className.visible);
          },
          activeItem: function activeItem() {
            $item.removeClass(className.active);
          },
          filteredItem: function filteredItem() {
            if (settings.useLabels && module.has.maxSelections()) {
              return;
            }
            if (settings.useLabels && module.is.multiple()) {
              $item.not('.' + className.active).removeClass(className.filtered);
            } else {
              $item.removeClass(className.filtered);
            }
            module.remove.empty();
          },
          optionValue: function optionValue(value) {
            var escapedValue = module.escape.value(value),
                $option = $input.find('option[value="' + module.escape.string(escapedValue) + '"]'),
                hasOption = $option.length > 0;
            if (!hasOption || !$option.hasClass(className.addition)) {
              return;
            }
            // temporarily disconnect observer
            if (_selectObserver) {
              _selectObserver.disconnect();
              module.verbose('Temporarily disconnecting mutation observer');
            }
            $option.remove();
            module.verbose('Removing user addition as an <option>', escapedValue);
            if (_selectObserver) {
              _selectObserver.observe($input[0], {
                childList: true,
                subtree: true
              });
            }
          },
          message: function message() {
            $menu.children(selector.message).remove();
          },
          searchWidth: function searchWidth() {
            $search.css('width', '');
          },
          searchTerm: function searchTerm() {
            module.verbose('Cleared search term');
            $search.val('');
            module.set.filtered();
          },
          userAddition: function userAddition() {
            $item.filter(selector.addition).remove();
          },
          selected: function selected(value, $selectedItem) {
            $selectedItem = settings.allowAdditions ? $selectedItem || module.get.itemWithAdditions(value) : $selectedItem || module.get.item(value);

            if (!$selectedItem) {
              return false;
            }

            $selectedItem.each(function () {
              var $selected = $(this),
                  selectedText = module.get.choiceText($selected),
                  selectedValue = module.get.choiceValue($selected, selectedText);
              if (module.is.multiple()) {
                if (settings.useLabels) {
                  module.remove.value(selectedValue, selectedText, $selected);
                  module.remove.label(selectedValue);
                } else {
                  module.remove.value(selectedValue, selectedText, $selected);
                  if (module.get.selectionCount() === 0) {
                    module.set.placeholderText();
                  } else {
                    module.set.text(module.add.variables(message.count));
                  }
                }
              } else {
                module.remove.value(selectedValue, selectedText, $selected);
              }
              $selected.removeClass(className.filtered).removeClass(className.active);
              if (settings.useLabels) {
                $selected.removeClass(className.selected);
              }
            });
          },
          selectedItem: function selectedItem() {
            $item.removeClass(className.selected);
          },
          value: function value(removedValue, removedText, $removedItem) {
            var values = module.get.values(),
                newValue;
            if (module.has.selectInput()) {
              module.verbose('Input is <select> removing selected option', removedValue);
              newValue = module.remove.arrayValue(removedValue, values);
              module.remove.optionValue(removedValue);
            } else {
              module.verbose('Removing from delimited values', removedValue);
              newValue = module.remove.arrayValue(removedValue, values);
              newValue = newValue.join(settings.delimiter);
            }
            if (settings.fireOnInit === false && module.is.initialLoad()) {
              module.verbose('No callback on initial load', settings.onRemove);
            } else {
              settings.onRemove.call(element, removedValue, removedText, $removedItem);
            }
            module.set.value(newValue, removedText, $removedItem);
            module.check.maxSelections();
          },
          arrayValue: function arrayValue(removedValue, values) {
            if (!$.isArray(values)) {
              values = [values];
            }
            values = $.grep(values, function (value) {
              return removedValue != value;
            });
            module.verbose('Removed value from delimited string', removedValue, values);
            return values;
          },
          label: function label(value, shouldAnimate) {
            var $labels = $module.find(selector.label),
                $removedLabel = $labels.filter('[data-' + metadata.value + '="' + module.escape.string(value) + '"]');
            module.verbose('Removing label', $removedLabel);
            $removedLabel.remove();
          },
          activeLabels: function activeLabels($activeLabels) {
            $activeLabels = $activeLabels || $module.find(selector.label).filter('.' + className.active);
            module.verbose('Removing active label selections', $activeLabels);
            module.remove.labels($activeLabels);
          },
          labels: function labels($labels) {
            $labels = $labels || $module.find(selector.label);
            module.verbose('Removing labels', $labels);
            $labels.each(function () {
              var $label = $(this),
                  value = $label.data(metadata.value),
                  stringValue = value !== undefined ? String(value) : value,
                  isUserValue = module.is.userValue(stringValue);
              if (settings.onLabelRemove.call($label, value) === false) {
                module.debug('Label remove callback cancelled removal');
                return;
              }
              module.remove.message();
              if (isUserValue) {
                module.remove.value(stringValue);
                module.remove.label(stringValue);
              } else {
                // selected will also remove label
                module.remove.selected(stringValue);
              }
            });
          },
          tabbable: function tabbable() {
            if (module.is.searchSelection()) {
              module.debug('Searchable dropdown initialized');
              $search.removeAttr('tabindex');
              $menu.removeAttr('tabindex');
            } else {
              module.debug('Simple selection dropdown initialized');
              $module.removeAttr('tabindex');
              $menu.removeAttr('tabindex');
            }
          },
          clearable: function clearable() {
            $icon.removeClass(className.clear);
          }
        },

        has: {
          menuSearch: function menuSearch() {
            return module.has.search() && $search.closest($menu).length > 0;
          },
          search: function search() {
            return $search.length > 0;
          },
          sizer: function sizer() {
            return $sizer.length > 0;
          },
          selectInput: function selectInput() {
            return $input.is('select');
          },
          minCharacters: function minCharacters(searchTerm) {
            if (settings.minCharacters) {
              searchTerm = searchTerm !== undefined ? String(searchTerm) : String(module.get.query());
              return searchTerm.length >= settings.minCharacters;
            }
            return true;
          },
          firstLetter: function firstLetter($item, letter) {
            var text, firstLetter;
            if (!$item || $item.length === 0 || typeof letter !== 'string') {
              return false;
            }
            text = module.get.choiceText($item, false);
            letter = letter.toLowerCase();
            firstLetter = String(text).charAt(0).toLowerCase();
            return letter == firstLetter;
          },
          input: function input() {
            return $input.length > 0;
          },
          items: function items() {
            return $item.length > 0;
          },
          menu: function menu() {
            return $menu.length > 0;
          },
          message: function message() {
            return $menu.children(selector.message).length !== 0;
          },
          label: function label(value) {
            var escapedValue = module.escape.value(value),
                $labels = $module.find(selector.label);
            if (settings.ignoreCase) {
              escapedValue = escapedValue.toLowerCase();
            }
            return $labels.filter('[data-' + metadata.value + '="' + module.escape.string(escapedValue) + '"]').length > 0;
          },
          maxSelections: function maxSelections() {
            return settings.maxSelections && module.get.selectionCount() >= settings.maxSelections;
          },
          allResultsFiltered: function allResultsFiltered() {
            var $normalResults = $item.not(selector.addition);
            return $normalResults.filter(selector.unselectable).length === $normalResults.length;
          },
          userSuggestion: function userSuggestion() {
            return $menu.children(selector.addition).length > 0;
          },
          query: function query() {
            return module.get.query() !== '';
          },
          value: function value(_value2) {
            return settings.ignoreCase ? module.has.valueIgnoringCase(_value2) : module.has.valueMatchingCase(_value2);
          },
          valueMatchingCase: function valueMatchingCase(value) {
            var values = module.get.values(),
                hasValue = $.isArray(values) ? values && $.inArray(value, values) !== -1 : values == value;
            return hasValue ? true : false;
          },
          valueIgnoringCase: function valueIgnoringCase(value) {
            var values = module.get.values(),
                hasValue = false;
            if (!$.isArray(values)) {
              values = [values];
            }
            $.each(values, function (index, existingValue) {
              if (String(value).toLowerCase() == String(existingValue).toLowerCase()) {
                hasValue = true;
                return false;
              }
            });
            return hasValue;
          }
        },

        is: {
          active: function active() {
            return $module.hasClass(className.active);
          },
          animatingInward: function animatingInward() {
            return $menu.transition('is inward');
          },
          animatingOutward: function animatingOutward() {
            return $menu.transition('is outward');
          },
          bubbledLabelClick: function bubbledLabelClick(event) {
            return $(event.target).is('select, input') && $module.closest('label').length > 0;
          },
          bubbledIconClick: function bubbledIconClick(event) {
            return $(event.target).closest($icon).length > 0;
          },
          alreadySetup: function alreadySetup() {
            return $module.is('select') && $module.parent(selector.dropdown).data(moduleNamespace) !== undefined && $module.prev().length === 0;
          },
          animating: function animating($subMenu) {
            return $subMenu ? $subMenu.transition && $subMenu.transition('is animating') : $menu.transition && $menu.transition('is animating');
          },
          leftward: function leftward($subMenu) {
            var $selectedMenu = $subMenu || $menu;
            return $selectedMenu.hasClass(className.leftward);
          },
          disabled: function disabled() {
            return $module.hasClass(className.disabled);
          },
          focused: function focused() {
            return document.activeElement === $module[0];
          },
          focusedOnSearch: function focusedOnSearch() {
            return document.activeElement === $search[0];
          },
          allFiltered: function allFiltered() {
            return (module.is.multiple() || module.has.search()) && !(settings.hideAdditions == false && module.has.userSuggestion()) && !module.has.message() && module.has.allResultsFiltered();
          },
          hidden: function hidden($subMenu) {
            return !module.is.visible($subMenu);
          },
          initialLoad: function initialLoad() {
            return _initialLoad2;
          },
          inObject: function inObject(needle, object) {
            var found = false;
            $.each(object, function (index, property) {
              if (property == needle) {
                found = true;
                return true;
              }
            });
            return found;
          },
          multiple: function multiple() {
            return $module.hasClass(className.multiple);
          },
          remote: function remote() {
            return settings.apiSettings && module.can.useAPI();
          },
          single: function single() {
            return !module.is.multiple();
          },
          selectMutation: function selectMutation(mutations) {
            var selectChanged = false;
            $.each(mutations, function (index, mutation) {
              if (mutation.target && $(mutation.target).is('select')) {
                selectChanged = true;
                return true;
              }
            });
            return selectChanged;
          },
          search: function search() {
            return $module.hasClass(className.search);
          },
          searchSelection: function searchSelection() {
            return module.has.search() && $search.parent(selector.dropdown).length === 1;
          },
          selection: function selection() {
            return $module.hasClass(className.selection);
          },
          userValue: function userValue(value) {
            return $.inArray(value, module.get.userValues()) !== -1;
          },
          upward: function upward($menu) {
            var $element = $menu || $module;
            return $element.hasClass(className.upward);
          },
          visible: function visible($subMenu) {
            return $subMenu ? $subMenu.hasClass(className.visible) : $menu.hasClass(className.visible);
          },
          verticallyScrollableContext: function verticallyScrollableContext() {
            var overflowY = $context.get(0) !== window ? $context.css('overflow-y') : false;
            return overflowY == 'auto' || overflowY == 'scroll';
          },
          horizontallyScrollableContext: function horizontallyScrollableContext() {
            var overflowX = $context.get(0) !== window ? $context.css('overflow-X') : false;
            return overflowX == 'auto' || overflowX == 'scroll';
          }
        },

        can: {
          activate: function activate($item) {
            if (settings.useLabels) {
              return true;
            }
            if (!module.has.maxSelections()) {
              return true;
            }
            if (module.has.maxSelections() && $item.hasClass(className.active)) {
              return true;
            }
            return false;
          },
          openDownward: function openDownward($subMenu) {
            var $currentMenu = $subMenu || $menu,
                canOpenDownward = true,
                onScreen = {},
                calculations;
            $currentMenu.addClass(className.loading);
            calculations = {
              context: {
                offset: $context.get(0) === window ? { top: 0, left: 0 } : $context.offset(),
                scrollTop: $context.scrollTop(),
                height: $context.outerHeight()
              },
              menu: {
                offset: $currentMenu.offset(),
                height: $currentMenu.outerHeight()
              }
            };
            if (module.is.verticallyScrollableContext()) {
              calculations.menu.offset.top += calculations.context.scrollTop;
            }
            onScreen = {
              above: calculations.context.scrollTop <= calculations.menu.offset.top - calculations.context.offset.top - calculations.menu.height,
              below: calculations.context.scrollTop + calculations.context.height >= calculations.menu.offset.top - calculations.context.offset.top + calculations.menu.height
            };
            if (onScreen.below) {
              module.verbose('Dropdown can fit in context downward', onScreen);
              canOpenDownward = true;
            } else if (!onScreen.below && !onScreen.above) {
              module.verbose('Dropdown cannot fit in either direction, favoring downward', onScreen);
              canOpenDownward = true;
            } else {
              module.verbose('Dropdown cannot fit below, opening upward', onScreen);
              canOpenDownward = false;
            }
            $currentMenu.removeClass(className.loading);
            return canOpenDownward;
          },
          openRightward: function openRightward($subMenu) {
            var $currentMenu = $subMenu || $menu,
                canOpenRightward = true,
                isOffscreenRight = false,
                calculations;
            $currentMenu.addClass(className.loading);
            calculations = {
              context: {
                offset: $context.get(0) === window ? { top: 0, left: 0 } : $context.offset(),
                scrollLeft: $context.scrollLeft(),
                width: $context.outerWidth()
              },
              menu: {
                offset: $currentMenu.offset(),
                width: $currentMenu.outerWidth()
              }
            };
            if (module.is.horizontallyScrollableContext()) {
              calculations.menu.offset.left += calculations.context.scrollLeft;
            }
            isOffscreenRight = calculations.menu.offset.left - calculations.context.offset.left + calculations.menu.width >= calculations.context.scrollLeft + calculations.context.width;
            if (isOffscreenRight) {
              module.verbose('Dropdown cannot fit in context rightward', isOffscreenRight);
              canOpenRightward = false;
            }
            $currentMenu.removeClass(className.loading);
            return canOpenRightward;
          },
          click: function click() {
            return hasTouch || settings.on == 'click';
          },
          extendSelect: function extendSelect() {
            return settings.allowAdditions || settings.apiSettings;
          },
          show: function show() {
            return !module.is.disabled() && (module.has.items() || module.has.message());
          },
          useAPI: function useAPI() {
            return $.fn.api !== undefined;
          }
        },

        animate: {
          show: function show(callback, $subMenu) {
            var $currentMenu = $subMenu || $menu,
                start = $subMenu ? function () {} : function () {
              module.hideSubMenus();
              module.hideOthers();
              module.set.active();
            },
                transition;
            callback = $.isFunction(callback) ? callback : function () {};
            module.verbose('Doing menu show animation', $currentMenu);
            module.set.direction($subMenu);
            transition = module.get.transition($subMenu);
            if (module.is.selection()) {
              module.set.scrollPosition(module.get.selectedItem(), true);
            }
            if (module.is.hidden($currentMenu) || module.is.animating($currentMenu)) {
              if (transition == 'none') {
                start();
                $currentMenu.transition('show');
                callback.call(element);
              } else if ($.fn.transition !== undefined && $module.transition('is supported')) {
                $currentMenu.transition({
                  animation: transition + ' in',
                  debug: settings.debug,
                  verbose: settings.verbose,
                  duration: settings.duration,
                  queue: true,
                  onStart: start,
                  onComplete: function onComplete() {
                    callback.call(element);
                  }
                });
              } else {
                module.error(error.noTransition, transition);
              }
            }
          },
          hide: function hide(callback, $subMenu) {
            var $currentMenu = $subMenu || $menu,
                duration = $subMenu ? settings.duration * 0.9 : settings.duration,
                start = $subMenu ? function () {} : function () {
              if (module.can.click()) {
                module.unbind.intent();
              }
              module.remove.active();
            },
                transition = module.get.transition($subMenu);
            callback = $.isFunction(callback) ? callback : function () {};
            if (module.is.visible($currentMenu) || module.is.animating($currentMenu)) {
              module.verbose('Doing menu hide animation', $currentMenu);

              if (transition == 'none') {
                start();
                $currentMenu.transition('hide');
                callback.call(element);
              } else if ($.fn.transition !== undefined && $module.transition('is supported')) {
                $currentMenu.transition({
                  animation: transition + ' out',
                  duration: settings.duration,
                  debug: settings.debug,
                  verbose: settings.verbose,
                  queue: false,
                  onStart: start,
                  onComplete: function onComplete() {
                    callback.call(element);
                  }
                });
              } else {
                module.error(error.transition);
              }
            }
          }
        },

        hideAndClear: function hideAndClear() {
          module.remove.searchTerm();
          if (module.has.maxSelections()) {
            return;
          }
          if (module.has.search()) {
            module.hide(function () {
              module.remove.filteredItem();
            });
          } else {
            module.hide();
          }
        },

        delay: {
          show: function show() {
            module.verbose('Delaying show event to ensure user intent');
            clearTimeout(module.timer);
            module.timer = setTimeout(module.show, settings.delay.show);
          },
          hide: function hide() {
            module.verbose('Delaying hide event to ensure user intent');
            clearTimeout(module.timer);
            module.timer = setTimeout(module.hide, settings.delay.hide);
          }
        },

        escape: {
          value: function value(_value3) {
            var multipleValues = $.isArray(_value3),
                stringValue = typeof _value3 === 'string',
                isUnparsable = !stringValue && !multipleValues,
                hasQuotes = stringValue && _value3.search(regExp.quote) !== -1,
                values = [];
            if (isUnparsable || !hasQuotes) {
              return _value3;
            }
            module.debug('Encoding quote values for use in select', _value3);
            if (multipleValues) {
              $.each(_value3, function (index, value) {
                values.push(value.replace(regExp.quote, '&quot;'));
              });
              return values;
            }
            return _value3.replace(regExp.quote, '&quot;');
          },
          string: function string(text) {
            text = String(text);
            return text.replace(regExp.escape, '\\$&');
          }
        },

        setting: function setting(name, value) {
          module.debug('Changing setting', name, value);
          if ($.isPlainObject(name)) {
            $.extend(true, settings, name);
          } else if (value !== undefined) {
            if ($.isPlainObject(settings[name])) {
              $.extend(true, settings[name], value);
            } else {
              settings[name] = value;
            }
          } else {
            return settings[name];
          }
        },
        internal: function internal(name, value) {
          if ($.isPlainObject(name)) {
            $.extend(true, module, name);
          } else if (value !== undefined) {
            module[name] = value;
          } else {
            return module[name];
          }
        },
        debug: function debug() {
          if (!settings.silent && settings.debug) {
            if (settings.performance) {
              module.performance.log(arguments);
            } else {
              module.debug = Function.prototype.bind.call(console.info, console, settings.name + ':');
              module.debug.apply(console, arguments);
            }
          }
        },
        verbose: function verbose() {
          if (!settings.silent && settings.verbose && settings.debug) {
            if (settings.performance) {
              module.performance.log(arguments);
            } else {
              module.verbose = Function.prototype.bind.call(console.info, console, settings.name + ':');
              module.verbose.apply(console, arguments);
            }
          }
        },
        error: function error() {
          if (!settings.silent) {
            module.error = Function.prototype.bind.call(console.error, console, settings.name + ':');
            module.error.apply(console, arguments);
          }
        },
        performance: {
          log: function log(message) {
            var currentTime, executionTime, previousTime;
            if (settings.performance) {
              currentTime = new Date().getTime();
              previousTime = time || currentTime;
              executionTime = currentTime - previousTime;
              time = currentTime;
              performance.push({
                'Name': message[0],
                'Arguments': [].slice.call(message, 1) || '',
                'Element': element,
                'Execution Time': executionTime
              });
            }
            clearTimeout(module.performance.timer);
            module.performance.timer = setTimeout(module.performance.display, 500);
          },
          display: function display() {
            var title = settings.name + ':',
                totalTime = 0;
            time = false;
            clearTimeout(module.performance.timer);
            $.each(performance, function (index, data) {
              totalTime += data['Execution Time'];
            });
            title += ' ' + totalTime + 'ms';
            if (moduleSelector) {
              title += ' \'' + moduleSelector + '\'';
            }
            if ((console.group !== undefined || console.table !== undefined) && performance.length > 0) {
              console.groupCollapsed(title);
              if (console.table) {
                console.table(performance);
              } else {
                $.each(performance, function (index, data) {
                  console.log(data['Name'] + ': ' + data['Execution Time'] + 'ms');
                });
              }
              console.groupEnd();
            }
            performance = [];
          }
        },
        invoke: function invoke(query, passedArguments, context) {
          var object = instance,
              maxDepth,
              found,
              response;
          passedArguments = passedArguments || queryArguments;
          context = element || context;
          if (typeof query == 'string' && object !== undefined) {
            query = query.split(/[\. ]/);
            maxDepth = query.length - 1;
            $.each(query, function (depth, value) {
              var camelCaseValue = depth != maxDepth ? value + query[depth + 1].charAt(0).toUpperCase() + query[depth + 1].slice(1) : query;
              if ($.isPlainObject(object[camelCaseValue]) && depth != maxDepth) {
                object = object[camelCaseValue];
              } else if (object[camelCaseValue] !== undefined) {
                found = object[camelCaseValue];
                return false;
              } else if ($.isPlainObject(object[value]) && depth != maxDepth) {
                object = object[value];
              } else if (object[value] !== undefined) {
                found = object[value];
                return false;
              } else {
                module.error(error.method, query);
                return false;
              }
            });
          }
          if ($.isFunction(found)) {
            response = found.apply(context, passedArguments);
          } else if (found !== undefined) {
            response = found;
          }
          if ($.isArray(returnedValue)) {
            returnedValue.push(response);
          } else if (returnedValue !== undefined) {
            returnedValue = [returnedValue, response];
          } else if (response !== undefined) {
            returnedValue = response;
          }
          return found;
        }
      };

      if (methodInvoked) {
        if (instance === undefined) {
          module.initialize();
        }
        module.invoke(query);
      } else {
        if (instance !== undefined) {
          instance.invoke('destroy');
        }
        module.initialize();
      }
    });
    return returnedValue !== undefined ? returnedValue : $allModules;
  };

  $.fn.dropdown.settings = {

    silent: false,
    debug: false,
    verbose: false,
    performance: true,

    on: 'click', // what event should show menu action on item selection
    action: 'activate', // action on item selection (nothing, activate, select, combo, hide, function(){})

    values: false, // specify values to use for dropdown

    clearable: false, // whether the value of the dropdown can be cleared

    apiSettings: false,
    selectOnKeydown: true, // Whether selection should occur automatically when keyboard shortcuts used
    minCharacters: 0, // Minimum characters required to trigger API call

    filterRemoteData: false, // Whether API results should be filtered after being returned for query term
    saveRemoteData: true, // Whether remote name/value pairs should be stored in sessionStorage to allow remote data to be restored on page refresh

    throttle: 200, // How long to wait after last user input to search remotely

    context: window, // Context to use when determining if on screen
    direction: 'auto', // Whether dropdown should always open in one direction
    keepOnScreen: true, // Whether dropdown should check whether it is on screen before showing

    match: 'both', // what to match against with search selection (both, text, or label)
    fullTextSearch: false, // search anywhere in value (set to 'exact' to require exact matches)

    placeholder: 'auto', // whether to convert blank <select> values to placeholder text
    preserveHTML: true, // preserve html when selecting value
    sortSelect: false, // sort selection on init

    forceSelection: true, // force a choice on blur with search selection

    allowAdditions: false, // whether multiple select should allow user added values
    ignoreCase: false, // whether to consider values not matching in case to be the same
    hideAdditions: true, // whether or not to hide special message prompting a user they can enter a value

    maxSelections: false, // When set to a number limits the number of selections to this count
    useLabels: true, // whether multiple select should filter currently active selections from choices
    delimiter: ',', // when multiselect uses normal <input> the values will be delimited with this character

    showOnFocus: true, // show menu on focus
    allowReselection: false, // whether current value should trigger callbacks when reselected
    allowTab: true, // add tabindex to element
    allowCategorySelection: false, // allow elements with sub-menus to be selected

    fireOnInit: false, // Whether callbacks should fire when initializing dropdown values

    transition: 'auto', // auto transition will slide down or up based on direction
    duration: 200, // duration of transition

    glyphWidth: 1.037, // widest glyph width in em (W is 1.037 em) used to calculate multiselect input width

    // label settings on multi-select
    label: {
      transition: 'scale',
      duration: 200,
      variation: false
    },

    // delay before event
    delay: {
      hide: 300,
      show: 200,
      search: 20,
      touch: 50
    },

    /* Callbacks */
    onChange: function onChange(value, text, $selected) {},
    onAdd: function onAdd(value, text, $selected) {},
    onRemove: function onRemove(value, text, $selected) {},

    onLabelSelect: function onLabelSelect($selectedLabels) {},
    onLabelCreate: function onLabelCreate(value, text) {
      return $(this);
    },
    onLabelRemove: function onLabelRemove(value) {
      return true;
    },
    onNoResults: function onNoResults(searchTerm) {
      return true;
    },
    onShow: function onShow() {},
    onHide: function onHide() {},

    /* Component */
    name: 'Dropdown',
    namespace: 'dropdown',

    message: {
      addResult: 'Add <b>{term}</b>',
      count: '{count} selected',
      maxSelections: 'Max {maxCount} selections',
      noResults: 'No results found.',
      serverError: 'There was an error contacting the server'
    },

    error: {
      action: 'You called a dropdown action that was not defined',
      alreadySetup: 'Once a select has been initialized behaviors must be called on the created ui dropdown',
      labels: 'Allowing user additions currently requires the use of labels.',
      missingMultiple: '<select> requires multiple property to be set to correctly preserve multiple values',
      method: 'The method you called is not defined.',
      noAPI: 'The API module is required to load resources remotely',
      noStorage: 'Saving remote data requires session storage',
      noTransition: 'This module requires ui transitions <https://github.com/Semantic-Org/UI-Transition>'
    },

    regExp: {
      escape: /[-[\]{}()*+?.,\\^$|#\s]/g,
      quote: /"/g
    },

    metadata: {
      defaultText: 'defaultText',
      defaultValue: 'defaultValue',
      placeholderText: 'placeholder',
      text: 'text',
      value: 'value'
    },

    // property names for remote query
    fields: {
      remoteValues: 'results', // grouping for api results
      values: 'values', // grouping for all dropdown values
      disabled: 'disabled', // whether value should be disabled
      name: 'name', // displayed dropdown text
      value: 'value', // actual dropdown value
      text: 'text' // displayed text when selected
    },

    keys: {
      backspace: 8,
      delimiter: 188, // comma
      deleteKey: 46,
      enter: 13,
      escape: 27,
      pageUp: 33,
      pageDown: 34,
      leftArrow: 37,
      upArrow: 38,
      rightArrow: 39,
      downArrow: 40
    },

    selector: {
      addition: '.addition',
      dropdown: '.ui.dropdown',
      hidden: '.hidden',
      icon: '> .dropdown.icon',
      input: '> input[type="hidden"], > select',
      item: '.item',
      label: '> .label',
      remove: '> .label > .delete.icon',
      siblingLabel: '.label',
      menu: '.menu',
      message: '.message',
      menuIcon: '.dropdown.icon',
      search: 'input.search, .menu > .search > input, .menu input.search',
      sizer: '> input.sizer',
      text: '> .text:not(.icon)',
      unselectable: '.disabled, .filtered'
    },

    className: {
      active: 'active',
      addition: 'addition',
      animating: 'animating',
      clear: 'clear',
      disabled: 'disabled',
      empty: 'empty',
      dropdown: 'ui dropdown',
      filtered: 'filtered',
      hidden: 'hidden transition',
      item: 'item',
      label: 'ui label',
      loading: 'loading',
      menu: 'menu',
      message: 'message',
      multiple: 'multiple',
      placeholder: 'default',
      sizer: 'sizer',
      search: 'search',
      selected: 'selected',
      selection: 'selection',
      upward: 'upward',
      leftward: 'left',
      visible: 'visible'
    }

  };

  /* Templates */
  $.fn.dropdown.settings.templates = {

    // generates dropdown from select values
    dropdown: function dropdown(select) {
      var placeholder = select.placeholder || false,
          values = select.values || {},
          html = '';
      html += '<i class="dropdown icon"></i>';
      if (select.placeholder) {
        html += '<div class="default text">' + placeholder + '</div>';
      } else {
        html += '<div class="text"></div>';
      }
      html += '<div class="menu">';
      $.each(select.values, function (index, option) {
        html += option.disabled ? '<div class="disabled item" data-value="' + option.value + '">' + option.name + '</div>' : '<div class="item" data-value="' + option.value + '">' + option.name + '</div>';
      });
      html += '</div>';
      return html;
    },

    // generates just menu from select
    menu: function menu(response, fields) {
      var values = response[fields.values] || {},
          html = '';
      $.each(values, function (index, option) {
        var maybeText = option[fields.text] ? 'data-text="' + option[fields.text] + '"' : '',
            maybeDisabled = option[fields.disabled] ? 'disabled ' : '';
        html += '<div class="' + maybeDisabled + 'item" data-value="' + option[fields.value] + '"' + maybeText + '>';
        html += option[fields.name];
        html += '</div>';
      });
      return html;
    },

    // generates label for multiselect
    label: function label(value, text) {
      return text + '<i class="delete icon"></i>';
    },

    // generates messages like "No results"
    message: function message(_message2) {
      return _message2;
    },

    // generates user addition to selection menu
    addition: function addition(choice) {
      return choice;
    }

  };
})(jQuery, window, document);

/*!
 * # Semantic UI 2.4.2 - Search
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */

;(function ($, window, document, undefined) {

  'use strict';

  window = typeof window != 'undefined' && window.Math == Math ? window : typeof self != 'undefined' && self.Math == Math ? self : Function('return this')();

  $.fn.search = function (parameters) {
    var $allModules = $(this),
        moduleSelector = $allModules.selector || '',
        time = new Date().getTime(),
        performance = [],
        query = arguments[0],
        methodInvoked = typeof query == 'string',
        queryArguments = [].slice.call(arguments, 1),
        returnedValue;
    $(this).each(function () {
      var _settings = $.isPlainObject(parameters) ? $.extend(true, {}, $.fn.search.settings, parameters) : $.extend({}, $.fn.search.settings),
          className = _settings.className,
          metadata = _settings.metadata,
          regExp = _settings.regExp,
          fields = _settings.fields,
          selector = _settings.selector,
          error = _settings.error,
          namespace = _settings.namespace,
          eventNamespace = '.' + namespace,
          moduleNamespace = namespace + '-module',
          $module = $(this),
          $prompt = $module.find(selector.prompt),
          $searchButton = $module.find(selector.searchButton),
          $results = $module.find(selector.results),
          $result = $module.find(selector.result),
          $category = $module.find(selector.category),
          element = this,
          instance = $module.data(moduleNamespace),
          disabledBubbled = false,
          resultsDismissed = false,
          module;

      module = {

        initialize: function initialize() {
          module.verbose('Initializing module');
          module.get.settings();
          module.determine.searchFields();
          module.bind.events();
          module.set.type();
          module.create.results();
          module.instantiate();
        },
        instantiate: function instantiate() {
          module.verbose('Storing instance of module', module);
          instance = module;
          $module.data(moduleNamespace, module);
        },
        destroy: function destroy() {
          module.verbose('Destroying instance');
          $module.off(eventNamespace).removeData(moduleNamespace);
        },

        refresh: function refresh() {
          module.debug('Refreshing selector cache');
          $prompt = $module.find(selector.prompt);
          $searchButton = $module.find(selector.searchButton);
          $category = $module.find(selector.category);
          $results = $module.find(selector.results);
          $result = $module.find(selector.result);
        },

        refreshResults: function refreshResults() {
          $results = $module.find(selector.results);
          $result = $module.find(selector.result);
        },

        bind: {
          events: function events() {
            module.verbose('Binding events to search');
            if (_settings.automatic) {
              $module.on(module.get.inputEvent() + eventNamespace, selector.prompt, module.event.input);
              $prompt.attr('autocomplete', 'off');
            }
            $module
            // prompt
            .on('focus' + eventNamespace, selector.prompt, module.event.focus).on('blur' + eventNamespace, selector.prompt, module.event.blur).on('keydown' + eventNamespace, selector.prompt, module.handleKeyboard)
            // search button
            .on('click' + eventNamespace, selector.searchButton, module.query)
            // results
            .on('mousedown' + eventNamespace, selector.results, module.event.result.mousedown).on('mouseup' + eventNamespace, selector.results, module.event.result.mouseup).on('click' + eventNamespace, selector.result, module.event.result.click);
          }
        },

        determine: {
          searchFields: function searchFields() {
            // this makes sure $.extend does not add specified search fields to default fields
            // this is the only setting which should not extend defaults
            if (parameters && parameters.searchFields !== undefined) {
              _settings.searchFields = parameters.searchFields;
            }
          }
        },

        event: {
          input: function input() {
            if (_settings.searchDelay) {
              clearTimeout(module.timer);
              module.timer = setTimeout(function () {
                if (module.is.focused()) {
                  module.query();
                }
              }, _settings.searchDelay);
            } else {
              module.query();
            }
          },
          focus: function focus() {
            module.set.focus();
            if (_settings.searchOnFocus && module.has.minimumCharacters()) {
              module.query(function () {
                if (module.can.show()) {
                  module.showResults();
                }
              });
            }
          },
          blur: function blur(event) {
            var pageLostFocus = document.activeElement === this,
                callback = function callback() {
              module.cancel.query();
              module.remove.focus();
              module.timer = setTimeout(module.hideResults, _settings.hideDelay);
            };
            if (pageLostFocus) {
              return;
            }
            resultsDismissed = false;
            if (module.resultsClicked) {
              module.debug('Determining if user action caused search to close');
              $module.one('click.close' + eventNamespace, selector.results, function (event) {
                if (module.is.inMessage(event) || disabledBubbled) {
                  $prompt.focus();
                  return;
                }
                disabledBubbled = false;
                if (!module.is.animating() && !module.is.hidden()) {
                  callback();
                }
              });
            } else {
              module.debug('Input blurred without user action, closing results');
              callback();
            }
          },
          result: {
            mousedown: function mousedown() {
              module.resultsClicked = true;
            },
            mouseup: function mouseup() {
              module.resultsClicked = false;
            },
            click: function click(event) {
              module.debug('Search result selected');
              var $result = $(this),
                  $title = $result.find(selector.title).eq(0),
                  $link = $result.is('a[href]') ? $result : $result.find('a[href]').eq(0),
                  href = $link.attr('href') || false,
                  target = $link.attr('target') || false,
                  title = $title.html(),

              // title is used for result lookup
              value = $title.length > 0 ? $title.text() : false,
                  results = module.get.results(),
                  result = $result.data(metadata.result) || module.get.result(value, results),
                  returnedValue;
              if ($.isFunction(_settings.onSelect)) {
                if (_settings.onSelect.call(element, result, results) === false) {
                  module.debug('Custom onSelect callback cancelled default select action');
                  disabledBubbled = true;
                  return;
                }
              }
              module.hideResults();
              if (value) {
                module.set.value(value);
              }
              if (href) {
                module.verbose('Opening search link found in result', $link);
                if (target == '_blank' || event.ctrlKey) {
                  window.open(href);
                } else {
                  window.location.href = href;
                }
              }
            }
          }
        },
        handleKeyboard: function handleKeyboard(event) {
          var
          // force selector refresh
          $result = $module.find(selector.result),
              $category = $module.find(selector.category),
              $activeResult = $result.filter('.' + className.active),
              currentIndex = $result.index($activeResult),
              resultSize = $result.length,
              hasActiveResult = $activeResult.length > 0,
              keyCode = event.which,
              keys = {
            backspace: 8,
            enter: 13,
            escape: 27,
            upArrow: 38,
            downArrow: 40
          },
              newIndex;
          // search shortcuts
          if (keyCode == keys.escape) {
            module.verbose('Escape key pressed, blurring search field');
            module.hideResults();
            resultsDismissed = true;
          }
          if (module.is.visible()) {
            if (keyCode == keys.enter) {
              module.verbose('Enter key pressed, selecting active result');
              if ($result.filter('.' + className.active).length > 0) {
                module.event.result.click.call($result.filter('.' + className.active), event);
                event.preventDefault();
                return false;
              }
            } else if (keyCode == keys.upArrow && hasActiveResult) {
              module.verbose('Up key pressed, changing active result');
              newIndex = currentIndex - 1 < 0 ? currentIndex : currentIndex - 1;
              $category.removeClass(className.active);
              $result.removeClass(className.active).eq(newIndex).addClass(className.active).closest($category).addClass(className.active);
              event.preventDefault();
            } else if (keyCode == keys.downArrow) {
              module.verbose('Down key pressed, changing active result');
              newIndex = currentIndex + 1 >= resultSize ? currentIndex : currentIndex + 1;
              $category.removeClass(className.active);
              $result.removeClass(className.active).eq(newIndex).addClass(className.active).closest($category).addClass(className.active);
              event.preventDefault();
            }
          } else {
            // query shortcuts
            if (keyCode == keys.enter) {
              module.verbose('Enter key pressed, executing query');
              module.query();
              module.set.buttonPressed();
              $prompt.one('keyup', module.remove.buttonFocus);
            }
          }
        },

        setup: {
          api: function api(searchTerm, callback) {
            var apiSettings = {
              debug: _settings.debug,
              on: false,
              cache: _settings.cache,
              action: 'search',
              urlData: {
                query: searchTerm
              },
              onSuccess: function onSuccess(response) {
                module.parse.response.call(element, response, searchTerm);
                callback();
              },
              onFailure: function onFailure() {
                module.displayMessage(error.serverError);
                callback();
              },
              onAbort: function onAbort(response) {},
              onError: module.error
            },
                searchHTML;
            $.extend(true, apiSettings, _settings.apiSettings);
            module.verbose('Setting up API request', apiSettings);
            $module.api(apiSettings);
          }
        },

        can: {
          useAPI: function useAPI() {
            return $.fn.api !== undefined;
          },
          show: function show() {
            return module.is.focused() && !module.is.visible() && !module.is.empty();
          },
          transition: function transition() {
            return _settings.transition && $.fn.transition !== undefined && $module.transition('is supported');
          }
        },

        is: {
          animating: function animating() {
            return $results.hasClass(className.animating);
          },
          hidden: function hidden() {
            return $results.hasClass(className.hidden);
          },
          inMessage: function inMessage(event) {
            if (!event.target) {
              return;
            }
            var $target = $(event.target),
                isInDOM = $.contains(document.documentElement, event.target);
            return isInDOM && $target.closest(selector.message).length > 0;
          },
          empty: function empty() {
            return $results.html() === '';
          },
          visible: function visible() {
            return $results.filter(':visible').length > 0;
          },
          focused: function focused() {
            return $prompt.filter(':focus').length > 0;
          }
        },

        get: {
          settings: function settings() {
            if ($.isPlainObject(parameters) && parameters.searchFullText) {
              _settings.fullTextSearch = parameters.searchFullText;
              module.error(_settings.error.oldSearchSyntax, element);
            }
          },
          inputEvent: function inputEvent() {
            var prompt = $prompt[0],
                inputEvent = prompt !== undefined && prompt.oninput !== undefined ? 'input' : prompt !== undefined && prompt.onpropertychange !== undefined ? 'propertychange' : 'keyup';
            return inputEvent;
          },
          value: function value() {
            return $prompt.val();
          },
          results: function results() {
            var results = $module.data(metadata.results);
            return results;
          },
          result: function result(value, results) {
            var lookupFields = ['title', 'id'],
                result = false;
            value = value !== undefined ? value : module.get.value();
            results = results !== undefined ? results : module.get.results();
            if (_settings.type === 'category') {
              module.debug('Finding result that matches', value);
              $.each(results, function (index, category) {
                if ($.isArray(category.results)) {
                  result = module.search.object(value, category.results, lookupFields)[0];
                  // don't continue searching if a result is found
                  if (result) {
                    return false;
                  }
                }
              });
            } else {
              module.debug('Finding result in results object', value);
              result = module.search.object(value, results, lookupFields)[0];
            }
            return result || false;
          }
        },

        select: {
          firstResult: function firstResult() {
            module.verbose('Selecting first result');
            $result.first().addClass(className.active);
          }
        },

        set: {
          focus: function focus() {
            $module.addClass(className.focus);
          },
          loading: function loading() {
            $module.addClass(className.loading);
          },
          value: function value(_value4) {
            module.verbose('Setting search input value', _value4);
            $prompt.val(_value4);
          },
          type: function type(_type) {
            _type = _type || _settings.type;
            if (_settings.type == 'category') {
              $module.addClass(_settings.type);
            }
          },
          buttonPressed: function buttonPressed() {
            $searchButton.addClass(className.pressed);
          }
        },

        remove: {
          loading: function loading() {
            $module.removeClass(className.loading);
          },
          focus: function focus() {
            $module.removeClass(className.focus);
          },
          buttonPressed: function buttonPressed() {
            $searchButton.removeClass(className.pressed);
          }
        },

        query: function query(callback) {
          callback = $.isFunction(callback) ? callback : function () {};
          var searchTerm = module.get.value(),
              cache = module.read.cache(searchTerm);
          callback = callback || function () {};
          if (module.has.minimumCharacters()) {
            if (cache) {
              module.debug('Reading result from cache', searchTerm);
              module.save.results(cache.results);
              module.addResults(cache.html);
              module.inject.id(cache.results);
              callback();
            } else {
              module.debug('Querying for', searchTerm);
              if ($.isPlainObject(_settings.source) || $.isArray(_settings.source)) {
                module.search.local(searchTerm);
                callback();
              } else if (module.can.useAPI()) {
                module.search.remote(searchTerm, callback);
              } else {
                module.error(error.source);
                callback();
              }
            }
            _settings.onSearchQuery.call(element, searchTerm);
          } else {
            module.hideResults();
          }
        },

        search: {
          local: function local(searchTerm) {
            var results = module.search.object(searchTerm, _settings.content),
                searchHTML;
            module.set.loading();
            module.save.results(results);
            module.debug('Returned full local search results', results);
            if (_settings.maxResults > 0) {
              module.debug('Using specified max results', results);
              results = results.slice(0, _settings.maxResults);
            }
            if (_settings.type == 'category') {
              results = module.create.categoryResults(results);
            }
            searchHTML = module.generateResults({
              results: results
            });
            module.remove.loading();
            module.addResults(searchHTML);
            module.inject.id(results);
            module.write.cache(searchTerm, {
              html: searchHTML,
              results: results
            });
          },
          remote: function remote(searchTerm, callback) {
            callback = $.isFunction(callback) ? callback : function () {};
            if ($module.api('is loading')) {
              $module.api('abort');
            }
            module.setup.api(searchTerm, callback);
            $module.api('query');
          },
          object: function object(searchTerm, source, searchFields) {
            var results = [],
                exactResults = [],
                fuzzyResults = [],
                searchExp = searchTerm.toString().replace(regExp.escape, '\\$&'),
                matchRegExp = new RegExp(regExp.beginsWith + searchExp, 'i'),


            // avoid duplicates when pushing results
            addResult = function addResult(array, result) {
              var notResult = $.inArray(result, results) == -1,
                  notFuzzyResult = $.inArray(result, fuzzyResults) == -1,
                  notExactResults = $.inArray(result, exactResults) == -1;
              if (notResult && notFuzzyResult && notExactResults) {
                array.push(result);
              }
            };
            source = source || _settings.source;
            searchFields = searchFields !== undefined ? searchFields : _settings.searchFields;

            // search fields should be array to loop correctly
            if (!$.isArray(searchFields)) {
              searchFields = [searchFields];
            }

            // exit conditions if no source
            if (source === undefined || source === false) {
              module.error(error.source);
              return [];
            }
            // iterate through search fields looking for matches
            $.each(searchFields, function (index, field) {
              $.each(source, function (label, content) {
                var fieldExists = typeof content[field] == 'string';
                if (fieldExists) {
                  if (content[field].search(matchRegExp) !== -1) {
                    // content starts with value (first in results)
                    addResult(results, content);
                  } else if (_settings.fullTextSearch === 'exact' && module.exactSearch(searchTerm, content[field])) {
                    // content fuzzy matches (last in results)
                    addResult(exactResults, content);
                  } else if (_settings.fullTextSearch == true && module.fuzzySearch(searchTerm, content[field])) {
                    // content fuzzy matches (last in results)
                    addResult(fuzzyResults, content);
                  }
                }
              });
            });
            $.merge(exactResults, fuzzyResults);
            $.merge(results, exactResults);
            return results;
          }
        },
        exactSearch: function exactSearch(query, term) {
          query = query.toLowerCase();
          term = term.toLowerCase();
          if (term.indexOf(query) > -1) {
            return true;
          }
          return false;
        },
        fuzzySearch: function fuzzySearch(query, term) {
          var termLength = term.length,
              queryLength = query.length;
          if (typeof query !== 'string') {
            return false;
          }
          query = query.toLowerCase();
          term = term.toLowerCase();
          if (queryLength > termLength) {
            return false;
          }
          if (queryLength === termLength) {
            return query === term;
          }
          search: for (var characterIndex = 0, nextCharacterIndex = 0; characterIndex < queryLength; characterIndex++) {
            var queryCharacter = query.charCodeAt(characterIndex);
            while (nextCharacterIndex < termLength) {
              if (term.charCodeAt(nextCharacterIndex++) === queryCharacter) {
                continue search;
              }
            }
            return false;
          }
          return true;
        },

        parse: {
          response: function response(_response, searchTerm) {
            var searchHTML = module.generateResults(_response);
            module.verbose('Parsing server response', _response);
            if (_response !== undefined) {
              if (searchTerm !== undefined && _response[fields.results] !== undefined) {
                module.addResults(searchHTML);
                module.inject.id(_response[fields.results]);
                module.write.cache(searchTerm, {
                  html: searchHTML,
                  results: _response[fields.results]
                });
                module.save.results(_response[fields.results]);
              }
            }
          }
        },

        cancel: {
          query: function query() {
            if (module.can.useAPI()) {
              $module.api('abort');
            }
          }
        },

        has: {
          minimumCharacters: function minimumCharacters() {
            var searchTerm = module.get.value(),
                numCharacters = searchTerm.length;
            return numCharacters >= _settings.minCharacters;
          },
          results: function results() {
            if ($results.length === 0) {
              return false;
            }
            var html = $results.html();
            return html != '';
          }
        },

        clear: {
          cache: function cache(value) {
            var cache = $module.data(metadata.cache);
            if (!value) {
              module.debug('Clearing cache', value);
              $module.removeData(metadata.cache);
            } else if (value && cache && cache[value]) {
              module.debug('Removing value from cache', value);
              delete cache[value];
              $module.data(metadata.cache, cache);
            }
          }
        },

        read: {
          cache: function cache(name) {
            var cache = $module.data(metadata.cache);
            if (_settings.cache) {
              module.verbose('Checking cache for generated html for query', name);
              return (typeof cache === "undefined" ? "undefined" : _typeof(cache)) == 'object' && cache[name] !== undefined ? cache[name] : false;
            }
            return false;
          }
        },

        create: {
          categoryResults: function categoryResults(results) {
            var categoryResults = {};
            $.each(results, function (index, result) {
              if (!result.category) {
                return;
              }
              if (categoryResults[result.category] === undefined) {
                module.verbose('Creating new category of results', result.category);
                categoryResults[result.category] = {
                  name: result.category,
                  results: [result]
                };
              } else {
                categoryResults[result.category].results.push(result);
              }
            });
            return categoryResults;
          },
          id: function id(resultIndex, categoryIndex) {
            var resultID = resultIndex + 1,
                // not zero indexed
            categoryID = categoryIndex + 1,
                firstCharCode,
                letterID,
                id;
            if (categoryIndex !== undefined) {
              // start char code for "A"
              letterID = String.fromCharCode(97 + categoryIndex);
              id = letterID + resultID;
              module.verbose('Creating category result id', id);
            } else {
              id = resultID;
              module.verbose('Creating result id', id);
            }
            return id;
          },
          results: function results() {
            if ($results.length === 0) {
              $results = $('<div />').addClass(className.results).appendTo($module);
            }
          }
        },

        inject: {
          result: function result(_result, resultIndex, categoryIndex) {
            module.verbose('Injecting result into results');
            var $selectedResult = categoryIndex !== undefined ? $results.children().eq(categoryIndex).children(selector.results).first().children(selector.result).eq(resultIndex) : $results.children(selector.result).eq(resultIndex);
            module.verbose('Injecting results metadata', $selectedResult);
            $selectedResult.data(metadata.result, _result);
          },
          id: function id(results) {
            module.debug('Injecting unique ids into results');
            var
            // since results may be object, we must use counters
            categoryIndex = 0,
                resultIndex = 0;
            if (_settings.type === 'category') {
              // iterate through each category result
              $.each(results, function (index, category) {
                resultIndex = 0;
                $.each(category.results, function (index, value) {
                  var result = category.results[index];
                  if (result.id === undefined) {
                    result.id = module.create.id(resultIndex, categoryIndex);
                  }
                  module.inject.result(result, resultIndex, categoryIndex);
                  resultIndex++;
                });
                categoryIndex++;
              });
            } else {
              // top level
              $.each(results, function (index, value) {
                var result = results[index];
                if (result.id === undefined) {
                  result.id = module.create.id(resultIndex);
                }
                module.inject.result(result, resultIndex);
                resultIndex++;
              });
            }
            return results;
          }
        },

        save: {
          results: function results(_results) {
            module.verbose('Saving current search results to metadata', _results);
            $module.data(metadata.results, _results);
          }
        },

        write: {
          cache: function cache(name, value) {
            var cache = $module.data(metadata.cache) !== undefined ? $module.data(metadata.cache) : {};
            if (_settings.cache) {
              module.verbose('Writing generated html to cache', name, value);
              cache[name] = value;
              $module.data(metadata.cache, cache);
            }
          }
        },

        addResults: function addResults(html) {
          if ($.isFunction(_settings.onResultsAdd)) {
            if (_settings.onResultsAdd.call($results, html) === false) {
              module.debug('onResultsAdd callback cancelled default action');
              return false;
            }
          }
          if (html) {
            $results.html(html);
            module.refreshResults();
            if (_settings.selectFirstResult) {
              module.select.firstResult();
            }
            module.showResults();
          } else {
            module.hideResults(function () {
              $results.empty();
            });
          }
        },

        showResults: function showResults(callback) {
          callback = $.isFunction(callback) ? callback : function () {};
          if (resultsDismissed) {
            return;
          }
          if (!module.is.visible() && module.has.results()) {
            if (module.can.transition()) {
              module.debug('Showing results with css animations');
              $results.transition({
                animation: _settings.transition + ' in',
                debug: _settings.debug,
                verbose: _settings.verbose,
                duration: _settings.duration,
                onComplete: function onComplete() {
                  callback();
                },
                queue: true
              });
            } else {
              module.debug('Showing results with javascript');
              $results.stop().fadeIn(_settings.duration, _settings.easing);
            }
            _settings.onResultsOpen.call($results);
          }
        },
        hideResults: function hideResults(callback) {
          callback = $.isFunction(callback) ? callback : function () {};
          if (module.is.visible()) {
            if (module.can.transition()) {
              module.debug('Hiding results with css animations');
              $results.transition({
                animation: _settings.transition + ' out',
                debug: _settings.debug,
                verbose: _settings.verbose,
                duration: _settings.duration,
                onComplete: function onComplete() {
                  callback();
                },
                queue: true
              });
            } else {
              module.debug('Hiding results with javascript');
              $results.stop().fadeOut(_settings.duration, _settings.easing);
            }
            _settings.onResultsClose.call($results);
          }
        },

        generateResults: function generateResults(response) {
          module.debug('Generating html from response', response);
          var template = _settings.templates[_settings.type],
              isProperObject = $.isPlainObject(response[fields.results]) && !$.isEmptyObject(response[fields.results]),
              isProperArray = $.isArray(response[fields.results]) && response[fields.results].length > 0,
              html = '';
          if (isProperObject || isProperArray) {
            if (_settings.maxResults > 0) {
              if (isProperObject) {
                if (_settings.type == 'standard') {
                  module.error(error.maxResults);
                }
              } else {
                response[fields.results] = response[fields.results].slice(0, _settings.maxResults);
              }
            }
            if ($.isFunction(template)) {
              html = template(response, fields);
            } else {
              module.error(error.noTemplate, false);
            }
          } else if (_settings.showNoResults) {
            html = module.displayMessage(error.noResults, 'empty');
          }
          _settings.onResults.call(element, response);
          return html;
        },

        displayMessage: function displayMessage(text, type) {
          type = type || 'standard';
          module.debug('Displaying message', text, type);
          module.addResults(_settings.templates.message(text, type));
          return _settings.templates.message(text, type);
        },

        setting: function setting(name, value) {
          if ($.isPlainObject(name)) {
            $.extend(true, _settings, name);
          } else if (value !== undefined) {
            _settings[name] = value;
          } else {
            return _settings[name];
          }
        },
        internal: function internal(name, value) {
          if ($.isPlainObject(name)) {
            $.extend(true, module, name);
          } else if (value !== undefined) {
            module[name] = value;
          } else {
            return module[name];
          }
        },
        debug: function debug() {
          if (!_settings.silent && _settings.debug) {
            if (_settings.performance) {
              module.performance.log(arguments);
            } else {
              module.debug = Function.prototype.bind.call(console.info, console, _settings.name + ':');
              module.debug.apply(console, arguments);
            }
          }
        },
        verbose: function verbose() {
          if (!_settings.silent && _settings.verbose && _settings.debug) {
            if (_settings.performance) {
              module.performance.log(arguments);
            } else {
              module.verbose = Function.prototype.bind.call(console.info, console, _settings.name + ':');
              module.verbose.apply(console, arguments);
            }
          }
        },
        error: function error() {
          if (!_settings.silent) {
            module.error = Function.prototype.bind.call(console.error, console, _settings.name + ':');
            module.error.apply(console, arguments);
          }
        },
        performance: {
          log: function log(message) {
            var currentTime, executionTime, previousTime;
            if (_settings.performance) {
              currentTime = new Date().getTime();
              previousTime = time || currentTime;
              executionTime = currentTime - previousTime;
              time = currentTime;
              performance.push({
                'Name': message[0],
                'Arguments': [].slice.call(message, 1) || '',
                'Element': element,
                'Execution Time': executionTime
              });
            }
            clearTimeout(module.performance.timer);
            module.performance.timer = setTimeout(module.performance.display, 500);
          },
          display: function display() {
            var title = _settings.name + ':',
                totalTime = 0;
            time = false;
            clearTimeout(module.performance.timer);
            $.each(performance, function (index, data) {
              totalTime += data['Execution Time'];
            });
            title += ' ' + totalTime + 'ms';
            if (moduleSelector) {
              title += ' \'' + moduleSelector + '\'';
            }
            if ($allModules.length > 1) {
              title += ' ' + '(' + $allModules.length + ')';
            }
            if ((console.group !== undefined || console.table !== undefined) && performance.length > 0) {
              console.groupCollapsed(title);
              if (console.table) {
                console.table(performance);
              } else {
                $.each(performance, function (index, data) {
                  console.log(data['Name'] + ': ' + data['Execution Time'] + 'ms');
                });
              }
              console.groupEnd();
            }
            performance = [];
          }
        },
        invoke: function invoke(query, passedArguments, context) {
          var object = instance,
              maxDepth,
              found,
              response;
          passedArguments = passedArguments || queryArguments;
          context = element || context;
          if (typeof query == 'string' && object !== undefined) {
            query = query.split(/[\. ]/);
            maxDepth = query.length - 1;
            $.each(query, function (depth, value) {
              var camelCaseValue = depth != maxDepth ? value + query[depth + 1].charAt(0).toUpperCase() + query[depth + 1].slice(1) : query;
              if ($.isPlainObject(object[camelCaseValue]) && depth != maxDepth) {
                object = object[camelCaseValue];
              } else if (object[camelCaseValue] !== undefined) {
                found = object[camelCaseValue];
                return false;
              } else if ($.isPlainObject(object[value]) && depth != maxDepth) {
                object = object[value];
              } else if (object[value] !== undefined) {
                found = object[value];
                return false;
              } else {
                return false;
              }
            });
          }
          if ($.isFunction(found)) {
            response = found.apply(context, passedArguments);
          } else if (found !== undefined) {
            response = found;
          }
          if ($.isArray(returnedValue)) {
            returnedValue.push(response);
          } else if (returnedValue !== undefined) {
            returnedValue = [returnedValue, response];
          } else if (response !== undefined) {
            returnedValue = response;
          }
          return found;
        }
      };
      if (methodInvoked) {
        if (instance === undefined) {
          module.initialize();
        }
        module.invoke(query);
      } else {
        if (instance !== undefined) {
          instance.invoke('destroy');
        }
        module.initialize();
      }
    });

    return returnedValue !== undefined ? returnedValue : this;
  };

  $.fn.search.settings = {

    name: 'Search',
    namespace: 'search',

    silent: false,
    debug: false,
    verbose: false,
    performance: true,

    // template to use (specified in settings.templates)
    type: 'standard',

    // minimum characters required to search
    minCharacters: 1,

    // whether to select first result after searching automatically
    selectFirstResult: false,

    // API config
    apiSettings: false,

    // object to search
    source: false,

    // Whether search should query current term on focus
    searchOnFocus: true,

    // fields to search
    searchFields: ['title', 'description'],

    // field to display in standard results template
    displayField: '',

    // search anywhere in value (set to 'exact' to require exact matches
    fullTextSearch: 'exact',

    // whether to add events to prompt automatically
    automatic: true,

    // delay before hiding menu after blur
    hideDelay: 0,

    // delay before searching
    searchDelay: 200,

    // maximum results returned from search
    maxResults: 7,

    // whether to store lookups in local cache
    cache: true,

    // whether no results errors should be shown
    showNoResults: true,

    // transition settings
    transition: 'scale',
    duration: 200,
    easing: 'easeOutExpo',

    // callbacks
    onSelect: false,
    onResultsAdd: false,

    onSearchQuery: function onSearchQuery(query) {},
    onResults: function onResults(response) {},

    onResultsOpen: function onResultsOpen() {},
    onResultsClose: function onResultsClose() {},

    className: {
      animating: 'animating',
      active: 'active',
      empty: 'empty',
      focus: 'focus',
      hidden: 'hidden',
      loading: 'loading',
      results: 'results',
      pressed: 'down'
    },

    error: {
      source: 'Cannot search. No source used, and Semantic API module was not included',
      noResults: 'Your search returned no results',
      logging: 'Error in debug logging, exiting.',
      noEndpoint: 'No search endpoint was specified',
      noTemplate: 'A valid template name was not specified.',
      oldSearchSyntax: 'searchFullText setting has been renamed fullTextSearch for consistency, please adjust your settings.',
      serverError: 'There was an issue querying the server.',
      maxResults: 'Results must be an array to use maxResults setting',
      method: 'The method you called is not defined.'
    },

    metadata: {
      cache: 'cache',
      results: 'results',
      result: 'result'
    },

    regExp: {
      escape: /[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,
      beginsWith: '(?:\s|^)'
    },

    // maps api response attributes to internal representation
    fields: {
      categories: 'results', // array of categories (category view)
      categoryName: 'name', // name of category (category view)
      categoryResults: 'results', // array of results (category view)
      description: 'description', // result description
      image: 'image', // result image
      price: 'price', // result price
      results: 'results', // array of results (standard)
      title: 'title', // result title
      url: 'url', // result url
      action: 'action', // "view more" object name
      actionText: 'text', // "view more" text
      actionURL: 'url' // "view more" url
    },

    selector: {
      prompt: '.prompt',
      searchButton: '.search.button',
      results: '.results',
      message: '.results > .message',
      category: '.category',
      result: '.result',
      title: '.title, .name'
    },

    templates: {
      escape: function escape(string) {
        var badChars = /[&<>"'`]/g,
            shouldEscape = /[&<>"'`]/,
            escape = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#x27;",
          "`": "&#x60;"
        },
            escapedChar = function escapedChar(chr) {
          return escape[chr];
        };
        if (shouldEscape.test(string)) {
          return string.replace(badChars, escapedChar);
        }
        return string;
      },
      message: function message(_message3, type) {
        var html = '';
        if (_message3 !== undefined && type !== undefined) {
          html += '' + '<div class="message ' + type + '">';
          // message type
          if (type == 'empty') {
            html += '' + '<div class="header">No Results</div class="header">' + '<div class="description">' + _message3 + '</div class="description">';
          } else {
            html += ' <div class="description">' + _message3 + '</div>';
          }
          html += '</div>';
        }
        return html;
      },
      category: function category(response, fields) {
        var html = '',
            escape = $.fn.search.settings.templates.escape;
        if (response[fields.categoryResults] !== undefined) {

          // each category
          $.each(response[fields.categoryResults], function (index, category) {
            if (category[fields.results] !== undefined && category.results.length > 0) {

              html += '<div class="category">';

              if (category[fields.categoryName] !== undefined) {
                html += '<div class="name">' + category[fields.categoryName] + '</div>';
              }

              // each item inside category
              html += '<div class="results">';
              $.each(category.results, function (index, result) {
                if (result[fields.url]) {
                  html += '<a class="result" href="' + result[fields.url] + '">';
                } else {
                  html += '<a class="result">';
                }
                if (result[fields.image] !== undefined) {
                  html += '' + '<div class="image">' + ' <img src="' + result[fields.image] + '">' + '</div>';
                }
                html += '<div class="content">';
                if (result[fields.price] !== undefined) {
                  html += '<div class="price">' + result[fields.price] + '</div>';
                }
                if (result[fields.title] !== undefined) {
                  html += '<div class="title">' + result[fields.title] + '</div>';
                }
                if (result[fields.description] !== undefined) {
                  html += '<div class="description">' + result[fields.description] + '</div>';
                }
                html += '' + '</div>';
                html += '</a>';
              });
              html += '</div>';
              html += '' + '</div>';
            }
          });
          if (response[fields.action]) {
            html += '' + '<a href="' + response[fields.action][fields.actionURL] + '" class="action">' + response[fields.action][fields.actionText] + '</a>';
          }
          return html;
        }
        return false;
      },
      standard: function standard(response, fields) {
        var html = '';
        if (response[fields.results] !== undefined) {

          // each result
          $.each(response[fields.results], function (index, result) {
            if (result[fields.url]) {
              html += '<a class="result" href="' + result[fields.url] + '">';
            } else {
              html += '<a class="result">';
            }
            if (result[fields.image] !== undefined) {
              html += '' + '<div class="image">' + ' <img src="' + result[fields.image] + '">' + '</div>';
            }
            html += '<div class="content">';
            if (result[fields.price] !== undefined) {
              html += '<div class="price">' + result[fields.price] + '</div>';
            }
            if (result[fields.title] !== undefined) {
              html += '<div class="title">' + result[fields.title] + '</div>';
            }
            if (result[fields.description] !== undefined) {
              html += '<div class="description">' + result[fields.description] + '</div>';
            }
            html += '' + '</div>';
            html += '</a>';
          });

          if (response[fields.action]) {
            html += '' + '<a href="' + response[fields.action][fields.actionURL] + '" class="action">' + response[fields.action][fields.actionText] + '</a>';
          }
          return html;
        }
        return false;
      }
    }
  };
})(jQuery, window, document);

/*!
 * # Semantic UI 2.4.2 - Transition
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */

;(function ($, window, document, undefined) {

  'use strict';

  window = typeof window != 'undefined' && window.Math == Math ? window : typeof self != 'undefined' && self.Math == Math ? self : Function('return this')();

  $.fn.transition = function () {
    var $allModules = $(this),
        moduleSelector = $allModules.selector || '',
        time = new Date().getTime(),
        performance = [],
        moduleArguments = arguments,
        query = moduleArguments[0],
        queryArguments = [].slice.call(arguments, 1),
        methodInvoked = typeof query === 'string',
        requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || function (callback) {
      setTimeout(callback, 0);
    },
        returnedValue;
    $allModules.each(function (index) {
      var $module = $(this),
          element = this,


      // set at run time
      settings,
          instance,
          error,
          className,
          metadata,
          animationEnd,
          animationName,
          namespace,
          moduleNamespace,
          eventNamespace,
          module;

      module = {

        initialize: function initialize() {

          // get full settings
          settings = module.get.settings.apply(element, moduleArguments);

          // shorthand
          className = settings.className;
          error = settings.error;
          metadata = settings.metadata;

          // define namespace
          eventNamespace = '.' + settings.namespace;
          moduleNamespace = 'module-' + settings.namespace;
          instance = $module.data(moduleNamespace) || module;

          // get vendor specific events
          animationEnd = module.get.animationEndEvent();

          if (methodInvoked) {
            methodInvoked = module.invoke(query);
          }

          // method not invoked, lets run an animation
          if (methodInvoked === false) {
            module.verbose('Converted arguments into settings object', settings);
            if (settings.interval) {
              module.delay(settings.animate);
            } else {
              module.animate();
            }
            module.instantiate();
          }
        },

        instantiate: function instantiate() {
          module.verbose('Storing instance of module', module);
          instance = module;
          $module.data(moduleNamespace, instance);
        },

        destroy: function destroy() {
          module.verbose('Destroying previous module for', element);
          $module.removeData(moduleNamespace);
        },

        refresh: function refresh() {
          module.verbose('Refreshing display type on next animation');
          delete module.displayType;
        },

        forceRepaint: function forceRepaint() {
          module.verbose('Forcing element repaint');
          var $parentElement = $module.parent(),
              $nextElement = $module.next();
          if ($nextElement.length === 0) {
            $module.detach().appendTo($parentElement);
          } else {
            $module.detach().insertBefore($nextElement);
          }
        },

        repaint: function repaint() {
          module.verbose('Repainting element');
          var fakeAssignment = element.offsetWidth;
        },

        delay: function delay(interval) {
          var direction = module.get.animationDirection(),
              shouldReverse,
              delay;
          if (!direction) {
            direction = module.can.transition() ? module.get.direction() : 'static';
          }
          interval = interval !== undefined ? interval : settings.interval;
          shouldReverse = settings.reverse == 'auto' && direction == className.outward;
          delay = shouldReverse || settings.reverse == true ? ($allModules.length - index) * settings.interval : index * settings.interval;
          module.debug('Delaying animation by', delay);
          setTimeout(module.animate, delay);
        },

        animate: function animate(overrideSettings) {
          settings = overrideSettings || settings;
          if (!module.is.supported()) {
            module.error(error.support);
            return false;
          }
          module.debug('Preparing animation', settings.animation);
          if (module.is.animating()) {
            if (settings.queue) {
              if (!settings.allowRepeats && module.has.direction() && module.is.occurring() && module.queuing !== true) {
                module.debug('Animation is currently occurring, preventing queueing same animation', settings.animation);
              } else {
                module.queue(settings.animation);
              }
              return false;
            } else if (!settings.allowRepeats && module.is.occurring()) {
              module.debug('Animation is already occurring, will not execute repeated animation', settings.animation);
              return false;
            } else {
              module.debug('New animation started, completing previous early', settings.animation);
              instance.complete();
            }
          }
          if (module.can.animate()) {
            module.set.animating(settings.animation);
          } else {
            module.error(error.noAnimation, settings.animation, element);
          }
        },

        reset: function reset() {
          module.debug('Resetting animation to beginning conditions');
          module.remove.animationCallbacks();
          module.restore.conditions();
          module.remove.animating();
        },

        queue: function queue(animation) {
          module.debug('Queueing animation of', animation);
          module.queuing = true;
          $module.one(animationEnd + '.queue' + eventNamespace, function () {
            module.queuing = false;
            module.repaint();
            module.animate.apply(this, settings);
          });
        },

        complete: function complete(event) {
          module.debug('Animation complete', settings.animation);
          module.remove.completeCallback();
          module.remove.failSafe();
          if (!module.is.looping()) {
            if (module.is.outward()) {
              module.verbose('Animation is outward, hiding element');
              module.restore.conditions();
              module.hide();
            } else if (module.is.inward()) {
              module.verbose('Animation is outward, showing element');
              module.restore.conditions();
              module.show();
            } else {
              module.verbose('Static animation completed');
              module.restore.conditions();
              settings.onComplete.call(element);
            }
          }
        },

        force: {
          visible: function visible() {
            var style = $module.attr('style'),
                userStyle = module.get.userStyle(),
                displayType = module.get.displayType(),
                overrideStyle = userStyle + 'display: ' + displayType + ' !important;',
                currentDisplay = $module.css('display'),
                emptyStyle = style === undefined || style === '';
            if (currentDisplay !== displayType) {
              module.verbose('Overriding default display to show element', displayType);
              $module.attr('style', overrideStyle);
            } else if (emptyStyle) {
              $module.removeAttr('style');
            }
          },
          hidden: function hidden() {
            var style = $module.attr('style'),
                currentDisplay = $module.css('display'),
                emptyStyle = style === undefined || style === '';
            if (currentDisplay !== 'none' && !module.is.hidden()) {
              module.verbose('Overriding default display to hide element');
              $module.css('display', 'none');
            } else if (emptyStyle) {
              $module.removeAttr('style');
            }
          }
        },

        has: {
          direction: function direction(animation) {
            var hasDirection = false;
            animation = animation || settings.animation;
            if (typeof animation === 'string') {
              animation = animation.split(' ');
              $.each(animation, function (index, word) {
                if (word === className.inward || word === className.outward) {
                  hasDirection = true;
                }
              });
            }
            return hasDirection;
          },
          inlineDisplay: function inlineDisplay() {
            var style = $module.attr('style') || '';
            return $.isArray(style.match(/display.*?;/, ''));
          }
        },

        set: {
          animating: function animating(animation) {
            var animationClass, direction;
            // remove previous callbacks
            module.remove.completeCallback();

            // determine exact animation
            animation = animation || settings.animation;
            animationClass = module.get.animationClass(animation);

            // save animation class in cache to restore class names
            module.save.animation(animationClass);

            // override display if necessary so animation appears visibly
            module.force.visible();

            module.remove.hidden();
            module.remove.direction();

            module.start.animation(animationClass);
          },
          duration: function duration(animationName, _duration) {
            _duration = _duration || settings.duration;
            _duration = typeof _duration == 'number' ? _duration + 'ms' : _duration;
            if (_duration || _duration === 0) {
              module.verbose('Setting animation duration', _duration);
              $module.css({
                'animation-duration': _duration
              });
            }
          },
          direction: function direction(_direction) {
            _direction = _direction || module.get.direction();
            if (_direction == className.inward) {
              module.set.inward();
            } else {
              module.set.outward();
            }
          },
          looping: function looping() {
            module.debug('Transition set to loop');
            $module.addClass(className.looping);
          },
          hidden: function hidden() {
            $module.addClass(className.transition).addClass(className.hidden);
          },
          inward: function inward() {
            module.debug('Setting direction to inward');
            $module.removeClass(className.outward).addClass(className.inward);
          },
          outward: function outward() {
            module.debug('Setting direction to outward');
            $module.removeClass(className.inward).addClass(className.outward);
          },
          visible: function visible() {
            $module.addClass(className.transition).addClass(className.visible);
          }
        },

        start: {
          animation: function animation(animationClass) {
            animationClass = animationClass || module.get.animationClass();
            module.debug('Starting tween', animationClass);
            $module.addClass(animationClass).one(animationEnd + '.complete' + eventNamespace, module.complete);
            if (settings.useFailSafe) {
              module.add.failSafe();
            }
            module.set.duration(settings.duration);
            settings.onStart.call(element);
          }
        },

        save: {
          animation: function animation(_animation) {
            if (!module.cache) {
              module.cache = {};
            }
            module.cache.animation = _animation;
          },
          displayType: function displayType(_displayType) {
            if (_displayType !== 'none') {
              $module.data(metadata.displayType, _displayType);
            }
          },
          transitionExists: function transitionExists(animation, exists) {
            $.fn.transition.exists[animation] = exists;
            module.verbose('Saving existence of transition', animation, exists);
          }
        },

        restore: {
          conditions: function conditions() {
            var animation = module.get.currentAnimation();
            if (animation) {
              $module.removeClass(animation);
              module.verbose('Removing animation class', module.cache);
            }
            module.remove.duration();
          }
        },

        add: {
          failSafe: function failSafe() {
            var duration = module.get.duration();
            module.timer = setTimeout(function () {
              $module.triggerHandler(animationEnd);
            }, duration + settings.failSafeDelay);
            module.verbose('Adding fail safe timer', module.timer);
          }
        },

        remove: {
          animating: function animating() {
            $module.removeClass(className.animating);
          },
          animationCallbacks: function animationCallbacks() {
            module.remove.queueCallback();
            module.remove.completeCallback();
          },
          queueCallback: function queueCallback() {
            $module.off('.queue' + eventNamespace);
          },
          completeCallback: function completeCallback() {
            $module.off('.complete' + eventNamespace);
          },
          display: function display() {
            $module.css('display', '');
          },
          direction: function direction() {
            $module.removeClass(className.inward).removeClass(className.outward);
          },
          duration: function duration() {
            $module.css('animation-duration', '');
          },
          failSafe: function failSafe() {
            module.verbose('Removing fail safe timer', module.timer);
            if (module.timer) {
              clearTimeout(module.timer);
            }
          },
          hidden: function hidden() {
            $module.removeClass(className.hidden);
          },
          visible: function visible() {
            $module.removeClass(className.visible);
          },
          looping: function looping() {
            module.debug('Transitions are no longer looping');
            if (module.is.looping()) {
              module.reset();
              $module.removeClass(className.looping);
            }
          },
          transition: function transition() {
            $module.removeClass(className.visible).removeClass(className.hidden);
          }
        },
        get: {
          settings: function settings(animation, duration, onComplete) {
            // single settings object
            if ((typeof animation === "undefined" ? "undefined" : _typeof(animation)) == 'object') {
              return $.extend(true, {}, $.fn.transition.settings, animation);
            }
            // all arguments provided
            else if (typeof onComplete == 'function') {
                return $.extend({}, $.fn.transition.settings, {
                  animation: animation,
                  onComplete: onComplete,
                  duration: duration
                });
              }
              // only duration provided
              else if (typeof duration == 'string' || typeof duration == 'number') {
                  return $.extend({}, $.fn.transition.settings, {
                    animation: animation,
                    duration: duration
                  });
                }
                // duration is actually settings object
                else if ((typeof duration === "undefined" ? "undefined" : _typeof(duration)) == 'object') {
                    return $.extend({}, $.fn.transition.settings, duration, {
                      animation: animation
                    });
                  }
                  // duration is actually callback
                  else if (typeof duration == 'function') {
                      return $.extend({}, $.fn.transition.settings, {
                        animation: animation,
                        onComplete: duration
                      });
                    }
                    // only animation provided
                    else {
                        return $.extend({}, $.fn.transition.settings, {
                          animation: animation
                        });
                      }
          },
          animationClass: function animationClass(animation) {
            var animationClass = animation || settings.animation,
                directionClass = module.can.transition() && !module.has.direction() ? module.get.direction() + ' ' : '';
            return className.animating + ' ' + className.transition + ' ' + directionClass + animationClass;
          },
          currentAnimation: function currentAnimation() {
            return module.cache && module.cache.animation !== undefined ? module.cache.animation : false;
          },
          currentDirection: function currentDirection() {
            return module.is.inward() ? className.inward : className.outward;
          },
          direction: function direction() {
            return module.is.hidden() || !module.is.visible() ? className.inward : className.outward;
          },
          animationDirection: function animationDirection(animation) {
            var direction;
            animation = animation || settings.animation;
            if (typeof animation === 'string') {
              animation = animation.split(' ');
              // search animation name for out/in class
              $.each(animation, function (index, word) {
                if (word === className.inward) {
                  direction = className.inward;
                } else if (word === className.outward) {
                  direction = className.outward;
                }
              });
            }
            // return found direction
            if (direction) {
              return direction;
            }
            return false;
          },
          duration: function duration(_duration2) {
            _duration2 = _duration2 || settings.duration;
            if (_duration2 === false) {
              _duration2 = $module.css('animation-duration') || 0;
            }
            return typeof _duration2 === 'string' ? _duration2.indexOf('ms') > -1 ? parseFloat(_duration2) : parseFloat(_duration2) * 1000 : _duration2;
          },
          displayType: function displayType(shouldDetermine) {
            shouldDetermine = shouldDetermine !== undefined ? shouldDetermine : true;
            if (settings.displayType) {
              return settings.displayType;
            }
            if (shouldDetermine && $module.data(metadata.displayType) === undefined) {
              // create fake element to determine display state
              module.can.transition(true);
            }
            return $module.data(metadata.displayType);
          },
          userStyle: function userStyle(style) {
            style = style || $module.attr('style') || '';
            return style.replace(/display.*?;/, '');
          },
          transitionExists: function transitionExists(animation) {
            return $.fn.transition.exists[animation];
          },
          animationStartEvent: function animationStartEvent() {
            var element = document.createElement('div'),
                animations = {
              'animation': 'animationstart',
              'OAnimation': 'oAnimationStart',
              'MozAnimation': 'mozAnimationStart',
              'WebkitAnimation': 'webkitAnimationStart'
            },
                animation;
            for (animation in animations) {
              if (element.style[animation] !== undefined) {
                return animations[animation];
              }
            }
            return false;
          },
          animationEndEvent: function animationEndEvent() {
            var element = document.createElement('div'),
                animations = {
              'animation': 'animationend',
              'OAnimation': 'oAnimationEnd',
              'MozAnimation': 'mozAnimationEnd',
              'WebkitAnimation': 'webkitAnimationEnd'
            },
                animation;
            for (animation in animations) {
              if (element.style[animation] !== undefined) {
                return animations[animation];
              }
            }
            return false;
          }

        },

        can: {
          transition: function transition(forced) {
            var animation = settings.animation,
                transitionExists = module.get.transitionExists(animation),
                displayType = module.get.displayType(false),
                elementClass,
                tagName,
                $clone,
                currentAnimation,
                inAnimation,
                directionExists;
            if (transitionExists === undefined || forced) {
              module.verbose('Determining whether animation exists');
              elementClass = $module.attr('class');
              tagName = $module.prop('tagName');

              $clone = $('<' + tagName + ' />').addClass(elementClass).insertAfter($module);
              currentAnimation = $clone.addClass(animation).removeClass(className.inward).removeClass(className.outward).addClass(className.animating).addClass(className.transition).css('animationName');
              inAnimation = $clone.addClass(className.inward).css('animationName');
              if (!displayType) {
                displayType = $clone.attr('class', elementClass).removeAttr('style').removeClass(className.hidden).removeClass(className.visible).show().css('display');
                module.verbose('Determining final display state', displayType);
                module.save.displayType(displayType);
              }

              $clone.remove();
              if (currentAnimation != inAnimation) {
                module.debug('Direction exists for animation', animation);
                directionExists = true;
              } else if (currentAnimation == 'none' || !currentAnimation) {
                module.debug('No animation defined in css', animation);
                return;
              } else {
                module.debug('Static animation found', animation, displayType);
                directionExists = false;
              }
              module.save.transitionExists(animation, directionExists);
            }
            return transitionExists !== undefined ? transitionExists : directionExists;
          },
          animate: function animate() {
            // can transition does not return a value if animation does not exist
            return module.can.transition() !== undefined;
          }
        },

        is: {
          animating: function animating() {
            return $module.hasClass(className.animating);
          },
          inward: function inward() {
            return $module.hasClass(className.inward);
          },
          outward: function outward() {
            return $module.hasClass(className.outward);
          },
          looping: function looping() {
            return $module.hasClass(className.looping);
          },
          occurring: function occurring(animation) {
            animation = animation || settings.animation;
            animation = '.' + animation.replace(' ', '.');
            return $module.filter(animation).length > 0;
          },
          visible: function visible() {
            return $module.is(':visible');
          },
          hidden: function hidden() {
            return $module.css('visibility') === 'hidden';
          },
          supported: function supported() {
            return animationEnd !== false;
          }
        },

        hide: function hide() {
          module.verbose('Hiding element');
          if (module.is.animating()) {
            module.reset();
          }
          element.blur(); // IE will trigger focus change if element is not blurred before hiding
          module.remove.display();
          module.remove.visible();
          module.set.hidden();
          module.force.hidden();
          settings.onHide.call(element);
          settings.onComplete.call(element);
          // module.repaint();
        },

        show: function show(display) {
          module.verbose('Showing element', display);
          module.remove.hidden();
          module.set.visible();
          module.force.visible();
          settings.onShow.call(element);
          settings.onComplete.call(element);
          // module.repaint();
        },

        toggle: function toggle() {
          if (module.is.visible()) {
            module.hide();
          } else {
            module.show();
          }
        },

        stop: function stop() {
          module.debug('Stopping current animation');
          $module.triggerHandler(animationEnd);
        },

        stopAll: function stopAll() {
          module.debug('Stopping all animation');
          module.remove.queueCallback();
          $module.triggerHandler(animationEnd);
        },

        clear: {
          queue: function queue() {
            module.debug('Clearing animation queue');
            module.remove.queueCallback();
          }
        },

        enable: function enable() {
          module.verbose('Starting animation');
          $module.removeClass(className.disabled);
        },

        disable: function disable() {
          module.debug('Stopping animation');
          $module.addClass(className.disabled);
        },

        setting: function setting(name, value) {
          module.debug('Changing setting', name, value);
          if ($.isPlainObject(name)) {
            $.extend(true, settings, name);
          } else if (value !== undefined) {
            if ($.isPlainObject(settings[name])) {
              $.extend(true, settings[name], value);
            } else {
              settings[name] = value;
            }
          } else {
            return settings[name];
          }
        },
        internal: function internal(name, value) {
          if ($.isPlainObject(name)) {
            $.extend(true, module, name);
          } else if (value !== undefined) {
            module[name] = value;
          } else {
            return module[name];
          }
        },
        debug: function debug() {
          if (!settings.silent && settings.debug) {
            if (settings.performance) {
              module.performance.log(arguments);
            } else {
              module.debug = Function.prototype.bind.call(console.info, console, settings.name + ':');
              module.debug.apply(console, arguments);
            }
          }
        },
        verbose: function verbose() {
          if (!settings.silent && settings.verbose && settings.debug) {
            if (settings.performance) {
              module.performance.log(arguments);
            } else {
              module.verbose = Function.prototype.bind.call(console.info, console, settings.name + ':');
              module.verbose.apply(console, arguments);
            }
          }
        },
        error: function error() {
          if (!settings.silent) {
            module.error = Function.prototype.bind.call(console.error, console, settings.name + ':');
            module.error.apply(console, arguments);
          }
        },
        performance: {
          log: function log(message) {
            var currentTime, executionTime, previousTime;
            if (settings.performance) {
              currentTime = new Date().getTime();
              previousTime = time || currentTime;
              executionTime = currentTime - previousTime;
              time = currentTime;
              performance.push({
                'Name': message[0],
                'Arguments': [].slice.call(message, 1) || '',
                'Element': element,
                'Execution Time': executionTime
              });
            }
            clearTimeout(module.performance.timer);
            module.performance.timer = setTimeout(module.performance.display, 500);
          },
          display: function display() {
            var title = settings.name + ':',
                totalTime = 0;
            time = false;
            clearTimeout(module.performance.timer);
            $.each(performance, function (index, data) {
              totalTime += data['Execution Time'];
            });
            title += ' ' + totalTime + 'ms';
            if (moduleSelector) {
              title += ' \'' + moduleSelector + '\'';
            }
            if ($allModules.length > 1) {
              title += ' ' + '(' + $allModules.length + ')';
            }
            if ((console.group !== undefined || console.table !== undefined) && performance.length > 0) {
              console.groupCollapsed(title);
              if (console.table) {
                console.table(performance);
              } else {
                $.each(performance, function (index, data) {
                  console.log(data['Name'] + ': ' + data['Execution Time'] + 'ms');
                });
              }
              console.groupEnd();
            }
            performance = [];
          }
        },
        // modified for transition to return invoke success
        invoke: function invoke(query, passedArguments, context) {
          var object = instance,
              maxDepth,
              found,
              response;
          passedArguments = passedArguments || queryArguments;
          context = element || context;
          if (typeof query == 'string' && object !== undefined) {
            query = query.split(/[\. ]/);
            maxDepth = query.length - 1;
            $.each(query, function (depth, value) {
              var camelCaseValue = depth != maxDepth ? value + query[depth + 1].charAt(0).toUpperCase() + query[depth + 1].slice(1) : query;
              if ($.isPlainObject(object[camelCaseValue]) && depth != maxDepth) {
                object = object[camelCaseValue];
              } else if (object[camelCaseValue] !== undefined) {
                found = object[camelCaseValue];
                return false;
              } else if ($.isPlainObject(object[value]) && depth != maxDepth) {
                object = object[value];
              } else if (object[value] !== undefined) {
                found = object[value];
                return false;
              } else {
                return false;
              }
            });
          }
          if ($.isFunction(found)) {
            response = found.apply(context, passedArguments);
          } else if (found !== undefined) {
            response = found;
          }

          if ($.isArray(returnedValue)) {
            returnedValue.push(response);
          } else if (returnedValue !== undefined) {
            returnedValue = [returnedValue, response];
          } else if (response !== undefined) {
            returnedValue = response;
          }
          return found !== undefined ? found : false;
        }
      };
      module.initialize();
    });
    return returnedValue !== undefined ? returnedValue : this;
  };

  // Records if CSS transition is available
  $.fn.transition.exists = {};

  $.fn.transition.settings = {

    // module info
    name: 'Transition',

    // hide all output from this component regardless of other settings
    silent: false,

    // debug content outputted to console
    debug: false,

    // verbose debug output
    verbose: false,

    // performance data output
    performance: true,

    // event namespace
    namespace: 'transition',

    // delay between animations in group
    interval: 0,

    // whether group animations should be reversed
    reverse: 'auto',

    // animation callback event
    onStart: function onStart() {},
    onComplete: function onComplete() {},
    onShow: function onShow() {},
    onHide: function onHide() {},

    // whether timeout should be used to ensure callback fires in cases animationend does not
    useFailSafe: true,

    // delay in ms for fail safe
    failSafeDelay: 100,

    // whether EXACT animation can occur twice in a row
    allowRepeats: false,

    // Override final display type on visible
    displayType: false,

    // animation duration
    animation: 'fade',
    duration: false,

    // new animations will occur after previous ones
    queue: true,

    metadata: {
      displayType: 'display'
    },

    className: {
      animating: 'animating',
      disabled: 'disabled',
      hidden: 'hidden',
      inward: 'in',
      loading: 'loading',
      looping: 'looping',
      outward: 'out',
      transition: 'transition',
      visible: 'visible'
    },

    // possible errors
    error: {
      noAnimation: 'Element is no longer attached to DOM. Unable to animate.  Use silent setting to surpress this warning in production.',
      repeated: 'That animation is already occurring, cancelling repeated animation',
      method: 'The method you called is not defined',
      support: 'This browser does not support CSS animations'
    }

  };
})(jQuery, window, document);